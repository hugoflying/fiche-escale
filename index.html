<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Fiche Escale Interactive</title>
  <style>
    @media print {
      button,
      [type="radio"],
      label[for] {
        display: none !important;
      }
      div[style*="position: absolute"] {
        display: none !important;
      }
    }
    body {
      font-family: sans-serif;
      padding: 10px;
      margin: auto;
      width: 100%;
      max-width: 100%;
    }
    section {
      margin-bottom: 30px;
    }
    h3 {
      background: #000;
      color: #fff;
      padding: 10px;
      margin: 0 -10px 15px;
      text-align: center;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }
    .field {
      flex: 1 1 120px;
      display: flex;
      flex-direction: column;
    }
    .field label {
      font-weight: bold;
      margin-bottom: 3px;
      font-size: 0.9em;
    }
    .field input,
    .field select,
    .field textarea {
      padding: 4px;
      font-size: 0.9em;
    }
    textarea {
      height: 150px;
      width: 100%;
    }
    .now-btn {
      margin-top: 4px;
      padding: 3px 5px;
      font-size: 0.75em;
      width: 100%;
    }
    input, textarea {
      text-transform: uppercase;
    }
    input[readonly] {
      background-color: #eee;
      color: #555;
      font-style: italic;
      border: 1px dashed #aaa;
    }
    @media (max-width: 850px) {
      .row {
        flex-direction: column;
      }
      .field {
        flex: 1 1 100%;
      }
    }
    .input-now {
      display: flex;
      gap: 5px;
    }
    .input-now input {
      flex: 1;
    }
    .input-now button {
      width: 100px;
    }
    @media (max-width: 850px) {
      .row {
        flex-direction: column;
      }
      .field {
        flex: 1 1 100%;
      }
      .input-now {
        flex-direction: column;
      }
      .input-now button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Le contenu HTML reste inchéngé -->

<script>
function setTimeMode(mode) {
  window.timeMode = mode;
}

function setNow(id) {
  const now = new Date();
  const mode = window.timeMode || 'local';
  const hh = (mode === 'utc' ? now.getUTCHours() : now.getHours()).toString().padStart(2, '0');
  const mm = (mode === 'utc' ? now.getUTCMinutes() : now.getMinutes()).toString().padStart(2, '0');
  document.getElementById(id).value = `${hh}:${mm}`;
}

function setNowToPrevious(btn) {
  const input = btn.previousElementSibling;
  if (!input || input.tagName.toLowerCase() !== 'input') return;
  const now = new Date();
  const mode = window.timeMode || 'local';
  const hh = (mode === 'utc' ? now.getUTCHours() : now.getHours()).toString().padStart(2, '0');
  const mm = (mode === 'utc' ? now.getUTCMinutes() : now.getMinutes()).toString().padStart(2, '0');
  input.value = `${hh}:${mm}`;
}

function calculateTimeOffset(baseId, targetId, offsetMinutes) {
  const base = document.getElementById(baseId);
  const target = document.getElementById(targetId);
  if (!base || !target || !base.value) return;
  const [h, m] = base.value.split(":" ).map(Number);
  const baseDate = new Date();
  baseDate.setHours(h);
  baseDate.setMinutes(m);
  baseDate.setMinutes(baseDate.getMinutes() + offsetMinutes);
  const hh = baseDate.getHours().toString().padStart(2, '0');
  const mm = baseDate.getMinutes().toString().padStart(2, '0');
  target.value = `${hh}:${mm}`;
}

function renderAssistances() {
  const container = document.getElementById('assistancesContainer');
  const count = parseInt(document.getElementById('assistanceCount').value || '0');
  container.innerHTML = '';
  for (let i = 0; i < count; i++) {
    const wrapper = document.createElement('div');
    wrapper.className = 'field';
    const typeId = `assistance-type-${i}`;
    const customId = `custom-code-${i}`;
    wrapper.innerHTML = `
      <label>Assistance ${i + 1}</label>
      <select id="${typeId}" onchange="toggleCustomCode('${typeId}', '${customId}')">
        <option>-</option>
        <option>WCHR</option>
        <option>WCHS</option>
        <option>WCHC</option>
        <option>DEAF</option>
        <option>MUTE</option>
        <option>DPNA</option>
        <option>Autre</option>
      </select>
      <div id="${customId}" style="display:none">
        <label>Code personnalisé</label>
        <input type="text" placeholder="Saisir le type">
      </div>
      <label>Équipement ${i + 1}</label>
      <select>
        <option>-</option>
        <option>WCMP</option>
        <option>WCLB</option>
        <option>WCBD</option>
      </select>
      <label>Siège ${i + 1}</label>
      <input type="text" placeholder="ex: 12A">
    `;
    container.appendChild(wrapper);
  }
}

function toggleCustomCode(selectId, divId) {
  const selected = document.getElementById(selectId).value;
  const target = document.getElementById(divId);
  target.style.display = selected === 'Autre' ? 'block' : 'none';
}

function saveForm() {
  const fields = document.querySelectorAll('input, select, textarea');
  const data = {};
  fields.forEach(field => {
    if (field.id) {
      if (field.type === 'checkbox') {
        data[field.id] = field.checked;
      } else {
        data[field.id] = field.value;
      }
    }
  });
  localStorage.setItem('ficheEscaleData', JSON.stringify(data));
}

function loadForm() {
  const data = JSON.parse(localStorage.getItem('ficheEscaleData'));
  if (!data) return;
  const fields = document.querySelectorAll('input, select, textarea');
  fields.forEach(field => {
    if (field.id && data[field.id] !== undefined) {
      if (field.type === 'checkbox') {
        field.checked = data[field.id];
      } else {
        field.value = data[field.id];
      }
    }
  });
}

function renderExtraSeatTypes() {
  const count = parseInt(document.querySelector('input[id="extraSeat"]')?.value || '0');
  const container = document.getElementById('extraSeatTypes');
  container.innerHTML = '';
  for (let i = 0; i < count; i++) {
    const wrapper = document.createElement('div');
    wrapper.className = 'field';
    wrapper.innerHTML = `
      <label>Extra seat ${i + 1} - Type</label>
      <select>
        <option value="M">M</option>
        <option value="X">X</option>
      </select>
      <label>Extra seat ${i + 1} - Siège</label>
      <input type="text" placeholder="ex: 12A">
    `;
    container.appendChild(wrapper);
  }
}

function clearForm() {
  localStorage.removeItem('ficheEscaleData');
  const fields = document.querySelectorAll('input, select, textarea');
  fields.forEach(field => {
    if (field.type === 'checkbox') {
      field.checked = false;
    } else {
      field.value = '';
    }
  });
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById("sobt").addEventListener("change", () => {
    calculateTimeOffset("sobt", "hle", -40);
    calculateTimeOffset("sobt", "h15", -15);
  });

  const extraSeatInput = document.getElementById('extraSeat');
  if (extraSeatInput) {
    extraSeatInput.addEventListener('change', renderExtraSeatTypes);
  }

  const assistanceInput = document.getElementById('assistanceCount');
  if (assistanceInput) {
    assistanceInput.addEventListener('change', renderAssistances);
  }

  loadForm();

  const fields = document.querySelectorAll('input, select, textarea');
  fields.forEach(field => {
    field.addEventListener('input', saveForm);
    field.addEventListener('change', saveForm);
  });
});
</script>
</body>
</html>
