<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SUIVI PERFORMANCE MULTI-VOLS</title>
<style>
/* RESET & BASE */
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
    font-family: Arial, sans-serif;
    background: #f8f9fa;
    color: #222;
    padding: 10px;
}
body.dark { background: #121212; color: #f8f9fa; }
h1 { text-align: center; margin: 10px 0 15px; }

/* ONGLET BAR */
.tab-bar {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    justify-content: flex-start;
}
.tab-bar button {
    padding: 6px 12px;
    border-radius: 6px;
    border: 1px solid #888;
    background: #ddd;
    cursor: pointer;
}
.tab-bar button.active {
    background: #1976d2;
    color: #fff;
    font-weight: bold;
}
.tab-bar button#add-tab {
    background: #4caf50;
    color: #fff;
    font-weight: bold;
}

/* SECTIONS */
section {
    background: #fff;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 15px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}
body.dark section { background: #1e1e1e; }
h2 {
    font-size: 1.2rem;
    margin-bottom: 10px;
    border-bottom: 1px solid #ccc;
    padding-bottom: 5px;
    text-align: center;
    text-transform: uppercase;
}

/* GRILLES */
.form-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
.form-group { flex: 1 1 calc(50% - 10px); min-width: 150px; margin-bottom: 10px; text-align:center; }
.form-group-3col { flex: 1 1 calc(33.33% - 10px); min-width: 120px; margin-bottom: 10px; text-align:center; }
.form-group-4col { flex: 1 1 calc(25% - 10px); min-width: 80px; margin-bottom: 10px; text-align:center; }

/* LABELS */
.form-group label,
.form-group-3col label,
.form-group-4col label {
    font-size: 0.9rem;
    font-weight: bold;
    display: block;
    margin-bottom: 3px;
    text-align: center;
}

/* CHAMPS */
input, select {
    width: 100%;
    padding: 6px;
    font-size: 0.95rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    text-align: center;
}
textarea {
    width: 100%;
    padding: 6px;
    font-size: 0.95rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    resize: both;
    min-height: 60px;
    text-align: left;
    overflow: auto;
}

/* Champ horaire + boutons align√©s */
.form-group input[type="time"] {
    width: 100%;
    box-sizing: border-box;
    text-align: center;
    display: block;
}
.btn-actions {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    width: 100%;
    gap: 5px;
    margin-top: 5px;
}
button.action {
    width: 100%;
    padding: 10px;
    font-size: 0.95rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}
button.minus { background: #555; color: white; }
button.now   { background: #1976d2; color: white; }
button.plus  { background: #555; color: white; }

/* Boutons principaux */
#validate, .save-btn, #reset {
    width: 100%;
    padding: 12px;
    font-size: 1.2rem;
    border: none;
    border-radius: 6px;
    margin-top: 10px;
    cursor: pointer;
}
#validate { background: #4caf50; color: white; }
.save-btn { background: #2196f3; color: white; margin: 15px 0; }
#reset { background: #d32f2f; color: white; }

/* Timers */
.timer-box {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}
.timer {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}
.timer-label { font-weight: bold; font-size: 1rem; }
.timer-value {
    background: #d32f2f;
    color: #fff;
    font-weight: bold;
    padding: 10px 20px;
    border-radius: 6px;
    font-size: 1.1rem;
}
#timer-tobt { background: #2e7d32; }
#timer-h8 { background: orange; }

/* Toggles */
.toggle-container {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
}
.toggle-container button {
    padding: 5px 10px;
    font-size: 0.9rem;
}

/* Majuscules INFO VOL */
#Date, #Cie, #NVol, #From, #To, #Immat, #RZA, #Parking, #FNC {
    text-transform: uppercase;
}
</style>
</head>
<body onload="initTabs()">

<!-- === BARRE ONGLET + BOUTON + === -->
<div class="tab-bar" id="tab-bar">
    <button class="active" onclick="switchTab(1)" id="tab-btn-1">VOL 1</button>
    <button id="add-tab" onclick="addTab()">+</button>
</div>

<!-- Modes -->
<div class="toggle-container">
    <button onclick="toggleDarkMode()">üåô / ‚òÄÔ∏è</button>
    <button onclick="toggleTimeMode()">Local / UTC</button>
</div>

<h1>SUIVI PERFORMANCE</h1>

<!-- CONTAINER TABS -->
<div id="tab-contents"></div>

<script>
/* ========= VARIABLES ========= */
let currentTab = 1;
let maxTabs = 3;
let tabCount = 1;
let isUTC = false;
let manualSOBT = {};

/* ========= INIT ONGLET ========= */
function initTabs() {
    createTabContent(1);
    loadTabData(1);
}

/* ========= AJOUTER ONGLET ========= */
function addTab() {
    if (tabCount >= maxTabs) return alert("Maximum 3 vols !");
    tabCount++;
    createTabButton(tabCount);
    createTabContent(tabCount);
    switchTab(tabCount);
    loadTabData(tabCount);
}

/* ========= CREER BOUTON ONGLET ========= */
function createTabButton(num) {
    const btn = document.createElement("button");
    btn.id = `tab-btn-${num}`;
    btn.innerText = `VOL ${num}`;
    btn.onclick = () => switchTab(num);
    document.getElementById("tab-bar").insertBefore(btn, document.getElementById("add-tab"));
}

/* ========= CREER CONTENU ONGLET ========= */
function createTabContent(num) {
    const container = document.createElement("div");
    container.id = `tab-${num}`;
    container.style.display = num === 1 ? "block" : "none";
    container.innerHTML = generateFormHTML(num);
    document.getElementById("tab-contents").appendChild(container);
    initForm(num);
}

/* ========= SWITCH ONGLET ========= */
function switchTab(num) {
    document.querySelectorAll('[id^="tab-"]').forEach(div => div.style.display = 'none');
    document.querySelectorAll('[id^="tab-btn-"]').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`tab-${num}`).style.display = 'block';
    document.getElementById(`tab-btn-${num}`).classList.add('active');
    currentTab = num;
    loadTabData(num);
}

/* ========= RENAME ONGLET ========= */
function renameTab(num) {
    const dest = document.getElementById(`To-${num}`).value;
    const park = document.getElementById(`Parking-${num}`).value;
    const btn = document.getElementById(`tab-btn-${num}`);
    btn.textContent = (dest && park) ? `${dest}_${park}` : `VOL ${num}`;
}

/* ========= GENERATE FORM HTML ========= */
function generateFormHTML(num) {
    return `
    <!-- Timers -->
    <div class="timer-box">
        <div class="timer"><div class="timer-label">H-40</div><div id="timer-h40-${num}" class="timer-value">--:--</div></div>
        <div class="timer"><div class="timer-label">H-15</div><div id="timer-h15-${num}" class="timer-value">--:--</div></div>
        <div class="timer"><div class="timer-label">LID</div><div id="timer-h8-${num}" class="timer-value">--:--</div></div>
        <div class="timer"><div class="timer-label">TOBT</div><div id="timer-tobt-${num}" class="timer-value">--:--</div></div>
    </div>

    <!-- INFO VOL -->
    <section>
        <h2>INFO VOL</h2>
        <div class="form-grid">
            <div class="form-group" style="flex:1 1 100%;"><label>Date<input type="date" id="Date-${num}"></label></div>
            <div class="form-group"><label>Cie
                <select id="Cie-${num}" onchange="updateAllCalculations(${num})">
                    <option value="">--</option>
                    <option>FR</option><option>RK</option><option>W4</option><option>W6</option>
                    <option>H4</option><option>H6</option><option>U5</option><option>U7</option>
                    <option>V7</option><option>Autre</option>
                </select>
            </label></div>
            <div class="form-group"><label>N¬∞ Vol<input type="text" id="NVol-${num}"></label></div>

            <div class="form-group"><label>Provenance<input type="text" id="From-${num}" maxlength="3"></label></div>
            <div class="form-group"><label>Destination<input type="text" id="To-${num}" maxlength="3" oninput="renameTab(${num})"></label></div>

            <div class="form-group"><label>Immat<input type="text" id="Immat-${num}" maxlength="5"></label></div>
            <div class="form-group"><label>Parking
                <select id="Parking-${num}" onchange="renameTab(${num})">
                    <option value="">--</option>
                    <option>1</option><option>2</option><option>3</option><option>4</option>
                    <option>5</option><option>6</option><option>7</option><option>8</option>
                    <option>9</option><option>10</option><option>11</option><option>12</option>
                </select>
            </label></div>

            <div class="form-group"><label>RZA<input type="text" id="RZA-${num}" maxlength="3"></label></div>
            <div class="form-group"><label>FNC
                <select id="FNC-${num}">
                    <option>Y</option><option selected>N</option>
                </select>
            </label></div>
        </div>
    </section>

    <!-- HORAIRES -->
    <section>
        <h2>HORAIRES</h2>
        <div class="form-grid">
            ${generateTimeField("SIBT", num)}
            ${generateTimeField("AIBT", num)}
            ${generateTimeField("SOBT", num, true)}
            ${generateTimeField("AOBT", num)}
        </div>
    </section>

    <button class="save-btn" onclick="manualSave(${num})">SAUVEGARDER</button>

    <!-- TIMING -->
    <section>
        <h2>TIMING</h2>
        <div class="form-grid" id="timing-grid-${num}"></div>
    </section>

    <button class="save-btn" onclick="manualSave(${num})">SAUVEGARDER</button>

    <!-- RETARDS -->
    <section>
        <h2>RETARDS (D√âPART)</h2>
        <div class="form-grid">
            <div class="form-group"><label>DL Code 1<input type="text" id="DLcode1-${num}"></label></div>
            <div class="form-group"><label>DL Dur√©e 1 (min)<input type="number" id="DLduree1-${num}"></label></div>
            <div class="form-group"><label>DL Code 2<input type="text" id="DLcode2-${num}"></label></div>
            <div class="form-group"><label>DL Dur√©e 2 (min)<input type="number" id="DLduree2-${num}"></label></div>
            <div class="form-group"><label>DL Code 3<input type="text" id="DLcode3-${num}"></label></div>
            <div class="form-group"><label>DL Dur√©e 3 (min)<input type="number" id="DLduree3-${num}"></label></div>
        </div>
    </section>

    <!-- DL JUSTIFICATIONS -->
    <section>
        <h2>DL JUSTIFICATIONS</h2>
        <textarea id="DLJustif-${num}"></textarea>
    </section>

    <!-- FAITS SAILLANTS -->
    <section>
        <h2>FAITS SAILLANTS</h2>
        <textarea id="FaitsSaillants-${num}"></textarea>
    </section>

    <!-- ASSISTANCES PRISES EN CHARGE A/D -->
    <section>
        <h2>ASSISTANCES PRISES EN CHARGE A/D</h2>
        <div class="form-grid">
            <div class="form-group-4col"><label>WCHC<input type="number" id="WCHC-${num}"></label></div>
            <div class="form-group-4col"><label>WCHS<input type="number" id="WCHS-${num}"></label></div>
            <div class="form-group-4col"><label>WCHR<input type="number" id="WCHR-${num}"></label></div>
            <div class="form-group-4col"><label>Autre<input type="number" id="AutreAssist-${num}"></label></div>
        </div>
    </section>

    <!-- PRESTATIONS -->
    <section>
        <h2>PRESTATIONS</h2>
        <div class="form-grid">
            <div class="form-group-3col"><label>ASU<select id="ASU-${num}"><option>N</option><option>Y</option></select></label></div>
            <div class="form-group-3col"><label>Flux RZA<select id="FluxRZA-${num}"><option>N</option><option>Y</option></select></label></div>
            <div class="form-group-3col"><label>Eau potable<select id="EauPotable-${num}"><option>N</option><option>Y</option></select></label></div>
            <div class="form-group-3col"><label>Vidange toilettes<select id="Vidange-${num}"><option>N</option><option>Y</option></select></label></div>
            <div class="form-group-3col"><label>M√©nage Assist'Air<select id="MenageAssist-${num}"><option>N</option><option>Y</option></select></label></div>
            <div class="form-group-3col"><label>M√©nage Atalian<select id="MenageAtalian-${num}"><option>N</option><option>T</option><option>F</option></select></label></div>
            <div class="form-group-3col"><label>Collecte d'ordures<select id="Ordures-${num}"><option>Y</option><option>N</option></select></label></div>
            <div class="form-group-3col"><label>Toilet Kit<select id="ToiletKit-${num}"><option>N</option><option>Y</option></select></label></div>
            <div class="form-group-3col"><label>D√©givrage<select id="Degivrage-${num}"><option>N</option><option>Y</option></select></label></div>
            <div class="form-group-3col"><label>Push-Pull<select id="PushPull-${num}"><option>N</option><option>Y</option></select></label></div>
            <div class="form-group-3col"><label>Echelle suppl√©mentaire<select id="Echelle-${num}"><option>N</option><option>Y</option></select></label></div>
        </div>
    </section>

    <!-- Boutons finaux -->
    <button id="validate" onclick="validateForm(${num})">VALIDER</button>
    <button class="save-btn" onclick="manualSave(${num})">SAUVEGARDER</button>
    <button id="reset" onclick="clearAutoSave(${num})">R√âINITIALISER</button>
    `;
}

/* G√©n√®re champ horaire avec boutons */
function generateTimeField(name, num, sobt=false) {
    return `
    <div class="form-group">
        <label>${name}<input type="time" id="${name}-${num}" ${sobt ? 'onchange="manualSOBT['+num+']=true;updateAllCalculations('+num+')"' : 'onchange="updateAllCalculations('+num+')"'}>
        </label>
        <div class="btn-actions">
            <button class="action minus" onclick="adjustTime('${name}-${num}',-1);updateAllCalculations(${num})">-1</button>
            <button class="action now" onclick="setNow('${name}-${num}');updateAllCalculations(${num})">Now</button>
            <button class="action plus" onclick="adjustTime('${name}-${num}',1);updateAllCalculations(${num})">+1</button>
        </div>
    </div>`;
}

/* === INITIALISATION FORMULAIRE === */
function initForm(num) {
    document.getElementById(`Date-${num}`).valueAsDate = new Date();
    generateTimingFields(num);
    restoreSettings(num);
    enableAutoSave(num);
    setInterval(() => { updateAllCalculations(num); manualSaveTimers(num); }, 60000);
}

/* === GENERATION CHAMPS TIMING === */
function generateTimingFields(num) {
    const timings = [
        "ArrPNT","ArrPNC","PremierDebarque","DernierDebarque",
        "AvionPremierEmbarque","AvionDernierEmbarque",
        "PortePremierEmbarque","PorteDernierEmbarque",
        "ArriveeFuel","DepartFuel",
        "ArriveeLift","DepartLift",
        "FermeturePorteAvion"
    ];
    const labels = [
        "Arriv√©e PNT avion","Arriv√©e PNC avion","Premier d√©barqu√©","Dernier d√©barqu√©",
        "Avion : Premier embarqu√©","Avion : Dernier embarqu√©",
        "Porte : Premier embarqu√©","Porte : Dernier embarqu√©",
        "Arriv√©e Fuel","D√©part Fuel",
        "Arriv√©e Lift","D√©part Lift",
        "Fermeture porte avion"
    ];
    const container = document.getElementById(`timing-grid-${num}`);
    container.innerHTML = "";
    timings.forEach((id,i)=>{
        const div = document.createElement('div');
        div.className = 'form-group';
        div.innerHTML = `
            <label>${labels[i]}<input type="time" id="${id}-${num}" onchange="updateAllCalculations(${num})"></label>
            <div class="btn-actions">
                <button class="action minus" onclick="adjustTime('${id}-${num}',-1);updateAllCalculations(${num})">-1</button>
                <button class="action now" onclick="setNow('${id}-${num}');updateAllCalculations(${num})">Now</button>
                <button class="action plus" onclick="adjustTime('${id}-${num}',1);updateAllCalculations(${num})">+1</button>
            </div>
        `;
        container.appendChild(div);
    });
}

/* === SAUVEGARDE AUTO & RESTAURATION === */
function enableAutoSave(num) {
    const fields = document.querySelectorAll(`#tab-${num} input, #tab-${num} select, #tab-${num} textarea`);
    fields.forEach(field => {
        const savedValue = localStorage.getItem(`vol${num}_${field.id}`);
        if (savedValue !== null) field.value = savedValue;

        field.addEventListener('input', () => localStorage.setItem(`vol${num}_${field.id}`, field.value));
        field.addEventListener('change', () => localStorage.setItem(`vol${num}_${field.id}`, field.value));
    });
}

/* Sauvegarde manuelle */
function manualSave(num) {
    const fields = document.querySelectorAll(`#tab-${num} input, #tab-${num} select, #tab-${num} textarea`);
    fields.forEach(field => localStorage.setItem(`vol${num}_${field.id}`, field.value));
    localStorage.setItem('modeDark', document.body.classList.contains('dark') ? '1' : '0');
    localStorage.setItem('modeUTC', isUTC ? '1' : '0');
    manualSaveTimers(num);
    alert("Donn√©es sauvegard√©es !");
}

/* Sauvegarde timers */
function manualSaveTimers(num) {
    localStorage.setItem(`vol${num}_timer-h40`, document.getElementById(`timer-h40-${num}`).textContent);
    localStorage.setItem(`vol${num}_timer-h15`, document.getElementById(`timer-h15-${num}`).textContent);
    localStorage.setItem(`vol${num}_timer-h8`, document.getElementById(`timer-h8-${num}`).textContent);
    localStorage.setItem(`vol${num}_timer-tobt`, document.getElementById(`timer-tobt-${num}`).textContent);
}

/* Restaurer param√®tres & timers */
function restoreSettings(num) {
    if (localStorage.getItem('modeDark') === '1') document.body.classList.add('dark');
    if (localStorage.getItem('modeUTC') === '1') isUTC = true;

    if (localStorage.getItem(`vol${num}_timer-h40`)) document.getElementById(`timer-h40-${num}`).textContent = localStorage.getItem(`vol${num}_timer-h40`);
    if (localStorage.getItem(`vol${num}_timer-h15`)) document.getElementById(`timer-h15-${num}`).textContent = localStorage.getItem(`vol${num}_timer-h15`);
    if (localStorage.getItem(`vol${num}_timer-h8`)) document.getElementById(`timer-h8-${num}`).textContent = localStorage.getItem(`vol${num}_timer-h8`);
    if (localStorage.getItem(`vol${num}_timer-tobt`)) document.getElementById(`timer-tobt-${num}`).textContent = localStorage.getItem(`vol${num}_timer-tobt`);
}

/* Charger donn√©es onglet */
function loadTabData(num) {
    const fields = document.querySelectorAll(`#tab-${num} input, #tab-${num} select, #tab-${num} textarea`);
    fields.forEach(field => {
        const savedValue = localStorage.getItem(`vol${num}_${field.id}`);
        if (savedValue !== null) field.value = savedValue;
    });
    updateAllCalculations(num);
}

/* Reset onglet */
function clearAutoSave(num) {
    const fields = document.querySelectorAll(`#tab-${num} input, #tab-${num} select, #tab-${num} textarea`);
    fields.forEach(field => localStorage.removeItem(`vol${num}_${field.id}`));
    localStorage.removeItem(`vol${num}_timer-h40`);
    localStorage.removeItem(`vol${num}_timer-h15`);
    localStorage.removeItem(`vol${num}_timer-h8`);
    localStorage.removeItem(`vol${num}_timer-tobt`);
    location.reload();
}

/* === BOUTON NOW === */
function setNow(fieldId) {
    const now = new Date();
    const hh = isUTC ? now.getUTCHours() : now.getHours();
    const mm = isUTC ? now.getUTCMinutes() : now.getMinutes();
    document.getElementById(fieldId).value = `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;
}

/* === AJUSTEMENT TEMPS === */
function adjustTime(fieldId, delta) {
    const input = document.getElementById(fieldId);
    if (!input.value) return;
    let [hh, mm] = input.value.split(':').map(Number);
    let d = new Date();
    d.setHours(hh);
    d.setMinutes(mm + delta);
    input.value = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
}

/* === MODE SOMBRE === */
function toggleDarkMode() {
    document.body.classList.toggle('dark');
    localStorage.setItem('modeDark', document.body.classList.contains('dark') ? '1' : '0');
}

/* === MODE LOCAL / UTC === */
function toggleTimeMode() {
    const inputs = document.querySelectorAll('input[type="time"]');
    inputs.forEach(input => {
        if (!input.value) return;
        let [hh, mm] = input.value.split(':').map(Number);
        hh = isUTC ? hh + 2 : hh - 2; // Ajuste selon ton fuseau
        if (hh < 0) hh += 24;
        if (hh >= 24) hh -= 24;
        input.value = `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;
    });
    isUTC = !isUTC;
    localStorage.setItem('modeUTC', isUTC ? '1' : '0');
}

/* === CALCULS GLOBAUX === */
function updateAllCalculations(num) {
    updateTimers(num);
    updateSOBTDefault(num);
    updateTOBT(num);
    updateDLCode(num);
}

/* === TIMERS H-40 / H-15 / LID === */
function updateTimers(num) {
    const sobt = document.getElementById(`SOBT-${num}`).value;
    if (!sobt) {
        ['timer-h40','timer-h15','timer-h8'].forEach(id=>document.getElementById(`${id}-${num}`).textContent='--:--');
        return;
    }
    const [hh, mm] = sobt.split(':').map(Number);
    const base = new Date();
    base.setHours(hh);
    base.setMinutes(mm);

    const h40 = new Date(base.getTime() - 40*60000);
    const h15 = new Date(base.getTime() - 15*60000);
    const h8 = new Date(base.getTime() - 8*60000);

    document.getElementById(`timer-h40-${num}`).textContent = `${String(h40.getHours()).padStart(2,'0')}:${String(h40.getMinutes()).padStart(2,'0')}`;
    document.getElementById(`timer-h15-${num}`).textContent = `${String(h15.getHours()).padStart(2,'0')}:${String(h15.getMinutes()).padStart(2,'0')}`;
    document.getElementById(`timer-h8-${num}`).textContent = `${String(h8.getHours()).padStart(2,'0')}:${String(h8.getMinutes()).padStart(2,'0')}`;
}

/* === CALCUL SOBT PAR DEFAUT POUR FR === */
function updateSOBTDefault(num) {
    if (manualSOBT[num]) return;
    const cie = document.getElementById(`Cie-${num}`).value;
    const sibt = document.getElementById(`SIBT-${num}`).value;
    const arrPNT = document.getElementById(`ArrPNT-${num}`)?.value;
    const arrPNC = document.getElementById(`ArrPNC-${num}`)?.value;

    if (cie !== 'FR' || !sibt) return;

    let [sH, sM] = sibt.split(':').map(Number);
    const base = new Date();
    base.setHours(sH, sM);

    const add = (arrPNT || arrPNC) ? 35 : 25;
    const sobtCalc = new Date(base.getTime() + add * 60000);

    document.getElementById(`SOBT-${num}`).value =
        `${String(sobtCalc.getHours()).padStart(2,'0')}:${String(sobtCalc.getMinutes()).padStart(2,'0')}`;
}

/* === CALCUL TOBT === */
function updateTOBT(num) {
    const cie = document.getElementById(`Cie-${num}`).value;
    const sibttxt = document.getElementById(`SIBT-${num}`).value;
    const aibttxt = document.getElementById(`AIBT-${num}`).value;
    const sobttxt = document.getElementById(`SOBT-${num}`).value;

    if (!cie || !sibttxt) {
        document.getElementById(`timer-tobt-${num}`).textContent = '--:--';
        return;
    }

    const [sH,sM] = sibttxt.split(':').map(Number);
    const [aH,aM] = aibttxt ? aibttxt.split(':').map(Number) : [sH,sM];
    const [soH,soM] = sobttxt ? sobttxt.split(':').map(Number) : [sH,sM];

    const SIBT = new Date(); SIBT.setHours(sH, sM);
    const AIBT = new Date(); AIBT.setHours(aH, aM);
    const SOBT = new Date(); SOBT.setHours(soH, soM);

    let TOBT = new Date(SIBT);

    if (cie === 'FR') {
        if (AIBT > SIBT) {
            const arrPNT = document.getElementById(`ArrPNT-${num}`).value;
            const arrPNC = document.getElementById(`ArrPNC-${num}`).value;
            const add = (arrPNT || arrPNC) ? 35 : 25;
            TOBT = new Date(AIBT.getTime() + add*60000);
        } else {
            TOBT = new Date(SIBT);
        }
    } else {
        if (AIBT > SIBT) {
            const diff = (SOBT - SIBT) / 60000;
            TOBT = new Date(AIBT.getTime() + diff*60000);
        } else {
            TOBT = new Date(SIBT);
        }
    }

    if (TOBT < SOBT) TOBT = SOBT;

    document.getElementById(`timer-tobt-${num}`).textContent =
        `${String(TOBT.getHours()).padStart(2,'0')}:${String(TOBT.getMinutes()).padStart(2,'0')}`;
}

/* === DL CODE AUTO 93 / 93A === */
function updateDLCode(num) {
    const cie = document.getElementById(`Cie-${num}`).value;
    const sibttxt = document.getElementById(`SIBT-${num}`).value;
    const aibttxt = document.getElementById(`AIBT-${num}`).value;

    if (!cie || !sibttxt || !aibttxt) return;

    const [sH,sM] = sibttxt.split(':').map(Number);
    const [aH,aM] = aibttxt.split(':').map(Number);
    const SIBT = new Date(); SIBT.setHours(sH,sM);
    const AIBT = new Date(); AIBT.setHours(aH,aM);

    if (AIBT > SIBT) {
        if (cie === 'FR') document.getElementById(`DLcode1-${num}`).value = '93';
        else if (cie === 'W4' || cie === 'W6') document.getElementById(`DLcode1-${num}`).value = '93A';
        else document.getElementById(`DLcode1-${num}`).value = '';
        document.getElementById(`DLduree1-${num}`).value = Math.round((AIBT - SIBT)/60000);
    } else {
        document.getElementById(`DLcode1-${num}`).value = '';
        document.getElementById(`DLduree1-${num}`).value = '';
    }
}

/* === VALIDATION FORMULAIRE === */
function validateForm(num) {
    const required = ['Date','Cie','Parking','NVol','From','To','Immat','RZA'];
    for (let id of required) {
        if (!document.getElementById(`${id}-${num}`).value) {
            alert("Veuillez remplir tous les champs obligatoires.");
            return;
        }
    }
    alert("Formulaire valide et pr√™t √† √™tre envoy√© !");
}
</script>

</body>
</html>
