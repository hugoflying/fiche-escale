<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SUIVI PERFORMANCE</title>
<style>
/* RESET & BASE */
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
    font-family: Arial, sans-serif;
    background: #ffffff;
    color: #222;
    padding: 10px;
}
body.dark { background: #121212; color: #f8f9f9; }

h1 { text-align: center; margin: 10px 0 15px; }

/* Sections (blocs) */
section {
    background: #f5f5f5;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 22px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
body.dark section { background: #1e1e1e; }

/* Titres de sections */
h2 {
    font-size: 1.2rem;
    margin: -12px -12px 10px -12px;
    padding: 8px 12px;
    border-bottom: 1px solid #ccc;
    text-align: center;
    cursor: pointer;
    background: #e8f0fe;
    color: #123;
    border-left: 6px solid #1976d2;
    border-top-left-radius: 8px;
    border-top-right-radius: 8px;
}
body.dark h2 {
    background: #242424;
    color: #f5f5f5;
    border-left: 6px solid #90caf9;
    border-bottom-color: #3a3a3a;
}

/* Collapse */
section.collapsed > *:not(h2) { display: none; }

/* Grilles */
.form-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
.form-group { flex: 1 1 calc(50% - 10px); min-width: 150px; margin-bottom: 10px; text-align:center; }
.form-group-3col { flex: 1 1 calc(33.33% - 10px); min-width: 120px; margin-bottom: 10px; text-align:center; }
.form-group-4col { flex: 1 1 calc(25% - 10px); min-width: 80px; margin-bottom: 10px; text-align:center; }

/* Labels en gras */
.form-group label,
.form-group-3col label,
.form-group-4col label {
    font-size: 0.9rem;
    font-weight: bold;
    display: block;
    margin-bottom: 3px;
    text-align: center;
}

/* Champs */
input, select {
    width: 100%;
    padding: 6px;
    font-size: 0.95rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    text-align: center;
}
textarea {
    width: 100%;
    padding: 6px;
    font-size: 0.95rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    resize: both;
    min-height: 60px;
    text-align: left;
    overflow: auto;
}

/* Affichage visuel en MAJ */
input.uppercase { text-transform: uppercase; }

/* Champ horaire + boutons */
.form-group input[type="time"] {
    width: 100%;
    box-sizing: border-box;
    text-align: center;
    display: block;
}

/* Boutons horaires */
.btn-actions {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    width: 100%;
    gap: 5px;
    margin-top: 5px;
}
button.action {
    width: 100%;
    padding: 10px;
    font-size: 0.95rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: transform .15s ease, filter .2s ease;
}
button.action:active { transform: scale(0.98); filter: brightness(0.95); }
button.minus { background: #555; color: white; }
button.now   { background: #1976d2; color: white; }
button.plus  { background: #555; color: white; }

/* Boutons principaux */
#validate, #save, #reset {
    width: 100%;
    padding: 12px;
    font-size: 1.2rem;
    border: none;
    border-radius: 6px;
    margin-top: 10px;
    cursor: pointer;
}
#validate { background: #4caf50; color: white; }
#save { background: #2196f3; color: white; margin: 15px 0; }
#reset { background: #d32f2f; color: white; }

/* Timers (2 groupes) */
.timer-box {
    display: flex;
    justify-content: center;
    gap: 40px;
    margin-bottom: 32px;
    flex-wrap: wrap;
}
.timer-group { display: flex; gap: 20px; align-items: center; }
.timer { display: flex; flex-direction: column; align-items: center; gap: 5px; }
.timer-label { font-weight: bold; font-size: 1rem; }
.timer-value {
    background: #d32f2f;
    color: #fff;
    font-weight: bold;
    padding: 10px 20px;
    border-radius: 6px;
    font-size: 1.1rem;
}
#timer-tobt { background: #2e7d32; }
#timer-h8   { background: #ffd54f; color:#000; }
#timer-ctot { background: #455a64; }

/* Toggles (barre du haut) */
.toggle-container { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
.toggle-group { display: flex; align-items: center; gap: 8px; }

/* Interrupteurs */
.switch { position: relative; display: inline-block; width: 60px; height: 28px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background: #cfd4da; transition: .2s; border-radius: 999px;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.2);
}
.slider:before {
    position: absolute; content: ""; height: 22px; width: 22px; left: 3px; top: 3px;
    background: #fff; transition: .2s; border-radius: 50%; box-shadow: 0 1px 2px rgba(0,0,0,.3);
}
.switch input:checked + .slider { background: #1976d2; }
.switch input:checked + .slider:before { transform: translateX(32px); }

/* L√©gendes des interrupteurs */
.toggle-caption { font-size: .9rem; user-select: none; }

/* Onglets */
#tab-bar {
    display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap;
    position: sticky; top: 0; background: #ffffff; z-index: 999; padding: 5px 0;
    backdrop-filter: saturate(180%) blur(6px);
}
#tab-bar button {
    border: none; cursor: pointer; border-radius: 8px;
    font-size: 1.05rem; padding: 8px 14px; transition: background .15s ease, transform .12s ease;
    background: #eef2f7;
}
#tab-bar button:hover { background: #e1e7f0; }
#tab-bar button:active { transform: translateY(1px); }
body.dark #tab-bar { background: #121212; }
#tab-bar button:first-child {
    font-weight: bold; font-size: 1.1rem; background: #4caf50; color: #fff;
}

/* Popup notifications */
#popup {
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
    padding: 12px 20px; border-radius: 10px; font-size: 1rem; color: #fff;
    display: none; z-index: 1000;
}

/* === TIMELINE (base) === */
.timeline-track {
  position: absolute; left:6%; right:6%;
  height: 4px; background:#cfd4da; transform:translateY(-50%); border-radius:4px;
}
body.dark .timeline-track{ background:#2e2e2e; }

.timeline-tick { position: absolute; width: 1px; background:rgba(0,0,0,0.08); }
body.dark .timeline-tick { background:#3e444b; }

.timeline-tick-label {
  position: absolute; transform: translateX(-50%);
  font-size: 14px; font-weight: 600; color:#444;
}
body.dark .timeline-tick-label { color:#cfd4da; }

.tl-event, .tl-range { position: absolute; transform: translate(-50%, -50%); white-space: nowrap; line-height:1; z-index: 1; }

/* Points (√©v√©nements) */
.tl-dot {
  width: 12px; height: 12px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 0 1px rgba(0,0,0,.15);
  margin: 0 auto 4px;
}
.tl-label {
  padding: 3px 8px; border-radius: 999px; background: #f1f3f5; color:#111; font-size: 14px; box-shadow: 0 0 0 1px rgba(0,0,0,.07);
}
body.dark .tl-label { background:#2b2b2b; color:#f5f5f5; box-shadow: 0 0 0 1px rgba(255,255,255,.07); }

/* couleurs */
.tl--std  { --c:#607d8b; }
.tl--tobt { --c:#2e7d32; }
.tl--ctot { --c:#455a64; }
.tl--ops  { --c:#1976d2; }
.tl--turn { --c:#d32f2f; }
.tl-event .tl-dot { background: var(--c); }

/* Barres de dur√©es */
.tl-range {
  height: 16px; background: color-mix(in srgb, var(--c) 50%, transparent);
  border: 2px solid var(--c); border-radius: 8px; z-index: 2;
}
.tl-range-label {
  position:absolute; top: -30px; left:50%; transform: translateX(-50%);
  font-size: 14px; background: rgba(255,255,255,.9);
  padding: 2px 8px; border-radius:6px; font-weight: 600;
}
body.dark .tl-range-label { background: rgba(0,0,0,.45); color:#fff; }

/* --- Toolbar timeline --- */
.timeline-toolbar{
  display:flex; align-items:center; gap:8px; margin: 4px 0 8px;
  flex-wrap: wrap;            /* autorise le passage sur la ligne suivante */
  min-width: 0;               /* √©vite les d√©bordements flex */
  overflow-x: hidden;         /* pas de scroll horizontal sur la toolbar */
}
.tl-btn{
  padding:6px 10px; border:0; border-radius:10px; cursor:pointer;
  background:#e7ebf0; font-weight:600; transition: transform .12s ease, background .15s ease;
}
.tl-btn:hover{ background:#dde3ea; }
.tl-btn:active{ transform: translateY(1px); }
body.dark .tl-btn{ background:#2a2a2a; color:#eee; }
.tl-sep{ width:1px; height:22px; background:#cfd4da; }
body.dark .tl-sep{ background:#3a3a3a; }

/* Coche ‚ÄúHeure sur √©tiquettes‚Äù */
.tl-toggle {
  display:flex; align-items:center; gap:6px; margin-left:8px; font-size:14px;
  max-width: 100%;
  flex-wrap: wrap;            /* laisse le texte passer √† la ligne si besoin */
}
.tl-toggle input { flex: 0 0 auto; }

/* --- zone scrollable + canvas --- */
.timeline-scroll{
  overflow-x:auto; overflow-y:hidden;
  border-radius:12px; background:#ffffff;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.08);
}
body.dark .timeline-scroll{ background:#181818; box-shadow: inset 0 0 0 1px rgba(255,255,255,.08); }
.timeline-canvas{ position:relative; min-width:600px; width:100%; /* hauteur JS dynamique */ }

/* === BLOC-NOTE (overlay moderne) === */
.note-overlay{ position: fixed; top: 6vh; left: 2vw; width: 96vw; height: 80vh; min-width: 320px; min-height: 260px; max-width: calc(100vw - 20px); max-height: calc(100vh - 20px); background: rgba(255,255,255,0.9); color:#111; border-radius:16px; box-shadow: 0 20px 50px rgba(0,0,0,.35); z-index:2000; display:none; overflow:hidden; resize: both; backdrop-filter: saturate(180%) blur(12px); opacity: 0; transform: translateY(10px) scale(.98); transition: opacity .18s ease, transform .18s ease, box-shadow .2s ease; border: 1px solid rgba(0,0,0,.06); }
.note-overlay.open{ opacity:1; transform: translateY(0) scale(1); }
.note-overlay.dragging{ box-shadow: 0 30px 70px rgba(0,0,0,.45); }
body.dark .note-overlay{ background: rgba(20,20,20,0.85); color:#eee; border-color: rgba(255,255,255,.08); }
.note-overlay::after{ content:""; position:absolute; right:8px; bottom:8px; width:16px; height:16px; background:
    linear-gradient(135deg, rgba(0,0,0,.25) 0 2px, transparent 0) right bottom / 8px 8px no-repeat,
    linear-gradient(135deg, rgba(0,0,0,.15) 0 2px, transparent 0) right 8px bottom / 8px 8px no-repeat,
    linear-gradient(135deg, rgba(0,0,0,.10) 0 2px, transparent 0) right 16px bottom / 8px 8px no-repeat;
  pointer-events:none; opacity:.6; }
body.dark .note-overlay::after{ background:
    linear-gradient(135deg, rgba(255,255,255,.3) 0 2px, transparent 0) right bottom / 8px 8px no-repeat,
    linear-gradient(135deg, rgba(255,255,255,.2) 0 2px, transparent 0) right 8px bottom / 8px 8px no-repeat,
    linear-gradient(135deg, rgba(255,255,255,.15) 0 2px, transparent 0) right 16px bottom / 8px 8px no-repeat; }

/* barre de titre */
.note-titlebar{ cursor:grab; user-select:none; display:flex; align-items:center; gap:10px; padding:10px 12px; background: linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.35)); border-bottom: 1px solid rgba(0,0,0,.06); }
.note-titlebar .spacer{ flex:1; }
.note-titlebar:active{ cursor:grabbing; }
body.dark .note-titlebar{ background: linear-gradient(180deg, rgba(30,30,30,.7), rgba(30,30,30,.45)); border-bottom-color: rgba(255,255,255,.08); }

/* Toolbar */
.note-toolbar{ display:flex; gap:10px; align-items:center; padding:10px 12px; border-bottom:1px solid rgba(0,0,0,.06); flex-wrap:wrap; }
body.dark .note-toolbar{ border-bottom-color: rgba(255,255,255,.08); }
.note-toolbar .note-btn{ border:0; padding:8px 12px; border-radius:10px; background:#e7ebf0; cursor:pointer; font-weight:600; transition: transform .12s ease, background .15s ease, box-shadow .15s ease; }
.note-toolbar .note-btn:hover{ background:#dde3ea; }
.note-toolbar .note-btn:active{ transform: translateY(1px); }
body.dark .note-toolbar .note-btn{ background:#2a2a2a; color:#eee; }
.note-btn.active{ outline: 2px solid #1976d2; box-shadow: 0 0 0 3px rgba(25,118,210,.15); }
.note-btn[disabled]{ opacity:.5; cursor:not-allowed; }
.note-btn-danger{ background:#e53935 !important; color:#fff !important; }
.note-btn-danger:hover{ filter: brightness(0.95); }
.note-btn-danger:active{ transform: translateY(1px); }
.note-toolbar input[type="range"]{ width:140px; }
.note-color{ width:24px; height:24px; border-radius:50%; border:2px solid #fff; box-shadow:0 0 0 1px rgba(0,0,0,.2); cursor:pointer; transition: transform .12s ease; }
.note-color:hover{ transform: scale(1.06); }
.note-color.selected{ outline:3px solid #1976d2; }

.note-canvas-wrap{ position:relative; width:100%; height:calc(100% - 100px); }
#noteCanvas{ width:100%; height:100%; display:block; touch-action:none; background:#fff; }
body.dark #noteCanvas{ background:#111; }

/* Ic√¥ne bloc-note dans le bandeau d‚Äôonglets */
#tab-bar .note-icon{ margin-left:auto; border-radius:12px; }
#tab-bar .note-icon:hover{ background:#e9eef6; }
body.dark #tab-bar .note-icon:hover{ background:#2a2a2a; }

/* === TIMING ‚Äì split arriv√©e / d√©part === */
.timing-split{ display:grid; grid-template-columns: repeat(2, minmax(260px,1fr)); gap:12px; }
@media (max-width: 800px){ .timing-split{ grid-template-columns: 1fr; } }
.timing-col{ background:#fff; border-radius:12px; padding:10px; box-shadow: inset 0 0 0 1px rgba(0,0,0,.05); }
body.dark .timing-col{ background:#161616; box-shadow: inset 0 0 0 1px rgba(255,255,255,.06); }
.timing-col.arr{ border-left:6px solid #2e7d32; }
.timing-col.dep{ border-left:6px solid #1976d2; }

/* TIMING ‚Äì vue basculable (tabs) */
.timing-toggle{ display:flex; justify-content:center; gap:8px; margin:6px 0 10px; }
.timing-seg{ border:1px solid rgba(0,0,0,.12); background:#eef2f7; padding:8px 14px; border-radius:999px; font-weight:700; cursor:pointer; transition:background .15s ease, transform .12s ease, color .15s ease, border-color .15s ease; }
.timing-seg:hover{ background:#e1e7f0; }
.timing-seg:active{ transform: translateY(1px); }
.timing-seg.active{ background:#1976d2; color:#fff; border-color:#1976d2; }
body.dark .timing-seg{ background:#2a2a2a; color:#eee; border-color:#3a3a3a; }
body.dark .timing-seg:hover{ background:#333; }
body.dark .timing-seg.active{ background:#90caf9; color:#111; border-color:#90caf9; }
.timing-panel{ display:none; }
.timing-panel.active{ display:block; }

/* Sp√©cifique : Arriv√©e en vert quand actif */
#seg-arr.timing-seg.active {
  background: #2e7d32;
  border-color: #2e7d32;
  color: #fff;
}
/* Option dark mode (m√™me vert) */
body.dark #seg-arr.timing-seg.active {
  background: #2e7d32;
  border-color: #2e7d32;
  color: #fff;
}

/* Now VERTS uniquement dans la colonne ARRIV√âE */
#panel-arr .btn-actions .now { background: #2e7d32; }

/* S√©parateur pour la zone recherche bagage / INAD / fermeture */
.timing-divider{ border-top:1px dashed #aaa; margin:6px 0 2px; }
body.dark .timing-divider{ border-top-color:#555; }

/* === CHIFFRES PORTE ‚Äî esth√©tique + lignes fig√©es === */
#chiffres-porte .form-grid{ display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 4px; }
#chiffres-porte .cp-row{ grid-column: 1 / -1; display: grid; gap: 12px; margin-bottom: 6px; }
#chiffres-porte .cp-cols-1{ grid-template-columns: 1fr; }
#chiffres-porte .cp-cols-2{ grid-template-columns: repeat(2, minmax(140px,1fr)); }
#chiffres-porte .cp-cols-3{ grid-template-columns: repeat(3, minmax(140px,1fr)); }
#chiffres-porte .cp-cols-4{ grid-template-columns: repeat(4, minmax(140px,1fr)); }
#chiffres-porte .form-group,
#chiffres-porte .form-group-3col,
#chiffres-porte .form-group-4col{
  background: linear-gradient(180deg, #ffffff, #f7fafc);
  border-radius: 12px;
  padding: 10px;
  box-shadow: 0 8px 20px rgba(0,0,0,.08), inset 0 0 0 1px rgba(0,0,0,.05);
  transition: transform .12s ease, box-shadow .15s ease, background .2s ease;
  position: relative; overflow: hidden;
}
#chiffres-porte .form-group:hover,
#chiffres-porte .form-group-3col:hover,
#chiffres-porte .form-group-4col:hover{
  transform: translateY(-1px);
  box-shadow: 0 12px 28px rgba(0,0,0,.12), inset 0 0 0 1px rgba(0,0,0,.06);
}
#chiffres-porte .form-group::before,
#chiffres-porte .form-group-3col::before,
#chiffres-porte .form-group-4col::before{
  content:"";
  position:absolute; left:0; top:0; bottom:0; width:6px;
  background: linear-gradient(180deg, #1976d2, #4caf50);
  opacity:.85;
}
#chiffres-porte label{ font-weight: 800; font-size: .9rem; color:#123; }
#chiffres-porte input, #chiffres-porte select{
  background: #fff; border: 1px solid #d7dde5; border-radius: 8px; padding: 8px; font-weight: 700;
}
#chiffres-porte #TOB{
  font-size: 1.25rem; letter-spacing: .5px; background: #e8f0fe; border: 2px solid #1976d2; border-radius: 10px;
}
body.dark #chiffres-porte .form-group,
body.dark #chiffres-porte .form-group-3col,
body.dark #chiffres-porte .form-group-4col{
  background: linear-gradient(180deg, #171717, #121212);
  box-shadow: 0 8px 20px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.06);
}
body.dark #chiffres-porte label{ color:#eef2f7; }
body.dark #chiffres-porte input, body.dark #chiffres-porte select{
  background:#0f0f0f; color:#eef2f7; border-color:#2e2e2e;
}
body.dark #chiffres-porte #TOB{ background:#1b2636; border-color:#90caf9; }

/* === CHIFFRES PORTE via <details> : r√©tractable */
#chiffres-porte summary { list-style: none; cursor: pointer; }
#chiffres-porte summary::-webkit-details-marker { display: none; }
#chiffres-porte summary h2 { cursor: pointer; }

/* === PATCH: Timeline plus a√©r√©e (barres + √©tiquettes) === */
.tl-range { height: 16px; }
.tl-range-label { top: -30px; }

/* Bordure d'erreur DL */
.dl-error { border: 2px solid #d32f2f !important; border-radius: 4px; }

/* --- D√©tails repliables (INAD / Recherche bagage) --- */
details.timing-collapse summary { list-style: none; }
details.timing-collapse summary::-webkit-details-marker { display: none; }
details.timing-collapse > summary.timing-seg { display:inline-block; }
details.timing-collapse[open] > summary.timing-seg {
  background:#1976d2; color:#fff; border-color:#1976d2;
}
body.dark details.timing-collapse[open] > summary.timing-seg {
  background:#90caf9; color:#111; border-color:#90caf9;
}

/* === FIX responsive + overflow pour CHIFFRES PORTE === */
#chiffres-porte .form-group,
#chiffres-porte .form-group-3col,
#chiffres-porte .form-group-4col {
  min-width: 0; /* √©vite le d√©bordement des items en grid */
}
#chiffres-porte .cp-cols-2,
#chiffres-porte .cp-cols-3,
#chiffres-porte .cp-cols-4 {
  /* au lieu d'imposer 2/3/4 colonnes, on s'adapte √† la largeur dispo */
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
}
@media (max-width: 900px) {
  #chiffres-porte .cp-cols-2,
  #chiffres-porte .cp-cols-3,
  #chiffres-porte .cp-cols-4 {
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  }
}
#chiffres-porte input,
#chiffres-porte select {
  max-width: 100%;
}

/* === TAGS: grille 2 colonnes, pleine largeur === */
#TagsContainer{
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 10px;
  align-items: start;
}
#TagsContainer .form-group{
  margin-bottom: 0; /* g√©r√© par le gap */
}
/* Si nombre impair, le dernier s'√©tale sur toute la ligne */
#TagsContainer .form-group:nth-last-child(1):nth-child(odd){
  grid-column: 1 / -1;
}
/* Sur petit √©cran: 1 colonne */
@media (max-width: 700px){
  #TagsContainer{ grid-template-columns: 1fr; }
}
</style>
</head>
<body onload="initForm()">

<!-- Modes -->
<div class="toggle-container">
  <div class="toggle-group">
    <span class="toggle-caption">Jour / Nuit</span>
    <label class="switch" title="Basculer Jour/Nuit">
      <input type="checkbox" id="darkToggle" onchange="setDarkMode(this.checked)">
      <span class="slider"></span>
    </label>
  </div>
  <div class="toggle-group">
    <span class="toggle-caption">Local / UTC</span>
    <label class="switch" title="Basculer Local/UTC">
      <input type="checkbox" id="utcToggle" onchange="setTimeModeUTC(this.checked)">
      <span class="slider"></span>
    </label>
  </div>
</div>

<!-- Barre d‚Äôonglets -->
<div id="tab-bar">
  <button onclick="createNewTab()" style="padding:8px 15px;">+ Ajouter vol</button>
</div>

<h1>SUIVI PERFORMANCE</h1>

<!-- Timers -->
<div class="timer-box">
  <div class="timer-group">
    <div class="timer"><div class="timer-label">HLE</div><div id="timer-h40" class="timer-value">--:--</div></div>
    <div class="timer"><div class="timer-label">H-15</div><div id="timer-h15" class="timer-value">--:--</div></div>
    <div id="lidBlock" class="timer" style="display:none;"><div class="timer-label">LID</div><div id="timer-h8" class="timer-value">--:--</div></div>
  </div>
  <div class="timer-group">
    <div class="timer"><div class="timer-label">TOBT</div><div id="timer-tobt" class="timer-value">--:--</div></div>
    <div class="timer"><div class="timer-label">CTOT</div><div id="timer-ctot" class="timer-value">--:--</div></div>
  </div>
</div>

<!-- INFO VOL -->
<section>
  <h2>INFO VOL</h2>
  <div class="form-grid">
    <div class="form-group" style="flex:1 1 100%;"><label>Date<input type="date" id="Date"></label></div>
    <div class="form-group"><label>Cie
      <select id="Cie" onchange="updateAllCalculations(); generateChargementFields(); updateTabLabelInstant();">
        <option value="">--</option>
        <option>FR</option><option>RK</option><option>W4</option><option>W6</option>
        <option>H4</option><option>H6</option><option>U5</option><option>U7</option>
        <option>V7</option><option>Autre</option>
      </select>
    </label></div>
    <div class="form-group"><label>N¬∞ VOL
      <input class="uppercase" type="text" id="NVol" oninput="updateTabLabelInstant()">
    </label></div>
    <div class="form-group"><label>Provenance<input class="uppercase" type="text" id="From" maxlength="3"></label></div>
    <div class="form-group"><label>Destination
      <input class="uppercase" type="text" id="To" maxlength="3" oninput="updateTabLabelInstant()">
    </label></div>
    <div class="form-group"><label>Immat<input class="uppercase" type="text" id="Immat" maxlength="5"></label></div>
    <div class="form-group"><label>Parking
      <select id="Parking">
        <option value="">--</option>
        <option>1</option><option>2</option><option>3</option><option>4</option>
        <option>5</option><option>6</option><option>7</option><option>8</option>
        <option>9</option><option>10</option><option>11</option><option>12</option>
      </select>
    </label></div>
    <div class="form-group"><label>RZA<input class="uppercase" type="text" id="RZA" maxlength="3"></label></div>
    <div class="form-group"><label>FNC
      <select id="FNC"><option>Y</option><option selected>N</option></select>
    </label></div>
  </div>
</section>

<!-- HORAIRES -->
<section>
  <h2>HORAIRES</h2>
  <div class="form-grid">
    <div class="form-group">
      <label>SIBT<input type="time" id="SIBT" onchange="updateAllCalculations()"></label>
      <div class="btn-actions">
        <button class="action minus" onclick="adjustTime('SIBT',-1);updateAllCalculations()">-1</button>
        <button class="action now" onclick="setNow('SIBT');updateAllCalculations()">Now</button>
        <button class="action plus" onclick="adjustTime('SIBT',1);updateAllCalculations()">+1</button>
      </div>
    </div>
    <div class="form-group">
      <label>AIBT<input type="time" id="AIBT" onchange="updateAllCalculations()"></label>
      <div class="btn-actions">
        <button class="action minus" onclick="adjustTime('AIBT',-1);updateAllCalculations()">-1</button>
        <button class="action now" onclick="setNow('AIBT');updateAllCalculations()">Now</button>
        <button class="action plus" onclick="adjustTime('AIBT',1);updateAllCalculations()">+1</button>
      </div>
    </div>
    <div class="form-group">
      <label>SOBT<input type="time" id="SOBT" onchange="manualSOBT=true;updateAllCalculations()"></label>
      <div class="btn-actions">
        <button class="action minus" onclick="adjustTime('SOBT',-1);manualSOBT=true;updateAllCalculations()">-1</button>
        <button class="action now" onclick="setNow('SOBT');manualSOBT=true;updateAllCalculations()">Now</button>
        <button class="action plus" onclick="adjustTime('SOBT',1);manualSOBT=true;updateAllCalculations()">+1</button>
      </div>
    </div>
    <div class="form-group">
      <label>AOBT<input type="time" id="AOBT" onchange="updateAllCalculations()"></label>
      <div class="btn-actions">
        <button class="action minus" onclick="adjustTime('AOBT',-1);updateAllCalculations()">-1</button>
        <button class="action now" onclick="setNow('AOBT');updateAllCalculations()">Now</button>
        <button class="action plus" onclick="adjustTime('AOBT',1);updateAllCalculations()">+1</button>
      </div>
    </div>
    <div class="form-group">
      <label>CTOT<input type="time" id="CTOT" onchange="updateAllCalculations()"></label>
      <div class="btn-actions">
        <button class="action minus" onclick="adjustTime('CTOT',-1);updateAllCalculations()">-1</button>
        <button class="action now" onclick="setNow('CTOT');updateAllCalculations()">Now</button>
        <button class="action plus" onclick="adjustTime('CTOT',1);updateAllCalculations()">+1</button>
      </div>
    </div>
  </div>
</section>

<!-- TIMING -->
<section>
  <h2>TIMING</h2>
  <div id="timing-grid"></div>
</section>

<!-- TIMELINE -->
<section>
  <h2>TIMELINE</h2>

  <div class="timeline-toolbar">
    <button type="button" class="tl-btn" onclick="timelineZoomOut()">‚àí</button>
    <span id="timelineZoomLabel">100%</span>
    <button type="button" class="tl-btn" onclick="timelineZoomIn()">+</button>
    <div class="tl-sep"></div>
    <button type="button" class="tl-btn" onclick="timelineScroll(-15)">‚óÄ 15 min</button>
    <button type="button" class="tl-btn" onclick="timelineScroll(15)">15 min ‚ñ∂</button>
    <div class="tl-sep"></div>
    <button type="button" class="tl-btn" onclick="timelineZoomReset()">Reset</button>
    <label class="tl-toggle" title="Afficher l‚Äôheure √† c√¥t√© des √©tiquettes">
      <input type="checkbox" id="showTimesToggle" checked
             onchange="try{ showTimeLabels=this.checked; renderTimeline(); }catch(e){}">
      Afficher heure/dur√©e sur √©tiquettes
    </label>
  </div>

  <div class="timeline-scroll" id="timelineScroll">
    <div id="timelineCanvas" class="timeline-canvas"></div>
  </div>
</section>

<!-- CHIFFRES PORTE (r√©tractable ‚Äì version <details>) -->
<section id="chiffres-porte">
  <details id="cp-details" open>
    <summary><h2>CHIFFRES PORTE</h2></summary>
    <div id="chargement-container" class="form-grid"></div>
  </details>
</section>

<!-- RETARDS -->
<section>
  <h2>RETARDS (D√©part)</h2>
  <div class="form-grid">
    <div class="form-group"><label>DL Code 1<input type="text" id="DLcode1"></label></div>
    <div class="form-group"><label>DL Dur√©e 1 (min)<input type="number" id="DLduree1" min="0" step="1" oninput="dldChanged(1)"></label></div>
    <div class="form-group"><label>DL Code 2<input type="text" id="DLcode2"></label></div>
    <div class="form-group"><label>DL Dur√©e 2 (min)<input type="number" id="DLduree2" min="0" step="1" oninput="dldChanged(2)"></label></div>
    <div class="form-group"><label>DL Code 3<input type="text" id="DLcode3"></label></div>
    <div class="form-group"><label>DL Dur√©e 3 (min)<input type="number" id="DLduree3" min="0" step="1" oninput="dldChanged(3)"></label></div>
  </div>
</section>

<!-- DL JUSTIFICATION -->
<section>
  <h2>DL JUSTIFICATIONS</h2>
  <textarea id="DLJustif"></textarea>
</section>

<!-- FAITS SAILLANTS -->
<section>
  <h2>FAITS SAILLANTS</h2>
  <textarea id="FaitsSaillants"></textarea>
</section>

<!-- ASSISTANCES -->
<section>
  <h2>ASSISTANCES PRISES EN CHARGE A/D</h2>
  <div class="form-grid">
    <div class="form-group-4col"><label>WCHC<input type="number" id="WCHC" min="0" step="1" oninput="sanitizePositiveInt(this)"></label></div>
    <div class="form-group-4col"><label>WCHS<input type="number" id="WCHS" min="0" step="1" oninput="sanitizePositiveInt(this)"></label></div>
    <div class="form-group-4col"><label>WCHR<input type="number" id="WCHR" min="0" step="1" oninput="sanitizePositiveInt(this)"></label></div>
    <div class="form-group-4col"><label>Autre<input type="number" id="AutreAssist"></label></div>
  </div>
</section>

<!-- PRESTATIONS -->
<section>
  <h2>PRESTATIONS</h2>
  <div class="form-grid">
    <div class="form-group-3col"><label>ASU<select id="ASU"><option>N</option><option>Y</option></select></label></div>
    <div class="form-group-3col"><label>Flux RZA<select id="FluxRZA"><option>N</option><option>Y</option></select></label></div>
    <div class="form-group-3col"><label>Eau potable<select id="EauPotable"><option>N</option><option>Y</option></select></label></div>
    <div class="form-group-3col"><label>Vidange toilettes<select id="Vidange"><option>N</option><option>Y</option></select></label></div>
    <div class="form-group-3col"><label>M√©nage Assist'Air<select id="MenageAssist"><option>N</option><option>Y</option></select></label></div>
    <div class="form-group-3col"><label>M√©nage Atalian<select id="MenageAtalian"><option>T</option><option>F</option></select></label></div>
    <div class="form-group-3col"><label>Collecte d'ordures<select id="Ordures"><option>Y</option><option>N</option></select></label></div>
    <div class="form-group-3col"><label>Toilet Kit<select id="ToiletKit"><option>N</option><option>Y</option></select></label></div>
    <div class="form-group-3col"><label>D√©givrage<select id="Degivrage"><option>N</option><option>Y</option></select></label></div>
    <div class="form-group-3col"><label>Push-Pull<select id="PushPull"><option>N</option><option>Y</option></select></label></div>
    <div class="form-group-3col"><label>Echelle suppl√©mentaire<select id="Echelle"><option>N</option><option>Y</option></select></label></div>
  </div>
</section>

<!-- === BLOC-NOTE SUPERPOS√â === -->
<div id="noteOverlay" class="note-overlay" aria-hidden="true">
  <div id="noteDragBar" class="note-titlebar">
    <strong>Bloc-note</strong>
    <div class="spacer"></div>
    <button type="button" class="note-btn note-btn-danger" onclick="closeNotepadOverlay()" title="Fermer (ESC)" aria-label="Fermer">‚ùå</button>
  </div>

  <div class="note-toolbar">
    <button type="button" id="toolPen"   class="note-btn active" onclick="setNoteTool('pen')">‚úèÔ∏è Crayon</button>
    <button type="button" id="toolErase" class="note-btn"        onclick="setNoteTool('eraser')">üßΩ Gomme</button>
    <button type="button" class="note-btn" id="noteClearBtn" onclick="noteClearAll()" title="Tout effacer">üßπ Effacer</button>

    <button type="button" class="note-btn" id="noteUndoBtn" onclick="noteUndo()" title="Annuler (Ctrl+Z)" disabled>‚Ü∂ Undo</button>
    <button type="button" class="note-btn" id="noteRedoBtn" onclick="noteRedo()" title="R√©tablir (Ctrl+Y / Ctrl+Shift+Z)" disabled>‚Ü∑ Redo</button>

    <span style="margin-left:6px;">Taille crayon</span>
    <input id="penSize" type="range" min="1" max="20" step="1" value="3" oninput="updatePenSizeLabel()">
    <span id="penSizeVal">3</span>px

    <span style="margin-left:12px;">Taille gomme</span>
    <input id="eraserSize" type="range" min="5" max="60" step="1" value="22" oninput="updateEraserSizeLabel()">
    <span id="eraserSizeVal">22</span>px

    <div style="display:flex; align-items:center; gap:10px; margin-left:12px;">
      <div class="note-color" id="noteColorDotDefault" style="background:#111" onclick="pickColor(this, getThemeDefaultPen())"></div>
      <div class="note-color" style="background:#d32f2f" onclick="pickColor(this,'#d32f2f')"></div>
      <div class="note-color" style="background:#1976d2" onclick="pickColor(this,'#1976d2')"></div>
      <div class="note-color" style="background:#2e7d32" onclick="pickColor(this,'#2e7d32')"></div>
      <div class="note-color" style="background:#ff9800" onclick="pickColor(this,'#ff9800')"></div>
      <input id="noteColorInput" type="color" value="#111111" onchange="pickColor(null,this.value)">
    </div>
  </div>

  <div class="note-canvas-wrap">
    <canvas id="noteCanvas"></canvas>
  </div>
</div>

<!-- Boutons finaux -->
<button id="validate" onclick="validateForm()">VALIDER</button>
<button id="save" onclick="manualSave()">SAUVEGARDER</button>
<button id="reset" onclick="clearAutoSave()">R√âINITIALISER TOUT</button>

<script>
/* === Variables === */
let isUTC=false;
let manualSOBT=false;
let currentTabId=null;
const circledNums=["","‚ë†","‚ë°","‚ë¢","‚ë£","‚ë§","‚ë•","‚ë¶","‚ëß","‚ë®","‚ë©","‚ë™","‚ë´"];
let saveTimer=null;

/* TIMELINE zoom & scroll */
let timelineZoom = 1;
const TL_ZOOM_MIN = 0.5;
const TL_ZOOM_MAX = 8;
const TL_ZOOM_STEP = 0.25;
window._timelineCurrentRange = null;

/* TOBT brut (hors CTOT) stock√© en minutes pour LID */
window._tobtRawMins = null;

/* === Notepad theme defaults === */
const NOTE_DEFAULT_LIGHT = '#111111';
const NOTE_DEFAULT_DARK  = '#FFFFFF';

/* === DL auto tracking === */
let lastDLChanged = 1;

/* Zoom helpers */
function timelineZoomIn(){ timelineSetZoom(timelineZoom + TL_ZOOM_STEP); }
function timelineZoomOut(){ timelineSetZoom(timelineZoom - TL_ZOOM_STEP); }
function timelineZoomReset(){ timelineSetZoom(1); }
function timelineSetZoom(z){
  const scroller = document.getElementById('timelineScroll');
  const canvas   = document.getElementById('timelineCanvas');
  if(!scroller || !canvas) return;
  const prevCenterRatio = (scroller.scrollLeft + scroller.clientWidth/2) / Math.max(1, scroller.scrollWidth);
  timelineZoom = Math.max(TL_ZOOM_MIN, Math.min(TL_ZOOM_MAX, z));
  const lbl = document.getElementById('timelineZoomLabel');
  if(lbl) lbl.textContent = `${Math.round(timelineZoom*100)}%`;
  renderTimeline();
  scroller.scrollLeft = prevCenterRatio * scroller.scrollWidth - scroller.clientWidth/2;
}
function timelineScroll(deltaMinutes){
  const scroller = document.getElementById('timelineScroll');
  if(!scroller || !_timelineCurrentRange) return;
  const totalMin = _timelineCurrentRange.max - _timelineCurrentRange.min;
  const pxPerMin = (scroller.scrollWidth) / Math.max(1,totalMin);
  scroller.scrollLeft += deltaMinutes * pxPerMin;
}

/* INIT */
function initForm(){
  renderTabs();
  let lastTab=localStorage.getItem('lastTabId');
  let tabs=JSON.parse(localStorage.getItem('flightTabs')||'[]');
  if(tabs.length===0) createNewTab();
  else if(lastTab && tabs.includes(parseInt(lastTab))) switchTab(parseInt(lastTab));
  else switchTab(tabs[0]);

  generateTimingFields();
  generateChargementFields();
  attachAutoSave();
  window.addEventListener('beforeunload', saveCurrentTabData);

  /* replis g√©n√©riques sur H2, sauf CHIFFRES PORTE (g√©r√©e par <details>) */
  document.querySelectorAll("section h2").forEach(h2=>{
    if (h2.closest('#chiffres-porte')) return;
    h2.onclick=()=>h2.parentElement.classList.toggle("collapsed");
  });

  document.getElementById('Parking').addEventListener('change', updateTabLabelInstant);
  document.getElementById('Cie').addEventListener('change', ()=>{
    updateTabLabelInstant();
    generateChargementFields();
    updateAllCalculations();
  });
  document.getElementById('NVol').addEventListener('input', updateTabLabelInstant);
  document.getElementById('To').addEventListener('input', updateTabLabelInstant);

  document.getElementById('From').addEventListener('input', applyPrestationsDefaults);
  document.getElementById('To').addEventListener('input', applyPrestationsDefaults);

  setupUppercaseInputs(['NVol','From','To','Immat','RZA']);

  const storedDark = (localStorage.getItem('modeDark')||'0')==='1';
  const storedUTC  = (localStorage.getItem('modeUTC')||'0')==='1';
  setDarkMode(storedDark, true);
  setTimeModeUTC(storedUTC, true);

  const scroller = document.getElementById('timelineScroll');
  if(scroller){
    let isDown=false, startX=0, startLeft=0;
    scroller.addEventListener('mousedown', e=>{ isDown=true; startX=e.clientX; startLeft=scroller.scrollLeft; });
    scroller.addEventListener('mouseleave', ()=>{ isDown=false; });
    scroller.addEventListener('mouseup', ()=>{ isDown=false; });
    scroller.addEventListener('mousemove', e=>{
      if(!isDown) return;
      const dx = e.clientX - startX;
      scroller.scrollLeft = startLeft - dx;
      e.preventDefault();
    });
    ['wheel','mousedown','touchstart','keydown','scroll'].forEach(ev=>{
      scroller.addEventListener(ev, ()=>{ window.timelineUserScrolled = true; }, {passive:true});
    });
  }

  const lbl = document.getElementById('timelineZoomLabel');
  if(lbl) lbl.textContent = `${Math.round(timelineZoom*100)}%`;

  if (currentTabId) loadTabData(currentTabId);

  setDefaultDateToTodayIfEmpty();

  renderTimeline();

  document.addEventListener('keydown', (e)=>{
    if(e.key==='n' && (e.ctrlKey || e.metaKey)){
      e.preventDefault();
      toggleNotepadOverlay();
    }
    if(e.key==='Escape' && noteOpen){
      e.preventDefault();
      closeNotepadOverlay();
    }
  });
}

/* date par d√©faut = aujourd‚Äôhui si vide */
function setDefaultDateToTodayIfEmpty(){
  const d = document.getElementById('Date');
  if(d && !d.value){ d.valueAsDate = new Date(); }
}

/* Forcer MAJUSCULE */
function setupUppercaseInputs(ids){
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    const toUpper = ()=>{ el.value = (el.value||'').toUpperCase(); };
    el.addEventListener('input', toUpper);
    el.addEventListener('blur', toUpper);
  });
}

/* Emp√™cher n√©gatifs / non-entiers */
function sanitizePositiveInt(inputEl){
  inputEl.value = (inputEl.value || '').replace(/[^0-9]/g,'');
}

/* Chiffres uniquement (pr√©serve z√©ros en t√™te) */
function sanitizeDigitsOnly(inputEl){
  inputEl.value = (inputEl.value || '').replace(/\D/g, '');
}

/* Autosave */
function attachAutoSave(){
  const handler=()=>{
    clearTimeout(saveTimer);
    saveTimer=setTimeout(()=>{ saveCurrentTabData(); renderTimeline(); }, 300);
  };
  document.addEventListener('input', handler, true);
  document.addEventListener('change', handler, true);
}

/* Tabs */
function renderTabs(){
  const tabBar=document.getElementById('tab-bar');
  tabBar.innerHTML='<button onclick="createNewTab()" style="padding:8px 15px;">+ Ajouter vol</button>';
  let tabs=JSON.parse(localStorage.getItem('flightTabs')||'[]');
  tabs.forEach((id)=>{
    const data=JSON.parse(localStorage.getItem('tab-'+id)||'{}');

    const cie = (data.Cie||'').toUpperCase();
    const nvol = (data.NVol||'').toUpperCase();
    const to = (data.To||'').toUpperCase();

    let left = `${cie}${nvol||''}`.trim();
    let label = left || to ? (to ? `${left} | ${to}`.trim() : left) : 'VOL';

    const btn=document.createElement('button');
    btn.textContent=label || 'VOL';
    btn.style.fontWeight=id===currentTabId?'bold':'normal';
    btn.onclick=()=>switchTab(id);
    btn.ondblclick=()=>deleteTab(id);
    tabBar.appendChild(btn);
  });

  const noteBtn = document.createElement('button');
  noteBtn.className = 'note-icon';
  noteBtn.title = 'Ouvrir le bloc-note';
  noteBtn.textContent = 'üìù';
  noteBtn.onclick = toggleNotepadOverlay;
  tabBar.appendChild(noteBtn);
}

function createNewTab(){
  const newId=Date.now();
  let tabs=JSON.parse(localStorage.getItem('flightTabs')||'[]');
  tabs.push(newId);
  localStorage.setItem('flightTabs',JSON.stringify(tabs));
  clearFormFields();
  currentTabId=newId;
  localStorage.setItem('lastTabId',newId);
  saveCurrentTabData();
  renderTabs();
}

function switchTab(id){
  saveCurrentTabData();
  currentTabId=id;
  localStorage.setItem('lastTabId',id);
  loadTabData(id);
  renderTabs();
  renderTimeline();
}

function deleteTab(id){
  if(!confirm("Supprimer cet onglet ?")) return;
  let tabs=JSON.parse(localStorage.getItem('flightTabs')||'[]');
  tabs=tabs.filter(t=>t!==id);
  localStorage.setItem('flightTabs',JSON.stringify(tabs));
  localStorage.removeItem('tab-'+id);
  if(tabs.length>0) switchTab(tabs[0]);
  else createNewTab();
  renderTabs();
  renderTimeline();
}

function clearFormFields(){
  document.querySelectorAll('input, select, textarea').forEach(el=>{
    if(el.type==='checkbox'||el.type==='radio') el.checked=false;
    else if(el.tagName==='SELECT') el.selectedIndex=0;
    else el.value='';
  });
  document.getElementById('Date').valueAsDate=new Date();
  document.getElementById('FNC').value='N';
  updateAllCalculations();
}

function saveCurrentTabData(){
  if(!currentTabId) return;
  let data={};
  document.querySelectorAll('input, select, textarea').forEach(el=>{
    if(!el.id) return;
    if(el.type==='checkbox') data[el.id]=el.checked ? '1':'0';
    else data[el.id]=el.value;
  });
  data.modeDark=document.body.classList.contains('dark')?'1':'0';
  data.modeUTC=isUTC?'1':'0';
  data.timer_h40=document.getElementById('timer-h40').textContent;
  data.timer_h15=document.getElementById('timer-h15').textContent;
  data.timer_h8=document.getElementById('timer-h8').textContent;
  data.timer_tobt=document.getElementById('timer-tobt').textContent;
  data.timer_ctot=document.getElementById('timer-ctot').textContent;
  data.timingPanel = localStorage.getItem('timingPanel') || 'dep';
  localStorage.setItem('tab-'+currentTabId,JSON.stringify(data));
  localStorage.setItem('lastTabId',currentTabId);
  renderTabs();
}

function loadTabData(id){
  const data=JSON.parse(localStorage.getItem('tab-'+id)||'{}');

  document.querySelectorAll('input, select, textarea').forEach(el=>{
    if(!el.id || data[el.id]===undefined) return;
    if(el.type==='checkbox') el.checked = data[el.id]==='1';
    else el.value = data[el.id];
  });

  if(data.modeDark==='1') document.body.classList.add('dark'); else document.body.classList.remove('dark');
  isUTC=data.modeUTC==='1';

  document.getElementById('timer-h40').textContent=data.timer_h40||'--:--';
  document.getElementById('timer-h15').textContent=data.timer_h15||'--:--';
  document.getElementById('timer-h8').textContent=data.timer_h8||'--:--';
  document.getElementById('timer-tobt').textContent=data.timer_tobt||'--:--';
  document.getElementById('timer-ctot').textContent=data.timer_ctot||'--:--';

  document.getElementById('darkToggle').checked = document.body.classList.contains('dark');
  document.getElementById('utcToggle').checked  = isUTC;

  setDefaultDateToTodayIfEmpty();

  generateChargementFields();
  updateAllCalculations();

  const savedPanel = data.timingPanel || localStorage.getItem('timingPanel') || 'dep';
  switchTimingPanel(savedPanel);

  updateTagInputs();
}

/* Mise √† jour label onglet */
function updateTabLabelInstant(){ saveCurrentTabData(); renderTabs(); }

/* TIMING FIELDS ‚Äì ARR / DEP */
function generateTimingFields(){
  const container=document.getElementById('timing-grid');
  if(!container) return;

  const fieldHTML = (id,label)=>`
    <div class="form-group">
      <label>${label}<input type="time" id="${id}" onchange="updateAllCalculations()"></label>
      <div class="btn-actions">
        <button class="action minus" onclick="adjustTime('${id}',-1);updateAllCalculations()">-1</button>
        <button class="action now"   onclick="setNow('${id}');updateAllCalculations()">Now</button>
        <button class="action plus"  onclick="adjustTime('${id}',1);updateAllCalculations()">+1</button>
      </div>
    </div>`;

  /* ARRIV√âE */
  let arr = '';
  arr += `<div class="timing-col arr"><div class="form-grid">`;
  arr += fieldHTML('PremierDebarque','Premier d√©barqu√©');
  arr += fieldHTML('DernierDebarque','Dernier d√©barqu√©');

  /* SUPPR: D√©but GPU */
  arr += fieldHTML('ArriveeFuel','Arriv√©e Avitair');

  arr += fieldHTML('ArriveeLiftArr','Arriv√©e lift');
  arr += fieldHTML('DepartLiftArr','D√©part lift');

  arr += fieldHTML('ArriveeAgentsPMRArr','Arriv√©e agent PMR');
  /* SUPPR: D√©barquement PMR */

  arr += fieldHTML('DebutDechargementBagages','D√©but d√©chargement bagages');
  arr += fieldHTML('FinDechargementBagages','Fin d√©chargement bagages');
  arr += `</div></div>`;

  /* D√âPART (r√©organisation + collapsibles) */
  let dep = '';
  dep += `<div class="timing-col dep"><div class="form-grid">`;
  dep += fieldHTML('ArrPNT','Arriv√©e PNT');
  dep += fieldHTML('ArrPNC','Arriv√©e PNC');

  dep += fieldHTML('AvionPremierEmbarque','Premier embarqu√©');
  dep += fieldHTML('AvionDernierEmbarque','Dernier embarqu√©');

  dep += fieldHTML('DepartFuel','D√©part Avitair');

  dep += fieldHTML('ArriveeLift','Arriv√©e lift');
  dep += fieldHTML('DepartLift','D√©part lift');

  dep += fieldHTML('ArriveeAgentsPMRDep','Arriv√©e agent PMR');
  /* SUPPR: Embarquement PMR */

  dep += fieldHTML('DebutChargementBagages','D√©but chargement bagages');
  dep += fieldHTML('FinChargementBagages','Fin chargement bagages');

  dep += fieldHTML('RemiseLID','Remise LID/LDS');

  /* SUPPR: Mise TPX/TMX + Fin GPU */
  /* Fermeture porte avion ‚Äî PAS de s√©parateur au-dessus */
  dep += fieldHTML('FermeturePorteAvion','Fermeture porte avion');

  /* --- S√©parateur puis bloc INAD repliable (ferm√© par d√©faut) --- */
  dep += `<div class="form-group" style="flex:1 1 100%;"><div class="timing-divider"></div></div>`;
  dep += `
    <details class="timing-collapse" style="flex:1 1 100%;">
      <summary class="timing-seg">INAD (d√©plier si besoin)</summary>
      <div class="form-grid" style="margin-top:8px;">
        ${fieldHTML('ArriveeINAD','Arriv√©e INAD')}
        <div class="form-group">
          <label>Quantit√© INAD
            <input type="number" id="QuantiteINAD" min="0" step="1" oninput="sanitizePositiveInt(this)">
          </label>
        </div>
      </div>
    </details>`;

  /* --- S√©parateur puis bloc Recherche bagage repliable (ferm√© par d√©faut) --- */
  dep += `<div class="form-group" style="flex:1 1 100%;"><div class="timing-divider"></div></div>`;
  dep += `
    <details class="timing-collapse" style="flex:1 1 100%;">
      <summary class="timing-seg">Recherche bagage (d√©plier si besoin)</summary>
      <div class="form-grid" style="margin-top:8px;">
        ${fieldHTML('DebutRechercheBagage','D√©but recherche bagage')}
        ${fieldHTML('FinRechercheBagage','Fin recherche bagage')}
        <div class="form-group" style="flex:1 1 100%;">
          <label>Quantit√© bagage(s) d√©charg√©(s)
            <input type="number" id="NbBagagesDecharges" min="0" step="1"
                   oninput="sanitizePositiveInt(this); updateTagInputs()">
          </label>
        </div>
        <!-- Conteneur dynamique des Num√©ro tag i (affich√©s UNIQUEMENT sous le champ ci-dessus) -->
        <div id="TagsContainer" style="margin-top:6px;"></div>
      </div>
    </details>`;

  dep += `</div></div>`;

  const toggle = `
    <div class="timing-toggle">
      <button type="button" id="seg-arr" class="timing-seg" onclick="switchTimingPanel('arr')">Arriv√©e</button>
      <button type="button" id="seg-dep" class="timing-seg" onclick="switchTimingPanel('dep')">D√©part</button>
    </div>`;

  container.innerHTML = toggle +
    `<div class="timing-panel" id="panel-arr">${arr}</div>` +
    `<div class="timing-panel" id="panel-dep">${dep}</div>`;

  const saved = localStorage.getItem('timingPanel') || 'dep';
  switchTimingPanel(saved);

  // Init champs tags si valeur d√©j√† pr√©sente
  updateTagInputs();
}

function switchTimingPanel(mode){
  const arrPanel=document.getElementById('panel-arr');
  const depPanel=document.getElementById('panel-dep');
  const btnArr=document.getElementById('seg-arr');
  const btnDep=document.getElementById('seg-dep');
  [arrPanel,depPanel].forEach(p=>p&&p.classList.remove('active'));
  [btnArr,btnDep].forEach(b=>b&&b.classList.remove('active'));
  if(mode==='arr'){ if(arrPanel) arrPanel.classList.add('active'); if(btnArr) btnArr.classList.add('active'); }
  else { if(depPanel) depPanel.classList.add('active'); if(btnDep) btnDep.classList.add('active'); }
  localStorage.setItem('timingPanel', mode);
}

/* CHARGEMENT / TOB */
function generateChargementFields() {
  const cie = (document.getElementById('Cie').value||'').toUpperCase();
  const container = document.getElementById('chargement-container');
  container.innerHTML = "";
  let html = "";

  if (cie === "FR" || cie === "RK") {
    html += `
      <div class="cp-row cp-cols-3">
        <div class="form-group-3col"><label>ADULT<input type="number" id="ADULT" oninput="updateTOB()"></label></div>
        <div class="form-group-3col"><label>CHILD<input type="number" id="CHILD" oninput="updateTOB()"></label></div>
        <div class="form-group-3col"><label>INFANT<input type="number" id="INFANT" oninput="updateTOB()"></label></div>
      </div>
      <div class="cp-row cp-cols-3">
        <div class="form-group-3col"><label>FWD/OA<input type="number" id="FWD" oninput="checkTOBCoherence()"></label></div>
        <div class="form-group-3col"><label>MID/OB<input type="number" id="MID" oninput="checkTOBCoherence()"></label></div>
        <div class="form-group-3col"><label>AFT/OC<input type="number" id="AFT" oninput="checkTOBCoherence()"></label></div>
      </div>
      <div class="cp-row cp-cols-2">
        <div class="form-group-3col"><label>BAGS<input type="number" id="BAGS"></label></div>
        <div class="form-group-3col"><label>ITG<input type="number" id="ITG"></label></div>
      </div>
    `;
  } else {
    html += `
      <div class="cp-row cp-cols-4">
        <div class="form-group-4col"><label>MALE<input type="number" id="MALE" oninput="updateTOB()"></label></div>
        <div class="form-group-4col"><label>FEMALE<input type="number" id="FEMALE" oninput="updateTOB()"></label></div>
        <div class="form-group-4col"><label>CHILD<input type="number" id="CHILD" oninput="updateTOB()"></label></div>
        <div class="form-group-4col"><label>INFANT<input type="number" id="INFANT" oninput="updateTOB()"></label></div>
      </div>
      <div class="cp-row cp-cols-4">
        <div class="form-group-4col"><label>OA<input type="number" id="OA" oninput="checkTOBCoherence()"></label></div>
        <div class="form-group-4col"><label>OB<input type="number" id="OB" oninput="checkTOBCoherence()"></label></div>
        <div class="form-group-4col"><label>OC<input type="number" id="OC" oninput="checkTOBCoherence()"></label></div>
        <div class="form-group-4col"><label>OD<input type="number" id="OD" oninput="checkTOBCoherence()"></label></div>
      </div>
      <div class="cp-row cp-cols-2">
        <div class="form-group-3col"><label>BAGS<input type="number" id="BAGS"></label></div>
        <div class="form-group-3col"><label>POIDS<input type="number" id="POIDS"></label></div>
      </div>
    `;
  }

  html += `
    <div class="cp-row cp-cols-1">
      <div class="form-group" style="flex:1 1 100%;">
        <label>TOB<input type="text" id="TOB" readonly style="font-weight:bold;"></label>
      </div>
    </div>
  `;
  container.innerHTML = html;

  updateTOB();
  updateLIDVisibility();
}

/* Affichage conditionnel LID (FR/RK uniquement) */
function updateLIDVisibility(){
  const cie = (document.getElementById('Cie').value||'').toUpperCase();
  const lid = document.getElementById('lidBlock');
  if(!lid) return;
  lid.style.display = (cie === 'FR' || cie === 'RK') ? '' : 'none';
}

/* TOB + coh√©rence */
function updateTOB() {
  const cie = document.getElementById('Cie').value;
  let mainTotal = 0;
  let infants = parseInt(document.getElementById('INFANT')?.value) || 0;

  if (cie === "FR" || cie === "RK") {
    mainTotal = (parseInt(document.getElementById('ADULT')?.value) || 0) +
                (parseInt(document.getElementById('CHILD')?.value) || 0);
  } else {
    mainTotal = (parseInt(document.getElementById('MALE')?.value) || 0) +
                (parseInt(document.getElementById('FEMALE')?.value) || 0) +
                (parseInt(document.getElementById('CHILD')?.value) || 0);
  }

  let tobText = "";
  if (mainTotal === 0 && infants === 0) tobText = "";
  else if (infants > 0) tobText = `${mainTotal} + ${infants}`;
  else tobText = `${mainTotal}`;

  const tobField = document.getElementById('TOB');
  if (tobField) tobField.value = tobText;

  checkTOBCoherence();
}

/* COH√âRENCE TOB */
function checkTOBCoherence() {
  const cie = (document.getElementById('Cie').value||'').toUpperCase();
  let tobMain = 0;

  if (cie === "FR" || cie === "RK") {
    tobMain = (parseInt(document.getElementById('ADULT')?.value) || 0) +
              (parseInt(document.getElementById('CHILD')?.value) || 0);
    const sum = (parseInt(document.getElementById('FWD')?.value) || 0) +
                (parseInt(document.getElementById('MID')?.value) || 0) +
                (parseInt(document.getElementById('AFT')?.value) || 0);
    styleTOB(sum === tobMain);
  } else {
    tobMain = (parseInt(document.getElementById('MALE')?.value) || 0) +
              (parseInt(document.getElementById('FEMALE')?.value) || 0) +
              (parseInt(document.getElementById('CHILD')?.value) || 0);
    const sum = (parseInt(document.getElementById('OA')?.value) || 0) +
                (parseInt(document.getElementById('OB')?.value) || 0) +
                (parseInt(document.getElementById('OC')?.value) || 0) +
                (parseInt(document.getElementById('OD')?.value) || 0);
    styleTOB(sum === tobMain);
  }
}
function styleTOB(valid) {
  const tobField = document.getElementById('TOB');
  if (!tobField) return;
  if (valid) { tobField.style.border = "1px solid #ccc"; tobField.style.color = "#000"; }
  else { tobField.style.border = "2px solid red"; tobField.style.color = "red"; }
}

/* CALCULS */
function updateAllCalculations() {
  updateTimers();
  updateSOBTDefault();
  updateTOBT();
  updateDLCode();
  redistributeDL();
  updateLID();
  updateCTOTDisplay();
  applyPrestationsDefaults();
  updateLIDVisibility();
  renderTimeline();
}

/* TIMERS HLE/H-15 */
function updateTimers() {
  const sobt = document.getElementById('SOBT').value;
  if (!sobt) {
    ['timer-h40', 'timer-h15', 'timer-h8'].forEach(id => document.getElementById(id).textContent = '--:--');
    return;
  }
  const [hh, mm] = sobt.split(':').map(Number);
  const base = new Date(); base.setHours(hh, mm, 0, 0);
  const h40 = new Date(base.getTime() - 40 * 60000);
  const h15 = new Date(base.getTime() - 15 * 60000);
  document.getElementById('timer-h40').textContent = `${String(h40.getHours()).padStart(2, '0')}:${String(h40.getMinutes()).padStart(2, '0')}`;
  document.getElementById('timer-h15').textContent = `${String(h15.getHours()).padStart(2, '0')}:${String(h15.getMinutes()).padStart(2, '0')}`;
}

/* LID = TOBT - 8 (HORS CTOT) */
function updateLID() {
  const tobtRawMins = window._tobtRawMins;
  const el = document.getElementById('timer-h8');
  if (!el) return;
  if (tobtRawMins == null) { el.textContent = "--:--"; return; }
  const lid = tobtRawMins - 8;
  el.textContent = fmtHHMM(lid);
}

/* SOBT par d√©faut */
function updateSOBTDefault() {
  if (manualSOBT) return;
  const cie = document.getElementById('Cie').value;
  const sibt = document.getElementById('SIBT').value;
  const arrPNT = document.getElementById('ArrPNT')?.value;
  const arrPNC = document.getElementById('ArrPNC')?.value;
  if (!sibt) return;
  if (!(cie === "FR" || cie === "RK" || cie === "W4" || cie === "W6")) return;

  let [sH, sM] = sibt.split(':').map(Number);
  const base = new Date(); base.setHours(sH, sM);
  let add = 35;
  if (cie === "FR" || cie === "RK") add = (arrPNT || arrPNC) ? 35 : 25;
  const sobtCalc = new Date(base.getTime() + add * 60000);
  document.getElementById('SOBT').value = `${String(sobtCalc.getHours()).padStart(2, '0')}:${String(sobtCalc.getMinutes()).padStart(2, '0')}`;
}

/* TOBT + r√®gle CTOT (stocke TOBT brut pour LID) */
function updateTOBT() {
  const cie = document.getElementById('Cie').value;
  const sibttxt = document.getElementById('SIBT').value;
  const aibttxt = document.getElementById('AIBT').value;
  const sobttxt = document.getElementById('SOBT').value;
  const ctottxt = document.getElementById('CTOT').value;

  if (!cie || !sibttxt) {
    document.getElementById('timer-tobt').textContent = '--:--';
    window._tobtRawMins = null; return;
  }

  const [sH, sM] = sibttxt.split(':').map(Number);
  const [aH, aM] = aibttxt ? aibttxt.split(':').map(Number) : [sH, sM];
  const [soH, soM] = sobttxt ? sobttxt.split(':').map(Number) : [sH, sM];

  const SIBT = new Date(); SIBT.setHours(sH, sM, 0, 0);
  const AIBT = new Date(); AIBT.setHours(aH, aM, 0, 0);
  const SOBT = new Date(); SOBT.setHours(soH, soM, 0, 0);

  let TOBT_raw = new Date(SIBT);

  if (cie === 'FR' || cie === 'RK' || cie === 'W4' || cie === 'W6') {
    if (AIBT > SIBT) {
      const arrPNT = document.getElementById('ArrPNT')?.value;
      const arrPNC = document.getElementById('ArrPNC')?.value;
      const add = (arrPNT || arrPNC) ? 35 : 25;
      TOBT_raw = new Date(AIBT.getTime() + add * 60000);
    } else {
      TOBT_raw = new Date(SIBT);
    }
  } else {
    if (AIBT > SIBT) {
      const diff = (SOBT - SIBT) / 60000;
      TOBT_raw = new Date(AIBT.getTime() + diff * 60000);
    } else {
      TOBT_raw = new Date(SIBT);
    }
  }

  if (TOBT_raw < SOBT) TOBT_raw = new Date(SOBT);
  window._tobtRawMins = TOBT_raw.getHours() * 60 + TOBT_raw.getMinutes();

  let TOBT_adj = new Date(TOBT_raw);
  if (ctottxt) {
    const [cH, cM] = ctottxt.split(':').map(Number);
    const CTOT = new Date(); CTOT.setHours(cH, cM, 0, 0);
    const tobtPlus15 = new Date(TOBT_adj.getTime() + 15*60000);
    if (CTOT > tobtPlus15) TOBT_adj = new Date(CTOT.getTime() - 15*60000);
    if (TOBT_adj < SOBT) TOBT_adj = new Date(SOBT);
  }

  document.getElementById('timer-tobt').textContent =
    `${String(TOBT_adj.getHours()).padStart(2, '0')}:${String(TOBT_adj.getMinutes()).padStart(2, '0')}`;
}

/* CTOT (affichage) */
function updateCTOTDisplay(){
  const ctot = document.getElementById('CTOT').value;
  document.getElementById('timer-ctot').textContent = ctot ? ctot : '--:--';
}

/* DL CODES (mapping demand√©) */
function updateDLCode() {
  const cie = (document.getElementById('Cie').value||'').toUpperCase();
  const sibttxt = document.getElementById('SIBT').value;
  const aibttxt = document.getElementById('AIBT').value;
  if (!sibttxt || !aibttxt) return;

  const [sH, sM] = sibttxt.split(':').map(Number);
  const [aH, aM] = aibttxt.split(':').map(Number);
  const SIBT = new Date(); SIBT.setHours(sH, sM);
  const AIBT = new Date(); AIBT.setHours(aH, aM);

  if (AIBT > SIBT) {
    if (cie === 'FR' || cie === 'RK') document.getElementById('DLcode1').value = '93';
    else if (cie === 'W4' || cie === 'W6') document.getElementById('DLcode1').value = '93A';
    else document.getElementById('DLcode1').value = '';

    document.getElementById('DLduree1').value = Math.round((AIBT - SIBT) / 60000) || '';
  } else {
    document.getElementById('DLcode1').value = '';
    document.getElementById('DLduree1').value = '';
  }
}

/* ====== DL DUR√âES ‚Äî r√©partition auto & contr√¥le ====== */
function dldChanged(index){ lastDLChanged = index; redistributeDL(); }

function totalDelayMinutes(){
  const so = document.getElementById('SOBT').value;
  const ao = document.getElementById('AOBT').value;
  if(!so || !ao) return null;
  const s = parseHHMM(so);
  const a = parseHHMM(ao);
  if (s==null || a==null) return null;
  let total = a - s;
  if (total < 0) total += 1440; // overnight
  return total;
}

function redistributeDL(){
  const total = totalDelayMinutes();
  const f1 = document.getElementById('DLduree1');
  const f2 = document.getElementById('DLduree2');
  const f3 = document.getElementById('DLduree3');
  if(!f1 || !f2 || !f3) return;

  let d1 = parseInt(f1.value)||0;
  let d2 = parseInt(f2.value)||0;
  let d3 = parseInt(f3.value)||0;

  if(total==null){
    clearDLBorders();
    return;
  }

  d1 = Math.max(0, Math.min(d1, total));

  if(lastDLChanged === 1){
    let remain = total - d1;
    d2 = Math.min(remain, Math.max(0, d2));
    d2 = Math.min(remain, d2 + (remain - d2));
    remain = total - d1 - d2;
    d3 = Math.max(0, remain);
  } else if (lastDLChanged === 2){
    const maxD2 = Math.max(0, total - d1);
    d2 = Math.max(0, Math.min(d2, maxD2));
    d3 = Math.max(0, total - d1 - d2);
  } else {
    const maxD3 = Math.max(0, total - d1 - d2);
    d3 = Math.max(0, Math.min(d3, maxD3));
  }

  f1.value = d1 || '';
  f2.value = d2 || '';
  f3.value = d3 || '';

  const sum = d1 + d2 + d3;
  if (sum > total){
    markLastFilledDLError();
  } else {
    clearDLBorders();
  }
}

function markLastFilledDLError(){
  clearDLBorders();
  const f1 = document.getElementById('DLduree1');
  const f2 = document.getElementById('DLduree2');
  const f3 = document.getElementById('DLduree3');
  const d1 = parseInt(f1.value)||0;
  const d2 = parseInt(f2.value)||0;
  const d3 = parseInt(f3.value)||0;
  if (d3 > 0) f3.classList.add('dl-error');
  else if (d2 > 0) f2.classList.add('dl-error');
  else if (d1 > 0) f1.classList.add('dl-error');
}

function clearDLBorders(){
  ['DLduree1','DLduree2','DLduree3'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.classList.remove('dl-error');
  });
}

/* PRESTATIONS AUTO */
function applyPrestationsDefaults() {
  const from = (document.getElementById('From').value||'').toUpperCase();
  const to = (document.getElementById('To').value||'').toUpperCase();

  if (from === "BVA") {
    document.getElementById('Ordures').value = "N";
    document.getElementById('EauPotable').value = "Y";
    document.getElementById('MenageAssist').value = "N";
  }
  if (to === "BVA") {
    document.getElementById('Ordures').value = "Y";
    document.getElementById('Vidange').value = "Y";
    document.getElementById('MenageAtalian').value = "T";
  }
}

/* UTILITAIRES */
function setNow(fieldId) {
  const now = new Date();
  const hh = isUTC ? now.getUTCHours() : now.getHours();
  const mm = isUTC ? now.getUTCMinutes() : now.getMinutes();
  document.getElementById(fieldId).value = `${String(hh).padStart(2, '0')}:${String(mm).padStart(2, '0')}`;
}

function adjustTime(fieldId, delta) {
  const input = document.getElementById(fieldId);
  if (!input.value) return;
  let [hh, mm] = input.value.split(':').map(Number);
  let total = hh * 60 + mm + delta;
  if (total < 0) total += 1440;
  if (total >= 1440) total -= 1440;
  hh = Math.floor(total / 60);
  mm = total % 60;
  input.value = `${String(hh).padStart(2, '0')}:${String(mm).padStart(2, '0')}`;
}

/* Switches */
function setDarkMode(enable, fromInit=false){
  const currentlyDark = document.body.classList.contains('dark');
  if (enable && !currentlyDark) document.body.classList.add('dark');
  if (!enable && currentlyDark) document.body.classList.remove('dark');
  document.getElementById('darkToggle').checked = enable;
  localStorage.setItem('modeDark', enable ? '1' : '0');

  adaptNotepadThemeColors(enable, fromInit);
}

function setTimeModeUTC(enable, fromInit=false){
  const offsetHours = -new Date().getTimezoneOffset() / 60;

  if (!fromInit && enable !== isUTC) {
    const inputs = document.querySelectorAll('input[type="time"]');
    inputs.forEach(input => {
      if (!input.value) return;
      let [hh, mm] = input.value.split(':').map(Number);
      let newH = enable ? hh - offsetHours : hh + offsetHours;
      let totalMin = Math.round(newH * 60 + mm);
      totalMin = ((totalMin % 1440) + 1440) % 1440;
      const outH = Math.floor(totalMin / 60);
      const outM = totalMin % 60;
      input.value = `${String(outH).padStart(2, '0')}:${String(outM).padStart(2, '0')}`;
    });
  }
  isUTC = enable;
  document.getElementById('utcToggle').checked = enable;
  localStorage.setItem('modeUTC', enable ? '1' : '0');
  updateAllCalculations();
}

/* POPUP */
function showPopup(message, color = "#2196f3", duration = 2000) {
  const popup = document.createElement('div');
  popup.id = "popup";
  popup.textContent = message;
  popup.style.background = color;
  document.body.appendChild(popup);
  popup.style.display = "block";
  setTimeout(() => popup.remove(), duration);
}

/* TIMELINE helpers */
let showTimeLabels = true;
let timelineUserScrolled = false;

function parseHHMM(str){
  if(!str || !/^\d{2}:\d{2}$/.test(str)) return null;
  const [h,m] = str.split(':').map(Number);
  return h*60 + m;
}
function fmtHHMM(mins){
  mins = ((mins % 1440) + 1440) % 1440;
  const h = Math.floor(mins/60), m = mins%60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
}
function toExtended(t, min, max){
  const wraps = (max > 1440);
  if (!wraps) return t;
  const startMod = ((min % 1440) + 1440) % 1440;
  return (t < startMod) ? t + 1440 : t;
}

function computeTimelineWindow(allTimes){
  const H40  = parseHHMM((document.getElementById('timer-h40')?.textContent || '').replace('--:--',''));
  const SIBT = parseHHMM(document.getElementById('SIBT')?.value || '');
  const AOBT = parseHHMM(document.getElementById('AOBT')?.value || '');
  const TOBT = parseHHMM((document.getElementById('timer-tobt')?.textContent || '').replace('--:--',''));

  const haveStart = (H40 != null) || (SIBT != null);
  const haveEnd   = (AOBT != null) || (TOBT != null);

  if (haveStart && haveEnd) {
    let startRef = null;
    if (H40 != null && SIBT != null) startRef = (H40 < SIBT) ? H40 : SIBT;
    else startRef = (H40 != null) ? H40 : SIBT;
    let min = startRef - 5;
    let endRef = (AOBT != null ? AOBT : TOBT);
    let max = endRef + 5;

    if (max <= min) max += 1440;
    if (max - min < 30) { min -= 10; max += 10; }
    return {min, max, basis:'(HLE<SIBT?HLE:SIBT) ‚Üí AOBT|TOBT'};
  }

  const SOBT = parseHHMM(document.getElementById('SOBT')?.value || '');
  if (SOBT != null) {
    let startRef = (SIBT != null) ? SIBT : (SOBT - 40);
    let min = startRef - 5;
    let endRef = (AOBT ?? TOBT ?? SOBT);
    let max = endRef + 5;

    if (max <= min) max += 1440;
    if (max - min < 30) { min -= 10; max += 10; }
    return {min, max, basis:'fallback SOBT'};
  }

  if (allTimes && allTimes.length){
    let min = Math.min(...allTimes) - 10;
    let max = Math.max(...allTimes) + 10;
    if (max <= min) max += 1440;
    if (max - min < 30) { min -= 10; max += 10; }
    return {min, max, basis:'data'};
  }

  return {min:0, max:60, basis:'default'};
}
function getPairWindow(idA,idB){
  const a = parseHHMM(document.getElementById(idA)?.value || '');
  const b = parseHHMM(document.getElementById(idB)?.value || '');
  if(a==null || b==null) return null;
  return [Math.min(a,b), Math.max(a,b)];
}
function collectTimelineData(){
  const fixedPoints = [];
  const addPoint = (label, t, cls='tl--std')=>{ if(t==null) return; fixedPoints.push({label, t, cls}); };

  const SIBT = parseHHMM(document.getElementById('SIBT')?.value || '');
  const AIBT = parseHHMM(document.getElementById('AIBT')?.value || '');
  const SOBT = parseHHMM(document.getElementById('SOBT')?.value || '');
  const AOBT = parseHHMM(document.getElementById('AOBT')?.value || '');
  const TOBT = parseHHMM((document.getElementById('timer-tobt')?.textContent || '').replace('--:--',''));
  const CTOT = parseHHMM((document.getElementById('timer-ctot')?.textContent || '').replace('--:--',''));
  const H15  = parseHHMM((document.getElementById('timer-h15')?.textContent || '').replace('--:--',''));
  const H40  = parseHHMM((document.getElementById('timer-h40')?.textContent || '').replace('--:--',''));

  addPoint('SIBT', SIBT, 'tl--std'); addPoint('AIBT', AIBT, 'tl--std');
  addPoint('SOBT', SOBT, 'tl--std'); addPoint('AOBT', AOBT, 'tl--std');
  addPoint('TOBT', TOBT, 'tl--tobt'); addPoint('CTOT', CTOT, 'tl--ctot');
  addPoint('HLE',  H40,  'tl--turn');
  addPoint('H-15', H15,  'tl--turn');

  /* √âv√©nements simples */
  const singles = [
    ['ArrPNT','Arriv√©e PNT'],
    ['ArrPNC','Arriv√©e PNC'],
    ['ArriveeAgentsPMRArr','Arriv√©e agent PMR (Arr)'],
    /* SUPPR: D√©barquement PMR */
    ['ArriveeAgentsPMRDep','Arriv√©e agent PMR (Dep)'],
    /* SUPPR: Embarquement PMR */
    ['ArriveeINAD','Arriv√©e INAD'],
    ['RemiseLID','Remise LID/LDS'],
    /* SUPPR: Mise en place TPX/TMX */
    ['FermeturePorteAvion','Fermeture porte avion'],
  ];
  singles.forEach(([id,label])=>{
    const t = parseHHMM(document.getElementById(id)?.value || '');
    if(t!=null) fixedPoints.push({label, t, cls:'tl--std'});
  });

  /* Paires de dur√©es */
  const rows = [
    {key:'debarq',  label:'D√©barquement',         pair:getPairWindow('PremierDebarque','DernierDebarque'),                 cls:'tl--turn', color:null},
    {key:'emb',     label:'Embarquement',         pair:getPairWindow('AvionPremierEmbarque','AvionDernierEmbarque'),       cls:'tl--ops',  color:null},
    {key:'avit',    label:'Avitair',              pair:getPairWindow('ArriveeFuel','DepartFuel'),                           cls:'tl--std',  color:'#ff9800'},
    {key:'liftArr', label:'Lift (Arr)',           pair:getPairWindow('ArriveeLiftArr','DepartLiftArr'),                     cls:'tl--std',  color:'#8e24aa'},
    {key:'liftDep', label:'Lift (Dep)',           pair:getPairWindow('ArriveeLift','DepartLift'),                           cls:'tl--std',  color:'#2e7d32'},
    /* SUPPR: GPU */
    {key:'bag',     label:'Recherche bagage',     pair:getPairWindow('DebutRechercheBagage','FinRechercheBagage'),         cls:'tl--std',  color:'#9c27b0'},
    {key:'dech',    label:'D√©chargement bagages', pair:getPairWindow('DebutDechargementBagages','FinDechargementBagages'), cls:'tl--std',  color:'#795548'},
    {key:'chg',     label:'Chargement bagages',   pair:getPairWindow('DebutChargementBagages','FinChargementBagages'),     cls:'tl--ops',  color:'#009688'},
  ];

  const durations = rows
    .filter(r=>r.pair!=null)
    .map((r)=>({label:r.label, a:r.pair[0], b:r.pair[1], cls:r.cls, color:r.color}));

  const allTimes = [ ...fixedPoints.map(p=>p.t), ...durations.flatMap(d=>[d.a,d.b]) ];
  const windowInfo = computeTimelineWindow(allTimes);

  return {fixedPoints, durations, windowInfo};
}

/* === AFFICHAGE TIMELINE === */
function renderTimeline(){
  const scroller = document.getElementById('timelineScroll');
  const canvas   = document.getElementById('timelineCanvas');
  if(!scroller || !canvas) return;

  canvas.innerHTML = '';

  const {fixedPoints, durations, windowInfo} = collectTimelineData();
  const {min, max} = windowInfo;
  if(min === undefined) return;

  window._timelineCurrentRange = {min, max};
  const total = Math.max(1, max - min);

  const viewport = scroller.clientWidth || 1200;
  const canvasPx = Math.max(viewport, Math.round(viewport * timelineZoom));
  canvas.style.width = canvasPx + 'px';

  const MIN_HEIGHT = 180;
  const PT_LANE_H  = 36;
  const DUR_LANE_H = 40;
  const TOP_PAD    = 20;
  const AFTER_POINTS = 28;
  const AFTER_TRACK  = 36;
  const BOTTOM_PAD   = 40;

  const lanesEndX = [];
  const pointEls = [];

  fixedPoints.sort((a,b)=>a.t-b.t).forEach(p=>{
    const tExt = toExtended(p.t, min, max);
    const leftPct = 6 + ((tExt-min)/total)*88;

    const el = document.createElement('div');
    el.className = `tl-event ${p.cls}`;
    el.style.left = `${leftPct}%`;
    el.style.top  = `0px`;
    el.style.visibility = 'hidden';

    const dot = document.createElement('div'); dot.className = 'tl-dot';
    const label = document.createElement('div'); label.className='tl-label';
    label.textContent = showTimeLabels ? `${p.label} : ${fmtHHMM(p.t)}` : p.label;
    el.appendChild(dot); el.appendChild(label);
    canvas.appendChild(el);

    const w = Math.max(label.offsetWidth, 12);
    const centerX = (leftPct/100) * canvasPx;
    const startX = centerX - (w/2) - 16;
    const endX   = centerX + (w/2) + 16;

    let lane = 0;
    while(lanesEndX[lane] !== undefined && startX <= lanesEndX[lane]) lane++;
    lanesEndX[lane] = endX;

    pointEls.push({el, lane});
  });

  const pointLaneCount = lanesEndX.length || 0;
  const trackY = TOP_PAD + pointLaneCount*PT_LANE_H + AFTER_POINTS;

  const durItems = durations.map(d=>{
    const aExt = toExtended(d.a, min, max);
    const bExt = toExtended(d.b, min, max);
    return { ...d, start: Math.min(aExt,bExt), end: Math.max(aExt,bExt) };
  }).sort((x,y)=> x.start - y.start);

  const durLanesEnd = [];
  const durWithLane = durItems.map(it=>{
    let lane = 0;
    while(durLanesEnd[lane] !== undefined && it.start <= durLanesEnd[lane]) lane++;
    durLanesEnd[lane] = it.end;
    return { ...it, lane };
  });
  const durLaneCount = durLanesEnd.length || 0;

  const finalHeight = Math.max(
    MIN_HEIGHT,
    trackY + AFTER_TRACK + durLaneCount*DUR_LANE_H + BOTTOM_PAD
  );
  canvas.style.height = `${finalHeight}px`;

  for(let t = Math.ceil(min); t <= Math.floor(max); t++){
    const x = (t-min)/total;
    const leftPct = 6 + x*88;

    const vline = document.createElement('div');
    vline.className = 'timeline-tick';
    vline.style.left = `${leftPct}%`;
    vline.style.top = `${8}px`;
    vline.style.height = `${finalHeight - 36}px`;
    canvas.appendChild(vline);

    if(t % 5 === 0){
      const lbl = document.createElement('div');
      lbl.className = 'timeline-tick-label';
      lbl.textContent = fmtHHMM(t);
      lbl.style.left = `${leftPct}%`;
      lbl.style.top = `${finalHeight - 18}px`;
      canvas.appendChild(lbl);
    }
  }

  const track = document.createElement('div');
  track.className = 'timeline-track';
  track.style.top = `${trackY}px`;
  canvas.appendChild(track);

  pointEls.forEach(({el,lane})=>{
    el.style.top = `${TOP_PAD + lane*PT_LANE_H}px`;
    el.style.visibility = 'visible';
  });

  const downStart = trackY + AFTER_TRACK;
  durWithLane.forEach(d=>{
    const leftStartPct = 6 + ((d.start-min)/total)*88;
    const widthPct     = ((d.end-d.start)/total)*88;

    const bar = document.createElement('div');
    bar.className = `tl-range ${d.cls}`;
    if(d.color){ bar.style.setProperty('--c', d.color); }
    bar.style.left = `${leftStartPct}%`;
    bar.style.width = `${widthPct}%`;
    bar.style.top = `${downStart + d.lane*DUR_LANE_H}px`;
    bar.style.transform = 'translate(-50%, -50%)';
    canvas.appendChild(bar);

    const lab = document.createElement('div');
    lab.className = 'tl-range-label';
    const durMin = Math.max(0, d.b - d.a);
    lab.textContent = showTimeLabels ? `${d.label} : ${durMin} min` : d.label;
    bar.appendChild(lab);
  });

  if(!timelineUserScrolled){
    const centerMin = (min + max) / 2;
    const midX = (centerMin - min) / total;
    const centerLeft = midX * scroller.scrollWidth - scroller.clientWidth / 2;
    scroller.scrollLeft = Math.max(0, centerLeft);
  }

  const lbl = document.getElementById('timelineZoomLabel');
  if(lbl) lbl.textContent = `${Math.round(timelineZoom*100)}%`;
}

(function injectShowHoursToggle(){
  const bar = document.querySelector('.timeline-toolbar');
  if (bar) {
    if (!document.getElementById('showTimesToggle')) {
      const wrap = document.createElement('label');
      wrap.style.display = 'flex';
      wrap.style.alignItems = 'center';
      wrap.style.gap = '6px';
      wrap.style.marginLeft = '8px';
      wrap.style.flexWrap = 'wrap';
      wrap.style.maxWidth = '100%';

      const cb = document.createElement('input');
      cb.type = 'checkbox'; cb.id = 'showTimesToggle'; cb.checked = true; showTimeLabels = true;
      cb.addEventListener('change', () => { showTimeLabels = cb.checked; renderTimeline(); });

      const span = document.createElement('span'); span.textContent = 'Heure sur √©tiquettes';
      wrap.appendChild(cb); wrap.appendChild(span); bar.appendChild(wrap);
    } else {
      const cb = document.getElementById('showTimesToggle'); cb.checked = true; showTimeLabels = true;
      const wrap = cb.closest('label');
      if (wrap) {
        wrap.style.display = 'flex';
        wrap.style.alignItems = 'center';
        wrap.style.gap = '6px';
        wrap.style.marginLeft = '8px';
        wrap.style.flexWrap = 'wrap';
        wrap.style.maxWidth = '100%';
      }
    }
  }
  const scroller = document.getElementById('timelineScroll');
  if (scroller) { ['wheel','mousedown','touchstart','keydown','scroll'].forEach(ev=>{
    scroller.addEventListener(ev, () => { timelineUserScrolled = true; }, {passive:true});
  });}
})();

/* G√©n√©ration dynamique des champs "Num√©ro tag i" */
function updateTagInputs(){
  const nb = parseInt(document.getElementById('NbBagagesDecharges')?.value) || 0;
  const wrap = document.getElementById('TagsContainer');
  if(!wrap) return;

  const count = Math.max(0, Math.min(nb, 50)); // s√©curit√© : max 50
  let html = '';
  for(let i=1; i<=count; i++){
    html += `
      <div class="form-group">
        <label>Num√©ro tag ${i}
          <input type="text" id="TagNumero${i}" inputmode="numeric" pattern="[0-9]*"
                 oninput="sanitizeDigitsOnly(this)">
        </label>
      </div>`;
  }
  wrap.innerHTML = html;

  // R√©injecter les valeurs sauvegard√©es (si pr√©sentes)
  try{
    const data = JSON.parse(localStorage.getItem('tab-'+currentTabId) || '{}');
    for(let i=1; i<=count; i++){
      const f = document.getElementById('TagNumero'+i);
      if(f && data['TagNumero'+i] !== undefined) f.value = data['TagNumero'+i];
    }
  }catch(e){}
}

/* VALIDATION */
function validateForm() {
  const required = ['Date', 'Cie', 'Parking', 'NVol', 'From', 'To', 'Immat', 'RZA'];
  let missing = required.some(id => !document.getElementById(id).value);
  if (missing) showPopup("V√©rifiez les informations manquantes !", "#d32f2f", 4000);
  else showPopup("Validation locale effectu√©e (pas d'envoi).", "#4caf50", 2500);
}

/* SAUVEGARDE MANUELLE */
function manualSave() {
  saveCurrentTabData();
  showPopup("Enregistrement r√©ussi", "#2196f3", 2000);
}

/* RESET */
function clearAutoSave() {
  if (confirm("Tout r√©initialiser ?")) {
    localStorage.clear();
    location.reload();
  }
}

/* ==========================================================
   === BLOC-NOTE (version moderne, avec undo/redo) ===
   ========================================================== */
let noteOpen = false;
let noteTool = 'pen';
let noteColor = NOTE_DEFAULT_LIGHT;
let notePenSize = 3;
let noteEraserSize = 22;
let noteStrokes = [];
let noteIsDrawing = false;
let noteCurrentStroke = null;
let noteCanvas, noteCtx, noteRO;
let noteDrag = {active:false, dx:0, dy:0};
let noteInited = false;
let noteUndoStack = [];
let noteRedoStack = [];
const NOTE_UNDO_LIMIT = 100;

function getThemeDefaultPen(){
  return document.body.classList.contains('dark') ? NOTE_DEFAULT_DARK : NOTE_DEFAULT_LIGHT;
}

function noteStorageKey(){ return currentTabId ? `notepad-${currentTabId}` : 'notepad-default'; }

function toggleNotepadOverlay(){ noteOpen ? closeNotepadOverlay() : openNotepadOverlay(); }
function openNotepadOverlay(){
  const el = document.getElementById('noteOverlay');
  if (!noteInited) initNotepadOnce();
  el.style.display = 'block';
  ensureNoteOverlayInViewport();
  requestAnimationFrame(()=>{ el.classList.add('open'); });
  el.setAttribute('aria-hidden','false');
  noteOpen = true;
  loadNotepad();
  fitNoteCanvas();
  renderNote();
  noteUndoStack = []; noteRedoStack = []; updateUndoRedoBtns();
}
function closeNotepadOverlay(){
  const el = document.getElementById('noteOverlay');
  el.classList.remove('open');
  el.style.display = 'none';
  el.setAttribute('aria-hidden','true');
  noteOpen = false;
}

function ensureNoteOverlayInViewport(){
  const overlay = document.getElementById('noteOverlay');
  if(!overlay) return;
  const margin = 10;
  overlay.style.maxWidth  = `calc(100vw - ${margin*2}px)`;
  overlay.style.maxHeight = `calc(100vh - ${margin*2}px)`;
  const vw = window.innerWidth, vh = window.innerHeight;
  const rect = overlay.getBoundingClientRect();
  let w = Math.min(rect.width,  vw - margin*2);
  let h = Math.min(rect.height, vh - margin*2);
  if (Math.abs(w - rect.width) > 0.5) overlay.style.width  = w + 'px';
  if (Math.abs(h - rect.height) > 0.5) overlay.style.height = h + 'px';
  const rect2 = overlay.getBoundingClientRect();
  w = rect2.width; h = rect2.height;
  let left = Math.min(Math.max(rect2.left,  margin), vw - margin - w);
  let top  = Math.min(Math.max(rect2.top,   margin), vh - margin - h);
  overlay.style.left = left + 'px';
  overlay.style.top  = top  + 'px';
  overlay.style.right = 'auto';
}

function initNotepadOnce(){
  if (noteInited) return; noteInited = true;

  noteCanvas = document.getElementById('noteCanvas');
  noteCtx = noteCanvas.getContext('2d', { willReadFrequently: false });
  noteCtx.lineJoin = 'round'; noteCtx.lineCap  = 'round';

  const dragBar = document.getElementById('noteDragBar');
  const overlay = document.getElementById('noteOverlay');
  dragBar.addEventListener('mousedown', (e)=>{
    overlay.classList.add('dragging');
    noteDrag.active = true;
    const r = overlay.getBoundingClientRect();
    noteDrag.dx = e.clientX - r.left;
    noteDrag.dy = e.clientY - r.top;
    e.preventDefault();
  });
  document.addEventListener('mousemove', ()=>{
    if(!noteDrag.active) return;
  });
  document.addEventListener('mouseup', ()=>{
    if(!noteDrag.active) return;
    noteDrag.active=false;
    overlay.classList.remove('dragging');
    ensureNoteOverlayInViewport();
  });

  noteRO = new ResizeObserver(()=>{ ensureNoteOverlayInViewport(); fitNoteCanvas(); renderNote(); });
  noteRO.observe(overlay);
  noteRO.observe(document.querySelector('.note-canvas-wrap'));
  window.addEventListener('resize', ensureNoteOverlayInViewport);

  noteCanvas.addEventListener('pointerdown', notePointerDown);
  noteCanvas.addEventListener('pointermove', notePointerMove);
  noteCanvas.addEventListener('pointerup',   notePointerUp);
  noteCanvas.addEventListener('pointerleave',notePointerUp);
  noteCanvas.addEventListener('pointercancel',notePointerUp);

  document.addEventListener('keydown', (e)=>{
    if(!noteOpen) return;
    const isMac = navigator.platform.toLowerCase().includes('mac');
    const ctrlOrCmd = isMac ? e.metaKey : e.ctrlKey;
    if (ctrlOrCmd && e.key.toLowerCase() === 'z') { e.preventDefault(); e.shiftKey ? noteRedo() : noteUndo(); }
    else if (ctrlOrCmd && (e.key.toLowerCase() === 'y')) { e.preventDefault(); noteRedo(); }
  });

  updatePenSizeLabel(); updateEraserSizeLabel();

  const defaultDot = document.getElementById('noteColorDotDefault');
  if(defaultDot){
    defaultDot.style.background = getThemeDefaultPen();
    defaultDot.classList.add('selected');
  }
  document.getElementById('noteColorInput').value = rgbToHex(getThemeDefaultPen());
  noteColor = getThemeDefaultPen();
}
function rgbToHex(v){ return v.startsWith('#') ? v : '#111111'; }

function fitNoteCanvas(){
  if(!noteCanvas) return;
  const dpr = window.devicePixelRatio || 1;
  const rect = noteCanvas.getBoundingClientRect();
  noteCanvas.width  = Math.max(1, Math.floor(rect.width  * dpr));
  noteCanvas.height = Math.max(1, Math.floor(rect.height * dpr));
  noteCtx.setTransform(1,0,0,1,0,0);
  noteCtx.scale(dpr, dpr);
  noteCtx.lineJoin = 'round';
  noteCtx.lineCap  = 'round';
}

function setNoteTool(tool){
  noteTool = tool;
  document.getElementById('toolPen').classList.toggle('active', tool==='pen');
  document.getElementById('toolErase').classList.toggle('active', tool==='eraser');
}
function updatePenSizeLabel(){
  const v = parseInt(document.getElementById('penSize').value)||3;
  notePenSize = v;
  document.getElementById('penSizeVal').textContent = v;
}
function updateEraserSizeLabel(){
  const v = parseInt(document.getElementById('eraserSize').value)||22;
  noteEraserSize = v;
  document.getElementById('eraserSizeVal').textContent = v;
}
function pickColor(el, color){
  noteColor = color;
  document.getElementById('noteColorInput').value = color;
  document.querySelectorAll('.note-color').forEach(n=>n.classList.remove('selected'));
  if(el) el.classList.add('selected');
  setNoteTool('pen');
}

function saveNotepad(){
  try{ localStorage.setItem(noteStorageKey(), JSON.stringify(noteStrokes)); }
  catch(e){ showPopup("Sauvegarde du bloc-note impossible (quota localStorage ?)", "#d32f2f", 3000); }
}
function loadNotepad(){
  try{
    const raw = localStorage.getItem(noteStorageKey());
    noteStrokes = raw ? JSON.parse(raw) : [];
  }catch(e){ noteStrokes = []; }
}

function snapshotStrokes(){ return JSON.parse(JSON.stringify(noteStrokes)); }
function pushUndoState(){
  noteUndoStack.push(snapshotStrokes());
  if (noteUndoStack.length > 100) noteUndoStack.shift();
  updateUndoRedoBtns();
}
function clearRedo(){ noteRedoStack = []; updateUndoRedoBtns(); }
function updateUndoRedoBtns(){
  const u = document.getElementById('noteUndoBtn');
  const r = document.getElementById('noteRedoBtn');
  if (u) u.disabled = noteUndoStack.length === 0;
  if (r) r.disabled = noteRedoStack.length === 0;
}

function noteEventPoint(e){ return { x: e.offsetX, y: e.offsetY }; }

function notePointerDown(e){
  e.preventDefault();
  noteCanvas.setPointerCapture(e.pointerId);
  pushUndoState(); clearRedo();

  noteIsDrawing = true;
  const pt = noteEventPoint(e);
  const stroke = { tool: noteTool, color: noteColor, size: (noteTool==='pen' ? notePenSize : noteEraserSize), points: [pt] };
  noteCurrentStroke = stroke;

  noteCtx.save();
  noteCtx.globalCompositeOperation = (stroke.tool==='eraser') ? 'destination-out' : 'source-over';
  noteCtx.strokeStyle = stroke.color; noteCtx.lineWidth = stroke.size;
  noteCtx.beginPath(); noteCtx.moveTo(pt.x, pt.y); noteCtx.lineTo(pt.x+0.01, pt.y+0.01); noteCtx.stroke();
  noteCtx.restore();
}
function notePointerMove(e){
  if(!noteIsDrawing || !noteCurrentStroke) return;
  const pt = noteEventPoint(e);
  const prev = noteCurrentStroke.points[noteCurrentStroke.points.length-1];
  noteCurrentStroke.points.push(pt);

  noteCtx.save();
  noteCtx.globalCompositeOperation = (noteCurrentStroke.tool==='eraser') ? 'destination-out' : 'source-over';
  noteCtx.strokeStyle = noteCurrentStroke.color; noteCtx.lineWidth = noteCurrentStroke.size;
  noteCtx.beginPath(); noteCtx.moveTo(prev.x, prev.y); noteCtx.lineTo(pt.x, pt.y); noteCtx.stroke();
  noteCtx.restore();
}
function notePointerUp(){
  if(!noteIsDrawing) return;
  noteIsDrawing = false;
  if(noteCurrentStroke && noteCurrentStroke.points.length>0){
    noteStrokes.push(noteCurrentStroke);
    saveNotepad(); renderNote(); updateUndoRedoBtns();
  }
  noteCurrentStroke = null;
}

function renderNote(){
  if(!noteCtx || !noteCanvas) return;
  noteCtx.save();
  noteCtx.setTransform(1,0,0,1,0,0);
  noteCtx.clearRect(0,0,noteCanvas.width, noteCanvas.height);
  noteCtx.restore();

  for(const s of noteStrokes){
    noteCtx.globalCompositeOperation = (s.tool==='eraser') ? 'destination-out' : 'source-over';
    noteCtx.strokeStyle = s.color || getThemeDefaultPen();
    noteCtx.lineWidth = s.size || 3;
    if(!s.points || s.points.length===0) continue;
    noteCtx.beginPath();
    noteCtx.moveTo(s.points[0].x, s.points[0].y);
    for(let i=1;i<s.points.length;i++){ const p = s.points[i]; noteCtx.lineTo(p.x, p.y); }
    noteCtx.stroke();
  }
}

function noteUndo(){
  if (noteUndoStack.length === 0) return;
  noteRedoStack.push(snapshotStrokes());
  noteStrokes = noteUndoStack.pop();
  saveNotepad(); renderNote(); updateUndoRedoBtns();
}
function noteRedo(){
  if (noteRedoStack.length === 0) return;
  noteUndoStack.push(snapshotStrokes());
  noteStrokes = noteRedoStack.pop();
  saveNotepad(); renderNote(); updateUndoRedoBtns();
}

function noteClearAll(){
  if(!confirm('Effacer tous les traits de ce bloc-note ?')) return;
  pushUndoState();
  noteStrokes = []; clearRedo(); saveNotepad(); renderNote();
}

/* === Adaptation bloc-note au th√®me === */
function adaptNotepadThemeColors(dark, fromInit){
  const newDefault = dark ? NOTE_DEFAULT_DARK : NOTE_DEFAULT_LIGHT;
  const defaultDot = document.getElementById('noteColorDotDefault');
  if (defaultDot) {
    defaultDot.style.background = newDefault;
    document.querySelectorAll('.note-color').forEach(n=>n.classList.remove('selected'));
    defaultDot.classList.add('selected');
  }
  noteColor = newDefault;
  const colorInput = document.getElementById('noteColorInput');
  if (colorInput) colorInput.value = newDefault;

  try{
    const key = noteStorageKey();
    const raw = localStorage.getItem(key);
    let strokes = raw ? JSON.parse(raw) : [];
    let changed = false;
    for(const s of strokes){
      if(s.tool !== 'eraser' && s.color !== newDefault){
        s.color = newDefault;
        changed = true;
      }
    }
    if(changed){
      localStorage.setItem(key, JSON.stringify(strokes));
    }
    if(noteOpen){
      noteStrokes = strokes;
      fitNoteCanvas();
      renderNote();
    }
  }catch(e){}
}

/* Maintien bloc-note lors du switch d‚Äôonglet */
const _switchTabOrig = switchTab;
switchTab = function(id){
  _switchTabOrig(id);
  if(noteOpen){
    loadNotepad(); noteUndoStack = []; noteRedoStack = [];
    fitNoteCanvas(); renderNote(); updateUndoRedoBtns();
    ensureNoteOverlayInViewport();
  }
};
</script>
</body>
</html>
