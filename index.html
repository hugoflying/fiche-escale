<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SUIVI PERFORMANCE</title>
<style>
/* RESET & BASE */
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
    font-family: Arial, sans-serif;
    background: #f8f9fa;
    color: #222;
    padding: 10px;
}
body.dark { background: #121212; color: #f8f9fa; }

h1 { text-align: center; margin: 10px 0 15px; }

/* Sections */
section {
    background: #fff;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 15px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}
body.dark section { background: #1e1e1e; }

h2 {
    font-size: 1.2rem;
    margin-bottom: 10px;
    border-bottom: 1px solid #ccc;
    padding-bottom: 5px;
    text-align: center;
}

/* Grilles */
.form-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
.form-group { flex: 1 1 calc(50% - 10px); min-width: 150px; margin-bottom: 10px; text-align:center; }
.form-group-3col { flex: 1 1 calc(33.33% - 10px); min-width: 120px; margin-bottom: 10px; text-align:center; }
.form-group-4col { flex: 1 1 calc(25% - 10px); min-width: 80px; margin-bottom: 10px; text-align:center; }

/* Labels en gras */
.form-group label,
.form-group-3col label,
.form-group-4col label {
    font-size: 0.9rem;
    font-weight: bold;
    display: block;
    margin-bottom: 3px;
    text-align: center;
}

/* Champs */
input, select {
    width: 100%;
    padding: 6px;
    font-size: 0.95rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    text-align: center;
}
textarea {
    width: 100%;
    padding: 6px;
    font-size: 0.95rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    resize: both;
    min-height: 60px;
    text-align: left;
    overflow: auto;
}

/* Champ horaire + boutons : alignement parfait */
.form-group input[type="time"] {
    width: 100%;
    box-sizing: border-box;
    text-align: center;
    display: block;
}

/* Boutons horaires */
.btn-actions {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    width: 100%;
    gap: 5px;
    margin-top: 5px;
}
button.action {
    width: 100%;
    padding: 10px;
    font-size: 0.95rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}
button.minus { background: #555; color: white; }
button.now   { background: #1976d2; color: white; }
button.plus  { background: #555; color: white; }

/* Boutons principaux */
#validate, #save, #reset {
    width: 100%;
    padding: 12px;
    font-size: 1.2rem;
    border: none;
    border-radius: 6px;
    margin-top: 10px;
    cursor: pointer;
}
#validate { background: #4caf50; color: white; }
#save { background: #2196f3; color: white; margin: 15px 0; }
#reset { background: #d32f2f; color: white; }

/* Timers */
.timer-box {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}
.timer {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}
.timer-label { font-weight: bold; font-size: 1rem; }
.timer-value {
    background: #d32f2f;
    color: #fff;
    font-weight: bold;
    padding: 10px 20px;
    border-radius: 6px;
    font-size: 1.1rem;
}
#timer-tobt { background: #2e7d32; }
#timer-h8 { background: orange; }

/* Toggles */
.toggle-container {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
}
.toggle-container button {
    padding: 5px 10px;
    font-size: 0.9rem;
}

/* Majuscules pour INFO VOL */
#Date, #Cie, #NVol, #From, #To, #Immat, #RZA, #Parking, #FNC {
    text-transform: uppercase;
}

/* Onglets */
#tab-bar button {
    border: none;
    cursor: pointer;
    border-radius: 4px;
}
#tab-bar {
    display: flex;
    gap: 5px;
    margin-bottom: 10px;
    flex-wrap: wrap;
}
</style>
</head>
<body onload="initForm()">

<!-- Modes -->
<div class="toggle-container">
    <button onclick="toggleDarkMode()">üåô / ‚òÄÔ∏è</button>
    <button onclick="toggleTimeMode()">Local / UTC</button>
</div>

<!-- Barre d‚Äôonglets -->
<div id="tab-bar">
    <button onclick="createNewTab()" style="padding:5px 10px;">+ Ajouter vol</button>
</div>

<h1>SUIVI PERFORMANCE</h1>

<!-- Timers -->
<div class="timer-box">
    <div class="timer"><div class="timer-label">H-40</div><div id="timer-h40" class="timer-value">--:--</div></div>
    <div class="timer"><div class="timer-label">H-15</div><div id="timer-h15" class="timer-value">--:--</div></div>
    <div class="timer"><div class="timer-label">LID</div><div id="timer-h8" class="timer-value">--:--</div></div>
    <div class="timer"><div class="timer-label">TOBT</div><div id="timer-tobt" class="timer-value">--:--</div></div>
</div>

<!-- INFO VOL -->
<section>
    <h2>INFO VOL</h2>
    <div class="form-grid">
        <div class="form-group" style="flex:1 1 100%;"><label>Date<input type="date" id="Date"></label></div>
        <div class="form-group"><label>Cie
            <select id="Cie" onchange="updateAllCalculations(); generateChargementFields();">
                <option value="">--</option>
                <option>FR</option><option>RK</option><option>W4</option><option>W6</option>
                <option>H4</option><option>H6</option><option>U5</option><option>U7</option>
                <option>V7</option><option>Autre</option>
            </select>
        </label></div>
        <div class="form-group"><label>N¬∞ Vol<input type="text" id="NVol"></label></div>

        <div class="form-group"><label>Provenance<input type="text" id="From" maxlength="3"></label></div>
        <div class="form-group"><label>Destination<input type="text" id="To" maxlength="3"></label></div>

        <div class="form-group"><label>Immat<input type="text" id="Immat" maxlength="5"></label></div>
        <div class="form-group"><label>Parking
            <select id="Parking">
                <option value="">--</option>
                <option>1</option><option>2</option><option>3</option><option>4</option>
                <option>5</option><option>6</option><option>7</option><option>8</option>
                <option>9</option><option>10</option><option>11</option><option>12</option>
            </select>
        </label></div>

        <div class="form-group"><label>RZA<input type="text" id="RZA" maxlength="3"></label></div>
        <div class="form-group"><label>FNC
            <select id="FNC">
                <option>Y</option><option selected>N</option>
            </select>
        </label></div>
    </div>
</section>

<!-- HORAIRES -->
<section>
    <h2>HORAIRES</h2>
    <div class="form-grid">
        <div class="form-group">
            <label>SIBT<input type="time" id="SIBT" onchange="updateAllCalculations()"></label>
            <div class="btn-actions">
                <button class="action minus" onclick="adjustTime('SIBT',-1);updateAllCalculations()">-1</button>
                <button class="action now" onclick="setNow('SIBT');updateAllCalculations()">Now</button>
                <button class="action plus" onclick="adjustTime('SIBT',1);updateAllCalculations()">+1</button>
            </div>
        </div>
        <div class="form-group">
            <label>AIBT<input type="time" id="AIBT" onchange="updateAllCalculations()"></label>
            <div class="btn-actions">
                <button class="action minus" onclick="adjustTime('AIBT',-1);updateAllCalculations()">-1</button>
                <button class="action now" onclick="setNow('AIBT');updateAllCalculations()">Now</button>
                <button class="action plus" onclick="adjustTime('AIBT',1);updateAllCalculations()">+1</button>
            </div>
        </div>
        <div class="form-group">
            <label>SOBT<input type="time" id="SOBT" onchange="manualSOBT=true;updateAllCalculations()"></label>
            <div class="btn-actions">
                <button class="action minus" onclick="adjustTime('SOBT',-1);manualSOBT=true;updateAllCalculations()">-1</button>
                <button class="action now" onclick="setNow('SOBT');manualSOBT=true;updateAllCalculations()">Now</button>
                <button class="action plus" onclick="adjustTime('SOBT',1);manualSOBT=true;updateAllCalculations()">+1</button>
            </div>
        </div>
        <div class="form-group">
            <label>AOBT<input type="time" id="AOBT" onchange="updateAllCalculations()"></label>
            <div class="btn-actions">
                <button class="action minus" onclick="adjustTime('AOBT',-1);updateAllCalculations()">-1</button>
                <button class="action now" onclick="setNow('AOBT');updateAllCalculations()">Now</button>
                <button class="action plus" onclick="adjustTime('AOBT',1);updateAllCalculations()">+1</button>
            </div>
        </div>
    </div>
</section>

<!-- SAUVEGARDER apr√®s HORAIRES -->
<button id="save" onclick="manualSave()">SAUVEGARDER</button>

<!-- TIMING -->
<section>
    <h2>TIMING</h2>
    <div class="form-grid" id="timing-grid"></div>
</section>

<!-- SAUVEGARDER apr√®s TIMING -->
<button id="save" onclick="manualSave()">SAUVEGARDER</button>

<!-- RETARDS -->
<section>
    <h2>RETARDS (D√©part)</h2>
    <div class="form-grid">
        <div class="form-group"><label>DL Code 1<input type="text" id="DLcode1"></label></div>
        <div class="form-group"><label>DL Dur√©e 1 (min)<input type="number" id="DLduree1" oninput="updateDLDuree2()"></label></div>
        <div class="form-group"><label>DL Code 2<input type="text" id="DLcode2"></label></div>
        <div class="form-group"><label>DL Dur√©e 2 (min)<input type="number" id="DLduree2" oninput="updateDLDuree3()"></label></div>
        <div class="form-group"><label>DL Code 3<input type="text" id="DLcode3"></label></div>
        <div class="form-group"><label>DL Dur√©e 3 (min)<input type="number" id="DLduree3"></label></div>
    </div>
</section>

<!-- DL JUSTIFICATION -->
<section>
    <h2>DL JUSTIFICATIONS</h2>
    <textarea id="DLJustif"></textarea>
</section>

<!-- FAITS SAILLANTS -->
<section>
    <h2>FAITS SAILLANTS</h2>
    <textarea id="FaitsSaillants"></textarea>
</section>

<!-- ASSISTANCES -->
<section>
    <h2>ASSISTANCES PRISES EN CHARGE A/D</h2>
    <div class="form-grid">
        <div class="form-group-4col"><label>WCHC<input type="number" id="WCHC"></label></div>
        <div class="form-group-4col"><label>WCHS<input type="number" id="WCHS"></label></div>
        <div class="form-group-4col"><label>WCHR<input type="number" id="WCHR"></label></div>
        <div class="form-group-4col"><label>Autre<input type="number" id="AutreAssist"></label></div>
    </div>
</section>

<!-- PRESTATIONS -->
<section>
    <h2>PRESTATIONS</h2>
    <div class="form-grid">
        <div class="form-group-3col"><label>ASU<select id="ASU"><option>N</option><option>Y</option></select></label></div>
        <div class="form-group-3col"><label>Flux RZA<select id="FluxRZA"><option>N</option><option>Y</option></select></label></div>
        <div class="form-group-3col"><label>Eau potable<select id="EauPotable"><option>N</option><option>Y</option></select></label></div>
        <div class="form-group-3col"><label>Vidange toilettes<select id="Vidange"><option>N</option><option>Y</option></select></label></div>
        <div class="form-group-3col"><label>M√©nage Assist'Air<select id="MenageAssist"><option>N</option><option>Y</option></select></label></div>
        <div class="form-group-3col"><label>M√©nage Atalian<select id="MenageAtalian"><option>N</option><option>T</option><option>F</option></select></label></div>
        <div class="form-group-3col"><label>Collecte d'ordures<select id="Ordures"><option>Y</option><option>N</option></select></label></div>
        <div class="form-group-3col"><label>Toilet Kit<select id="ToiletKit"><option>N</option><option>Y</option></select></label></div>
        <div class="form-group-3col"><label>D√©givrage<select id="Degivrage"><option>N</option><option>Y</option></select></label></div>
        <div class="form-group-3col"><label>Push-Pull<select id="PushPull"><option>N</option><option>Y</option></select></label></div>
        <div class="form-group-3col"><label>Echelle suppl√©mentaire<select id="Echelle"><option>N</option><option>Y</option></select></label></div>
    </div>
</section>

<!-- CHARGEMENT -->
<section>
    <h2>CHARGEMENT</h2>
    <div id="chargement-container" class="form-grid"></div>
</section>

<!-- Boutons finaux -->
<button id="validate" onclick="validateForm()">VALIDER</button>
<button id="save" onclick="manualSave()">SAUVEGARDER</button>
<button id="reset" onclick="clearAutoSave()">R√âINITIALISER</button>

<script>
/* === Variables globales === */
let isUTC = false;
let manualSOBT = false;
let currentTabId = null;

/* === Initialisation g√©n√©rale === */
function initForm() {
    document.getElementById('Date').valueAsDate = new Date();
    generateTimingFields();
    generateChargementFields();
    enableAutoSave();
    setInterval(() => { updateAllCalculations(); saveCurrentTabData(); }, 60000);
}

/* === Gestion des onglets === */
function createNewTab() {
    const newId = Date.now();
    let tabs = JSON.parse(localStorage.getItem('flightTabs') || '[]');
    tabs.push(newId);
    localStorage.setItem('flightTabs', JSON.stringify(tabs));

    currentTabId = newId;
    clearFormFields();
    saveCurrentTabData();
    renderTabs();
    loadTabData(newId);
}

function renderTabs() {
    const tabBar = document.getElementById('tab-bar');
    tabBar.innerHTML = '<button onclick="createNewTab()" style="padding:5px 10px;">+ Ajouter vol</button>';

    let tabs = JSON.parse(localStorage.getItem('flightTabs') || '[]');

    tabs.forEach((id, index) => {
        const data = JSON.parse(localStorage.getItem(`flightData_${id}`) || '{}');
        let label = '';

        if ((data['To'] && data['Parking']) && (data['To'] !== '' || data['Parking'] !== '')) {
            label = `${(data['To'] || '').toUpperCase()}_${(data['Parking'] || '').toUpperCase()}`;
        } else {
            label = `VOL ${index + 1}`;
        }

        const btn = document.createElement('button');
        btn.textContent = label;
        btn.style.padding = '5px 10px';
        btn.style.background = (id === currentTabId) ? '#2196f3' : '#ccc';
        btn.style.color = (id === currentTabId) ? '#fff' : '#000';
        btn.onclick = () => { switchTab(id); };
        btn.ondblclick = () => { deleteTab(id); };

        tabBar.appendChild(btn);
    });
}

function switchTab(id) {
    saveCurrentTabData();
    currentTabId = id;
    loadTabData(id);
    renderTabs();
}

function deleteTab(id) {
    if (!confirm("Voulez-vous vraiment supprimer cet onglet ?")) return;

    let tabs = JSON.parse(localStorage.getItem('flightTabs') || '[]');
    tabs = tabs.filter(tabId => tabId !== id);
    localStorage.setItem('flightTabs', JSON.stringify(tabs));
    localStorage.removeItem(`flightData_${id}`);

    if (currentTabId === id) {
        if (tabs.length > 0) {
            currentTabId = tabs[0];
            loadTabData(currentTabId);
        } else {
            createNewTab();
        }
    }
    renderTabs();
}

function loadTabData(id) {
    const data = JSON.parse(localStorage.getItem(`flightData_${id}`) || '{}');
    const fields = document.querySelectorAll('input, select, textarea');
    fields.forEach(field => {
        if (data[field.id] !== undefined) {
            field.value = data[field.id];
        } else {
            field.value = '';
        }
    });

    document.body.classList.toggle('dark', data.modeDark === '1');
    isUTC = (data.modeUTC === '1');
    if (data['timer-h40']) document.getElementById('timer-h40').textContent = data['timer-h40'];
    if (data['timer-h15']) document.getElementById('timer-h15').textContent = data['timer-h15'];
    if (data['timer-h8']) document.getElementById('timer-h8').textContent = data['timer-h8'];
    if (data['timer-tobt']) document.getElementById('timer-tobt').textContent = data['timer-tobt'];

    updateAllCalculations();
    generateChargementFields();
}

function saveCurrentTabData() {
    if (!currentTabId) return;
    const fields = document.querySelectorAll('input, select, textarea');
    let data = {};
    fields.forEach(field => {
        data[field.id] = field.value;
    });
    data.modeDark = document.body.classList.contains('dark') ? '1' : '0';
    data.modeUTC = isUTC ? '1' : '0';
    data['timer-h40'] = document.getElementById('timer-h40').textContent;
    data['timer-h15'] = document.getElementById('timer-h15').textContent;
    data['timer-h8'] = document.getElementById('timer-h8').textContent;
    data['timer-tobt'] = document.getElementById('timer-tobt').textContent;

    localStorage.setItem(`flightData_${currentTabId}`, JSON.stringify(data));
}

function manualSave() {
    saveCurrentTabData();
    alert("Donn√©es sauvegard√©es !");
}

function clearFormFields() {
    const fields = document.querySelectorAll('input, select, textarea');
    fields.forEach(field => {
        if (field.type === 'select-one') field.selectedIndex = 0;
        else field.value = '';
    });
    document.body.classList.remove('dark');
    isUTC = false;
}

function initTabs() {
    let tabs = JSON.parse(localStorage.getItem('flightTabs') || '[]');
    if (tabs.length === 0) {
        createNewTab();
    } else {
        currentTabId = tabs[0];
        renderTabs();
        loadTabData(currentTabId);
    }
}

document.getElementById('To').addEventListener('input', renderTabs);
document.getElementById('Parking').addEventListener('change', renderTabs);

window.addEventListener('load', initTabs);

/* === Fonctions CHARGEMENT === */
function generateChargementFields() {
    const cie = document.getElementById('Cie').value;
    const container = document.getElementById('chargement-container');
    container.innerHTML = '';

    if (cie === 'FR' || cie === 'RK') {
        container.innerHTML += `
            <div class="form-group-3col"><label>ADULT<input type="number" id="ADULT" oninput="updateTOB()"></label></div>
            <div class="form-group-3col"><label>CHILD<input type="number" id="CHILD" oninput="updateTOB()"></label></div>
            <div class="form-group-3col"><label>INFANT<input type="number" id="INFANT" oninput="updateTOB()"></label></div>
        `;
    } else {
        container.innerHTML += `
            <div class="form-group-3col"><label>MALE<input type="number" id="MALE" oninput="updateTOB()"></label></div>
            <div class="form-group-3col"><label>FEMALE<input type="number" id="FEMALE" oninput="updateTOB()"></label></div>
            <div class="form-group-3col"><label>CHILD<input type="number" id="CHILD" oninput="updateTOB()"></label></div>
            <div class="form-group-3col"><label>INFANT<input type="number" id="INFANT" oninput="updateTOB()"></label></div>
        `;
    }

    container.innerHTML += `
        <div class="form-group" style="flex:1 1 100%;">
            <label>TOB (calcul auto)<input type="text" id="TOB" readonly></label>
        </div>
    `;

    container.innerHTML += `
        <div class="form-group-3col"><label>OA<input type="number" id="OA"></label></div>
        <div class="form-group-3col"><label>OB<input type="number" id="OB"></label></div>
        <div class="form-group-3col"><label>OC<input type="number" id="OC"></label></div>
        <div class="form-group-3col"><label>OD<input type="number" id="OD"></label></div>
    `;

    if (cie === 'FR' || cie === 'RK') {
        container.innerHTML += `
            <div class="form-group-3col"><label>BAGS<input type="number" id="BAGS"></label></div>
            <div class="form-group-3col"><label>ITG<input type="number" id="ITG"></label></div>
            <div class="form-group-3col"><label>H1<input type="number" id="H1"></label></div>
            <div class="form-group-3col"><label>H2<input type="number" id="H2"></label></div>
            <div class="form-group-3col"><label>H3<input type="number" id="H3"></label></div>
            <div class="form-group-3col"><label>H4<input type="number" id="H4"></label></div>
        `;
    } else {
        container.innerHTML += `
            <div class="form-group-3col"><label>BAGS<input type="number" id="BAGS"></label></div>
            <div class="form-group-3col"><label>POIDS<input type="number" id="POIDS"></label></div>
            <div class="form-group-3col"><label>GB<input type="number" id="GB"></label></div>
            <div class="form-group-3col"><label>CP1<input type="number" id="CP1"></label></div>
            <div class="form-group-3col"><label>CP2<input type="number" id="CP2"></label></div>
            <div class="form-group-3col"><label>CP3<input type="number" id="CP3"></label></div>
            <div class="form-group-3col"><label>CP4<input type="number" id="CP4"></label></div>
            <div class="form-group-3col"><label>CP5<input type="number" id="CP5"></label></div>
        `;
    }

    enableAutoSave();
}

function updateTOB() {
    const cie = document.getElementById('Cie').value;

    let tob1 = 0; 
    let tob2 = 0; 

    if (cie === 'FR' || cie === 'RK') {
        const adult = parseInt(document.getElementById('ADULT')?.value) || 0;
        const child = parseInt(document.getElementById('CHILD')?.value) || 0;
        const infant = parseInt(document.getElementById('INFANT')?.value) || 0;
        tob1 = adult + child;
        tob2 = infant;
    } else {
        const male = parseInt(document.getElementById('MALE')?.value) || 0;
        const female = parseInt(document.getElementById('FEMALE')?.value) || 0;
        const child = parseInt(document.getElementById('CHILD')?.value) || 0;
        const infant = parseInt(document.getElementById('INFANT')?.value) || 0;
        tob1 = male + female + child;
        tob2 = infant;
    }

    document.getElementById('TOB').value = `${tob1} + ${tob2}`;
}

/* === Fonctions d'origine (timers, calculs, etc.) === */
function generateTimingFields() {
    const timings = [
        "ArrPNT","ArrPNC","PremierDebarque","DernierDebarque",
        "AvionPremierEmbarque","AvionDernierEmbarque",
        "PortePremierEmbarque","PorteDernierEmbarque",
        "ArriveeFuel","DepartFuel",
        "ArriveeLift","DepartLift",
        "RemiseLID","FermeturePorteAvion"
    ];
    const labels = [
        "Arriv√©e PNT avion","Arriv√©e PNC avion","Premier d√©barqu√©","Dernier d√©barqu√©",
        "Avion : Premier embarqu√©","Avion : Dernier embarqu√©",
        "Porte : Premier embarqu√©","Porte : Dernier embarqu√©",
        "Arriv√©e Fuel","D√©part Fuel",
        "Arriv√©e Lift","D√©part Lift",
        "Remise LID/LDS","Fermeture porte avion"
    ];
    const container = document.getElementById('timing-grid');
    container.innerHTML = "";
    timings.forEach((id,i)=>{
        const div = document.createElement('div');
        div.className = 'form-group';
        div.innerHTML = `
            <label>${labels[i]}<input type="time" id="${id}" onchange="updateAllCalculations()"></label>
            <div class="btn-actions">
                <button class="action minus" onclick="adjustTime('${id}',-1);updateAllCalculations()">-1</button>
                <button class="action now" onclick="setNow('${id}');updateAllCalculations()">Now</button>
                <button class="action plus" onclick="adjustTime('${id}',1);updateAllCalculations()">+1</button>
            </div>
        `;
        container.appendChild(div);
    });
    enableAutoSave();
}

function enableAutoSave() {
    const fields = document.querySelectorAll('input, select, textarea');
    fields.forEach(field => {
        field.addEventListener('input', saveCurrentTabData);
        field.addEventListener('change', saveCurrentTabData);
    });
}

/* Fonctions calculs */
function updateAllCalculations() {
    updateTimers();
    updateSOBTDefault();
    updateTOBT();
    updateDLCode();
    updateDLDuree2();
    updateLID();
}

function updateTimers() {
    const sobt = document.getElementById('SOBT').value;
    if (!sobt) {
        ['timer-h40','timer-h15','timer-h8'].forEach(id=>document.getElementById(id).textContent='--:--');
        return;
    }
    const [hh, mm] = sobt.split(':').map(Number);
    const base = new Date();
    base.setHours(hh);
    base.setMinutes(mm);
    const h40 = new Date(base.getTime() - 40*60000);
    const h15 = new Date(base.getTime() - 15*60000);
    const h8 = new Date(base.getTime() - 8*60000);
    document.getElementById('timer-h40').textContent = `${String(h40.getHours()).padStart(2,'0')}:${String(h40.getMinutes()).padStart(2,'0')}`;
    document.getElementById('timer-h15').textContent = `${String(h15.getHours()).padStart(2,'0')}:${String(h15.getMinutes()).padStart(2,'0')}`;
}

function updateLID() {
    const cie = document.getElementById('Cie').value;
    const tobt = document.getElementById('timer-tobt').textContent;
    if ((cie === "FR" || cie === "RK") && tobt !== "--:--") {
        let [hh, mm] = tobt.split(':').map(Number);
        const d = new Date();
        d.setHours(hh);
        d.setMinutes(mm - 8);
        document.getElementById('timer-h8').textContent =
            `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    } else {
        document.getElementById('timer-h8').textContent = "--:--";
    }
}

function updateSOBTDefault() {
    if (manualSOBT) return;
    const cie = document.getElementById('Cie').value;
    const sibt = document.getElementById('SIBT').value;
    const arrPNT = document.getElementById('ArrPNT')?.value;
    const arrPNC = document.getElementById('ArrPNC')?.value;
    if ((cie !== 'FR' && cie !== 'RK' && cie !== 'W4' && cie !== 'W6') || !sibt) return;
    let [sH, sM] = sibt.split(':').map(Number);
    const base = new Date();
    base.setHours(sH, sM);
    const add = (cie === 'W4' || cie === 'W6') ? 35 : (arrPNT || arrPNC) ? 35 : 25;
    const sobtCalc = new Date(base.getTime() + add * 60000);
    document.getElementById('SOBT').value =
        `${String(sobtCalc.getHours()).padStart(2,'0')}:${String(sobtCalc.getMinutes()).padStart(2,'0')}`;
}

function updateTOBT() {
    const cie = document.getElementById('Cie').value;
    const sibttxt = document.getElementById('SIBT').value;
    const aibttxt = document.getElementById('AIBT').value;
    const sobttxt = document.getElementById('SOBT').value;
    if (!cie || !sibttxt) {
        document.getElementById('timer-tobt').textContent = '--:--';
        return;
    }
    const [sH,sM] = sibttxt.split(':').map(Number);
    const [aH,aM] = aibttxt ? aibttxt.split(':').map(Number) : [sH,sM];
    const [soH,soM] = sobttxt ? sobttxt.split(':').map(Number) : [sH,sM];
    const SIBT = new Date(); SIBT.setHours(sH, sM);
    const AIBT = new Date(); AIBT.setHours(aH, aM);
    const SOBT = new Date(); SOBT.setHours(soH, soM);
    let TOBT = new Date(SIBT);
    if (cie === 'FR') {
        if (AIBT > SIBT) {
            const arrPNT = document.getElementById('ArrPNT').value;
            const arrPNC = document.getElementById('ArrPNC').value;
            const add = (arrPNT || arrPNC) ? 35 : 25;
            TOBT = new Date(AIBT.getTime() + add*60000);
        } else {
            TOBT = new Date(SIBT);
        }
    } else {
        if (AIBT > SIBT) {
            const diff = (SOBT - SIBT) / 60000;
            TOBT = new Date(AIBT.getTime() + diff*60000);
        } else {
            TOBT = new Date(SIBT);
        }
    }
    if (TOBT < SOBT) TOBT = SOBT;
    document.getElementById('timer-tobt').textContent =
        `${String(TOBT.getHours()).padStart(2,'0')}:${String(TOBT.getMinutes()).padStart(2,'0')}`;
}

function updateDLCode() {
    const cie = document.getElementById('Cie').value;
    const sibttxt = document.getElementById('SIBT').value;
    const aibttxt = document.getElementById('AIBT').value;
    if (!cie || !sibttxt || !aibttxt) return;
    const [sH,sM] = sibttxt.split(':').map(Number);
    const [aH,aM] = aibttxt.split(':').map(Number);
    const SIBT = new Date(); SIBT.setHours(sH,sM);
    const AIBT = new Date(); AIBT.setHours(aH,aM);
    if (AIBT > SIBT) {
        if (cie === 'FR') document.getElementById('DLcode1').value = '93';
        else if (cie === 'W4' || cie === 'W6') document.getElementById('DLcode1').value = '93A';
        else document.getElementById('DLcode1').value = '';
        document.getElementById('DLduree1').value = Math.round((AIBT - SIBT)/60000);
    } else {
        document.getElementById('DLcode1').value = '';
        document.getElementById('DLduree1').value = '';
    }
}

/* DL Dur√©e 2 = (AOBT - SOBT) - DL Dur√©e 1 */
function updateDLDuree2() {
    const sobt = document.getElementById('SOBT').value;
    const aobt = document.getElementById('AOBT').value;
    const dlduree1 = parseInt(document.getElementById('DLduree1').value) || 0;

    if (sobt && aobt) {
        const [soH, soM] = sobt.split(':').map(Number);
        const [aoH, aoM] = aobt.split(':').map(Number);

        const SOBT = new Date(); SOBT.setHours(soH, soM);
        const AOBT = new Date(); AOBT.setHours(aoH, aoM);

        const diff = Math.round((AOBT - SOBT) / 60000) - dlduree1;
        document.getElementById('DLduree2').value = diff >= 0 ? diff : 0;
        updateDLDuree3();
    } else {
        document.getElementById('DLduree2').value = '';
    }
}

/* Si on modifie DL Dur√©e 2, recalculer DL Dur√©e 3 */
function updateDLDuree3() {
    const sobt = document.getElementById('SOBT').value;
    const aobt = document.getElementById('AOBT').value;
    const dlduree1 = parseInt(document.getElementById('DLduree1').value) || 0;
    const dlduree2 = parseInt(document.getElementById('DLduree2').value) || 0;

    if (sobt && aobt) {
        const [soH, soM] = sobt.split(':').map(Number);
        const [aoH, aoM] = aobt.split(':').map(Number);

        const SOBT = new Date(); SOBT.setHours(soH, soM);
        const AOBT = new Date(); AOBT.setHours(aoH, aoM);

        const total = Math.round((AOBT - SOBT) / 60000);
        const reste = total - dlduree1 - dlduree2;
        document.getElementById('DLduree3').value = reste >= 0 ? reste : 0;
    }
}

function validateForm() {
    const required = ['Date','Cie','Parking','NVol','From','To','Immat','RZA'];
    for (let id of required) {
        if (!document.getElementById(id).value) {
            alert("Veuillez remplir tous les champs obligatoires.");
            return;
        }
    }
    alert("Formulaire valide et pr√™t √† √™tre envoy√© !");
}

/* Utilitaires */
function toggleDarkMode() {
    document.body.classList.toggle('dark');
    saveCurrentTabData();
}

function toggleTimeMode() {
    const inputs = document.querySelectorAll('input[type="time"]');
    inputs.forEach(input => {
        if (!input.value) return;
        let [hh, mm] = input.value.split(':').map(Number);
        hh = isUTC ? hh + 2 : hh - 2;
        if (hh < 0) hh += 24;
        if (hh >= 24) hh -= 24;
        input.value = `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;
    });
    isUTC = !isUTC;
    saveCurrentTabData();
    updateAllCalculations();
}

function setNow(fieldId) {
    const now = new Date();
    const hh = isUTC ? now.getUTCHours() : now.getHours();
    const mm = isUTC ? now.getUTCMinutes() : now.getMinutes();
    document.getElementById(fieldId).value = `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;
}

function adjustTime(fieldId, delta) {
    const input = document.getElementById(fieldId);
    if (!input.value) return;
    let [hh, mm] = input.value.split(':').map(Number);
    let total = hh * 60 + mm + delta;
    if (total < 0) total += 1440;
    if (total >= 1440) total -= 1440;
    hh = Math.floor(total / 60);
    mm = total % 60;
    input.value = `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;
}

function clearAutoSave() {
    localStorage.clear();
    location.reload();
}
</script>

</body>
</html>
