<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SUIVI PERFORMANCE</title>
<style>
/* RESET & BASE */
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
    font-family: Arial, sans-serif;
    background: #f8f9fa;
    color: #222;
    padding: 10px;
}
body.dark { background: #121212; color: #f8f9fa; }

h1 { text-align: center; margin: 10px 0 15px; }

/* Sections */
section {
    background: #fff;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 15px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}
body.dark section { background: #1e1e1e; }

h2 {
    font-size: 1.2rem;
    margin-bottom: 10px;
    border-bottom: 1px solid #ccc;
    padding-bottom: 5px;
    text-align: center;
    cursor: pointer;
}

/* Collapse */
section.collapsed > *:not(h2) { display: none; }

/* Grilles */
.form-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
.form-group { flex: 1 1 calc(50% - 10px); min-width: 150px; margin-bottom: 10px; text-align:center; }
.form-group-3col { flex: 1 1 calc(33.33% - 10px); min-width: 120px; margin-bottom: 10px; text-align:center; }
.form-group-4col { flex: 1 1 calc(25% - 10px); min-width: 80px; margin-bottom: 10px; text-align:center; }

/* Labels en gras */
.form-group label,
.form-group-3col label,
.form-group-4col label {
    font-size: 0.9rem;
    font-weight: bold;
    display: block;
    margin-bottom: 3px;
    text-align: center;
}

/* Champs */
input, select {
    width: 100%;
    padding: 6px;
    font-size: 0.95rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    text-align: center;
}
textarea {
    width: 100%;
    padding: 6px;
    font-size: 0.95rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    resize: both;
    min-height: 60px;
    text-align: left;
    overflow: auto;
}

/* Champ horaire + boutons : alignement parfait */
.form-group input[type="time"] {
    width: 100%;
    box-sizing: border-box;
    text-align: center;
    display: block;
}

/* Boutons horaires */
.btn-actions {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    width: 100%;
    gap: 5px;
    margin-top: 5px;
}
button.action {
    width: 100%;
    padding: 10px;
    font-size: 0.95rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}
button.minus { background: #555; color: white; }
button.now   { background: #1976d2; color: white; }
button.plus  { background: #555; color: white; }

/* Boutons principaux */
#validate, #save, #reset {
    width: 100%;
    padding: 12px;
    font-size: 1.2rem;
    border: none;
    border-radius: 6px;
    margin-top: 10px;
    cursor: pointer;
}
#validate { background: #4caf50; color: white; }
#save { background: #2196f3; color: white; margin: 15px 0; }
#reset { background: #d32f2f; color: white; }

/* Timers */
.timer-box {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}
.timer {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}
.timer-label { font-weight: bold; font-size: 1rem; }
.timer-value {
    background: #d32f2f;
    color: #fff;
    font-weight: bold;
    padding: 10px 20px;
    border-radius: 6px;
    font-size: 1.1rem;
}
#timer-tobt { background: #2e7d32; }
#timer-h8 { background: orange; }

/* Toggles (barre du haut) */
.toggle-container {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 10px;
}
.toggle-group {
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Interrupteurs */
.switch {
    position: relative;
    display: inline-block;
    width: 60px;   /* même taille pour les deux */
    height: 28px;
}
.switch input { opacity: 0; width: 0; height: 0; }
.slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background: #cfd4da;
    transition: .2s;
    border-radius: 999px;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.2);
}
.slider:before {
    position: absolute;
    content: "";
    height: 22px; width: 22px;
    left: 3px; top: 3px;
    background: #fff;
    transition: .2s;
    border-radius: 50%;
    box-shadow: 0 1px 2px rgba(0,0,0,.3);
}
.switch input:checked + .slider { background: #1976d2; }
.switch input:checked + .slider:before { transform: translateX(32px); }

/* Légendes des interrupteurs */
.toggle-caption {
    font-size: .9rem;
    user-select: none;
}

/* Indicateur de mode à droite */
#timeModeLabel {
    margin-left: auto;              /* pousse complètement à droite */
    font-weight: bold;
    color: #1976d2;
}

/* Onglets */
#tab-bar button {
    border: none;
    cursor: pointer;
    border-radius: 4px;
    font-size: 1.1rem;
    padding: 10px 18px;
}
#tab-bar {
    display: flex;
    gap: 5px;
    margin-bottom: 10px;
    flex-wrap: wrap;
    position: sticky;
    top: 0;
    background: #f8f9fa;
    z-index: 10;
    padding: 5px 0;
    z-index: 999;
}
body.dark #tab-bar { background: #121212; }
#tab-bar button:first-child {
    font-weight: bold;
    font-size: 1.2rem;
    background: #4caf50;
    color: #fff;
}

/* Popup notifications */
#popup {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    padding: 12px 20px;
    border-radius: 6px;
    font-size: 1rem;
    color: #fff;
    display: none;
    z-index: 1000;
}
#popup.success { background: #4caf50; }
#popup.error { background: #d32f2f; }
#popup.info { background: #2196f3; }
}

/* === BLOC-NOTE FLOTTANT (fenêtre dédiée) === */
#penFab {
    position: fixed;
    bottom: 18px;
    right: 18px;
    width: 64px;
    height: 64px;
    border-radius: 18px;
    background: #ffffff;
    color: #333;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 10px 22px rgba(0,0,0,.25), 0 2px 6px rgba(0,0,0,.15) inset;
    cursor: grab;
    z-index: 2000;
    user-select: none;
}
#penFab.hidden { display:none; }
#penFab:active { cursor: grabbing; }
#penFab svg { width: 36px; height: 36px; }

/* Fenêtre du bloc-note */
#noteWindow {
    position: fixed;
    left: 50%;
    top: 12%;
    transform: translateX(-50%);
    width: min(92vw, 900px);
    height: min(70vh, 640px);
    background: rgba(255,255,255,0.92);
    backdrop-filter: blur(2px);
    border-radius: 18px;
    box-shadow: 0 18px 40px rgba(0,0,0,.35);
    display: none; /* masqué par défaut */
    z-index: 2100;
    overflow: hidden;
}

/* Barre de titre/drag */
#noteHeader {
    height: 52px;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 10px;
    background: rgba(240,240,240,0.95);
    border-bottom: 1px solid rgba(0,0,0,.08);
    cursor: move; /* zone draggable */
}

/* Boutons header */
.noteBtn {
    border: none;
    background: #fff;
    border-radius: 10px;
    padding: 6px 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,.15);
    cursor: pointer;
    font-weight: 600;
}
.noteBtn:hover { opacity: .95; }
.noteBtn.danger { background: #ffebee; }
.noteBtn.primary { background: #e3f2fd; }

/* Outils */
#tools {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-left: auto;
}
#tools label {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: .9rem;
}
#tools input[type="range"] { width: 110px; }

/* Zone canvas */
#noteBody {
    position: absolute;
    inset: 52px 0 0 0;
    display: flex;
    flex-direction: column;
    padding: 8px;
}
#noteCanvas {
    flex: 1;
    border-radius: 12px;
    background: repeating-linear-gradient(
        to bottom,
        rgba(0,0,0,0.02),
        rgba(0,0,0,0.02) 32px,
        rgba(0,0,0,0.06) 33px
    );
    box-shadow: inset 0 1px 3px rgba(0,0,0,.15);
    touch-action: none; /* indispensable pour stylet */
}

/* petite bulle d’aide positionnée à côté du fab quand réactivé */
#fabHint {
    position: fixed;
    bottom: 92px;
    right: 18px;
    background: #333;
    color: #fff;
    font-size: .85rem;
    padding: 6px 8px;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,.35);
    display: none;
    z-index: 2001;
}
#fabHint.show { display:block; }
</style>
</head>
<body onload="initForm()">

<!-- Modes -->
<div class="toggle-container">
    <!-- Switch Jour/Nuit -->
    <div class="toggle-group">
        <span class="toggle-caption">Jour / Nuit</span>
        <label class="switch" title="Basculer Jour/Nuit">
            <input type="checkbox" id="darkToggle" onchange="setDarkMode(this.checked)">
            <span class="slider"></span>
        </label>
    </div>

    <!-- Switch Local / UTC -->
    <div class="toggle-group">
        <span class="toggle-caption">Local / UTC</span>
        <label class="switch" title="Basculer Local/UTC">
            <input type="checkbox" id="utcToggle" onchange="setTimeModeUTC(this.checked)">
            <span class="slider"></span>
        </label>
    </div>

    <!-- Indicateur aligné à droite -->
    <span id="timeModeLabel">Mode : Local</span>
</div>

<!-- Barre d’onglets -->
<div id="tab-bar">
    <button onclick="createNewTab()" style="padding:8px 15px;">+ Ajouter vol</button>
</div>

<h1>SUIVI PERFORMANCE</h1>

<!-- Timers -->
<div class="timer-box">
    <div class="timer"><div class="timer-label">H-40</div><div id="timer-h40" class="timer-value">--:--</div></div>
    <div class="timer"><div class="timer-label">H-15</div><div id="timer-h15" class="timer-value">--:--</div></div>
    <div class="timer"><div class="timer-label">LID</div><div id="timer-h8" class="timer-value">--:--</div></div>
    <div class="timer"><div class="timer-label">TOBT</div><div id="timer-tobt" class="timer-value">--:--</div></div>
</div>

<!-- INFO VOL -->
<section>
    <h2>INFO VOL</h2>
    <div class="form-grid">
        <div class="form-group" style="flex:1 1 100%;"><label>Date<input type="date" id="Date"></label></div>
        <div class="form-group"><label>Cie
            <select id="Cie" onchange="updateAllCalculations(); generateChargementFields();">
                <option value="">--</option>
                <option>FR</option><option>RK</option><option>W4</option><option>W6</option>
                <option>H4</option><option>H6</option><option>U5</option><option>U7</option>
                <option>V7</option><option>Autre</option>
            </select>
        </label></div>
        <div class="form-group"><label>N° Vol<input type="text" id="NVol"></label></div>

        <div class="form-group"><label>Provenance<input type="text" id="From" maxlength="3"></label></div>
        <div class="form-group"><label>Destination<input type="text" id="To" maxlength="3"></label></div>

        <div class="form-group"><label>Immat<input type="text" id="Immat" maxlength="5"></label></div>
        <div class="form-group"><label>Parking
            <select id="Parking">
                <option value="">--</option>
                <option>1</option><option>2</option><option>3</option><option>4</option>
                <option>5</option><option>6</option><option>7</option><option>8</option>
                <option>9</option><option>10</option><option>11</option><option>12</option>
            </select>
        </label></div>

        <div class="form-group"><label>RZA<input type="text" id="RZA" maxlength="3"></label></div>
        <div class="form-group"><label>FNC
            <select id="FNC">
                <option>Y</option><option selected>N</option>
            </select>
        </label></div>
    </div>
</section>

<!-- HORAIRES -->
<section>
    <h2>HORAIRES</h2>
    <div class="form-grid">
        <div class="form-group">
            <label>SIBT<input type="time" id="SIBT" onchange="updateAllCalculations()"></label>
            <div class="btn-actions">
                <button class="action minus" onclick="adjustTime('SIBT',-1);updateAllCalculations()">-1</button>
                <button class="action now" onclick="setNow('SIBT');updateAllCalculations()">Now</button>
                <button class="action plus" onclick="adjustTime('SIBT',1);updateAllCalculations()">+1</button>
            </div>
        </div>
        <div class="form-group">
            <label>AIBT<input type="time" id="AIBT" onchange="updateAllCalculations()"></label>
            <div class="btn-actions">
                <button class="action minus" onclick="adjustTime('AIBT',-1);updateAllCalculations()">-1</button>
                <button class="action now" onclick="setNow('AIBT');updateAllCalculations()">Now</button>
                <button class="action plus" onclick="adjustTime('AIBT',1);updateAllCalculations()">+1</button>
            </div>
        </div>
        <div class="form-group">
            <label>SOBT<input type="time" id="SOBT" onchange="manualSOBT=true;updateAllCalculations()"></label>
            <div class="btn-actions">
                <button class="action minus" onclick="adjustTime('SOBT',-1);manualSOBT=true;updateAllCalculations()">-1</button>
                <button class="action now" onclick="setNow('SOBT');manualSOBT=true;updateAllCalculations()">Now</button>
                <button class="action plus" onclick="adjustTime('SOBT',1);manualSOBT=true;updateAllCalculations()">+1</button>
            </div>
        </div>
        <div class="form-group">
            <label>AOBT<input type="time" id="AOBT" onchange="updateAllCalculations()"></label>
            <div class="btn-actions">
                <button class="action minus" onclick="adjustTime('AOBT',-1);updateAllCalculations()">-1</button>
                <button class="action now" onclick="setNow('AOBT');updateAllCalculations()">Now</button>
                <button class="action plus" onclick="adjustTime('AOBT',1);updateAllCalculations()">+1</button>
            </div>
        </div>
    </div>
</section>

<!-- TIMING -->
<section>
    <h2>TIMING</h2>
    <div class="form-grid" id="timing-grid"></div>
</section>

<!-- CHARGEMENT -->
<section>
    <h2>CHARGEMENT</h2>
    <div id="chargement-container" class="form-grid"></div>
</section>

<!-- RETARDS -->
<section>
    <h2>RETARDS (Départ)</h2>
    <div class="form-grid">
        <div class="form-group"><label>DL Code 1<input type="text" id="DLcode1"></label></div>
        <div class="form-group"><label>DL Durée 1 (min)<input type="number" id="DLduree1" oninput="updateDLDuree2()"></label></div>
        <div class="form-group"><label>DL Code 2<input type="text" id="DLcode2"></label></div>
        <div class="form-group"><label>DL Durée 2 (min)<input type="number" id="DLduree2" oninput="updateDLDuree3()"></label></div>
        <div class="form-group"><label>DL Code 3<input type="text" id="DLcode3"></label></div>
        <div class="form-group"><label>DL Durée 3 (min)<input type="number" id="DLduree3"></label></div>
    </div>
</section>

<!-- DL JUSTIFICATION -->
<section>
    <h2>DL JUSTIFICATIONS</h2>
    <textarea id="DLJustif"></textarea>
</section>

<!-- FAITS SAILLANTS -->
<section>
    <h2>FAITS SAILLANTS</h2>
    <textarea id="FaitsSaillants"></textarea>
</section>

<!-- ASSISTANCES -->
<section>
    <h2>ASSISTANCES PRISES EN CHARGE A/D</h2>
    <div class="form-grid">
        <div class="form-group-4col"><label>WCHC<input type="number" id="WCHC"></label></div>
        <div class="form-group-4col"><label>WCHS<input type="number" id="WCHS"></label></div>
        <div class="form-group-4col"><label>WCHR<input type="number" id="WCHR"></label></div>
        <div class="form-group-4col"><label>Autre<input type="number" id="AutreAssist"></label></div>
    </div>
</section>

<!-- PRESTATIONS -->
<section>
    <h2>PRESTATIONS</h2>
    <div class="form-grid">
        <div class="form-group-3col"><label>ASU<select id="ASU"><option>N</option><option>Y</option></select></label></div>
        <div class="form-group-3col"><label>Flux RZA<select id="FluxRZA"><option>N</option><option>Y</option></select></label></div>
        <div class="form-group-3col"><label>Eau potable<select id="EauPotable"><option>N</option><option>Y</option></select></label></div>
        <div class="form-group-3col"><label>Vidange toilettes<select id="Vidange"><option>N</option><option>Y</option></select></label></div>
        <div class="form-group-3col"><label>Ménage Assist'Air<select id="MenageAssist"><option>N</option><option>Y</option></select></label></div>
        <div class="form-group-3col"><label>Ménage Atalian<select id="MenageAtalian"><option>N</option><option>T</option><option>F</option></select></label></div>
        <div class="form-group-3col"><label>Collecte d'ordures<select id="Ordures"><option>Y</option><option>N</option></select></label></div>
        <div class="form-group-3col"><label>Toilet Kit<select id="ToiletKit"><option>N</option><option>Y</option></select></label></div>
        <div class="form-group-3col"><label>Dégivrage<select id="Degivrage"><option>N</option><option>Y</option></select></label></div>
        <div class="form-group-3col"><label>Push-Pull<select id="PushPull"><option>N</option><option>Y</option></select></label></div>
        <div class="form-group-3col"><label>Echelle supplémentaire<select id="Echelle"><option>N</option><option>Y</option></select></label></div>
    </div>
</section>

<!-- Boutons finaux -->
<button id="validate" onclick="validateForm()">VALIDER</button>
<button id="save" onclick="manualSave()">SAUVEGARDER</button>
<button id="reset" onclick="clearAutoSave()">RÉINITIALISER TOUT</button>

<!-- === BLOC-NOTE FLOTTANT === -->
<div id="penFab" title="Bloc-note (stylet)" role="button">
    <!-- Icône style bloc-note (SVG) -->
    <svg viewBox="0 0 64 64" aria-hidden="true">
        <rect x="6" y="6" rx="14" ry="14" width="52" height="52" fill="#ffffff" />
        <rect x="16" y="16" rx="10" ry="10" width="32" height="12" fill="#ffe38a"/>
        <rect x="16" y="34" width="32" height="3" rx="2" fill="#c9c9c9"/>
        <rect x="16" y="40" width="26" height="3" rx="2" fill="#c9c9c9"/>
        <rect x="16" y="46" width="20" height="3" rx="2" fill="#c9c9c9"/>
        <rect x="6" y="6" rx="14" ry="14" width="52" height="52" fill="none" stroke="rgba(0,0,0,.1)"/>
    </svg>
</div>
<div id="fabHint">Touchez pour ouvrir le bloc-note</div>

<!-- Fenêtre du bloc-note -->
<div id="noteWindow" aria-hidden="true">
    <div id="noteHeader">
        <span style="font-weight:700; padding:0 6px;">Bloc-note</span>
        <button id="closeNote" class="noteBtn">Replier</button>
        <button id="toggleFab" class="noteBtn primary" title="Afficher/Masquer le bouton flottant">Bouton flottant</button>
        <button id="clearNote" class="noteBtn danger" title="Effacer toutes les notes">Effacer</button>

        <div id="tools">
            <label>Couleur <input type="color" id="penColor" value="#ffcc00"></label>
            <label>Épaisseur
                <input type="range" id="penSize" min="1" max="20" value="4">
                <span id="penSizeVal">4</span>
            </label>
            <button id="eraserToggle" class="noteBtn">Gomme</button>
            <label>Taille gomme
                <input type="range" id="eraserSize" min="5" max="40" value="18">
                <span id="eraserSizeVal">18</span>
            </label>
        </div>
    </div>
    <div id="noteBody">
        <canvas id="noteCanvas"></canvas>
    </div>
</div>

<script>
/* === CODE JS COMPLET === */

/* Variables */
let isUTC=false;
let manualSOBT=false;
let currentTabId=null;
const circledNums=["","①","②","③","④","⑤","⑥","⑦","⑧","⑨","⑩","⑪","⑫"];
let saveTimer=null;

/* ========== BLOC-NOTE (fenêtre dédiée, pas sur la page) ========== */
let fabEnabled = true;                 // visibilité du bouton flottant
let fabPos = { bottom: 18, right: 18 };// position du bouton
let winPos = { left: null, top: null };// position fenêtre si déplacée
let winSize = { w: null, h: null };    // taille fenêtre si redimensionnée (optionnel)
let strokes = [];                      // [{color,size,erase,eSize,points:[{x,y,p}]}]
let drawing = false;
let erasing = false;
let currentStroke = null;
let canvas, ctx, noteWindow, noteHeader;
let dpr = Math.max(1, window.devicePixelRatio || 1);

function initNotebook(){
    canvas = document.getElementById('noteCanvas');
    ctx = canvas.getContext('2d');
    noteWindow = document.getElementById('noteWindow');
    noteHeader = document.getElementById('noteHeader');
    resizeCanvasToWindow();

    // UI refs
    const fab = document.getElementById('penFab');
    const penColor = document.getElementById('penColor');
    const penSize = document.getElementById('penSize');
    const penSizeVal = document.getElementById('penSizeVal');
    const eraserToggle = document.getElementById('eraserToggle');
    const eraserSize = document.getElementById('eraserSize');
    const eraserSizeVal = document.getElementById('eraserSizeVal');
    const clearBtn = document.getElementById('clearNote');
    const closeBtn = document.getElementById('closeNote');
    const toggleFab = document.getElementById('toggleFab');

    penSize.addEventListener('input', ()=> penSizeVal.textContent = penSize.value);
    eraserSize.addEventListener('input', ()=> eraserSizeVal.textContent = eraserSize.value);

    // Ouvrir fenêtre
    fab.addEventListener('click', openNotebook);

    // Drag FAB
    makeFabDraggable(fab);

    // Header drag (déplacer la fenêtre)
    makeWindowDraggable(noteWindow, noteHeader);

    // Replier fenêtre
    closeBtn.addEventListener('click', closeNotebook);

    // Afficher/Masquer le fab
    toggleFab.addEventListener('click', ()=>{
        fabEnabled = !fabEnabled;
        updateFabVisibility();
        if (fabEnabled) showFabHint();
        saveNotebookState();
    });

    // Gomme
    eraserToggle.addEventListener('click', ()=>{
        erasing = !erasing;
        eraserToggle.classList.toggle('primary', erasing);
    });

    // Effacer tout
    clearBtn.addEventListener('click', ()=>{
        if (!strokes.length) return;
        if (!confirm('Effacer toutes les notes ?')) return;
        strokes = [];
        redrawAll();
        persistStrokes();
    });

    // Canvas events
    canvas.addEventListener('pointerdown', onPointerDown, {passive:false});
    canvas.addEventListener('pointermove', onPointerMove, {passive:false});
    canvas.addEventListener('pointerup', onPointerUp, {passive:false});
    canvas.addEventListener('pointercancel', onPointerUp, {passive:false});
    canvas.addEventListener('pointerleave', onPointerUp, {passive:false});

    // Resize
    window.addEventListener('resize', ()=>{ resizeCanvasToWindow(); redrawAll(); });

    // Charger état global FAB + fenêtre
    const globalFab = JSON.parse(localStorage.getItem('notesFabState') || '{}');
    if (globalFab && typeof globalFab.enabled === 'boolean') fabEnabled = globalFab.enabled;
    if (globalFab && globalFab.pos){ fabPos = globalFab.pos; applyFabPosition(); }
    if (globalFab && globalFab.win){
        if (typeof globalFab.win.left === 'number') { winPos.left = globalFab.win.left; }
        if (typeof globalFab.win.top === 'number')  { winPos.top  = globalFab.win.top; }
        if (typeof globalFab.win.w === 'number')    { winSize.w   = globalFab.win.w; }
        if (typeof globalFab.win.h === 'number')    { winSize.h   = globalFab.win.h; }
        applyWindowGeometry();
    }
    updateFabVisibility();
}

function makeFabDraggable(fab){
    let dragging = false;
    let startX=0, startY=0, startLeft=0, startTop=0;

    const onPointerDown = (e)=>{
        dragging = true;
        fab.setPointerCapture(e.pointerId);
        const rect = fab.getBoundingClientRect();
        startX = e.clientX;
        startY = e.clientY;
        startLeft = rect.left;
        startTop = rect.top;
        e.preventDefault();
    };
    const onPointerMove = (e)=>{
        if(!dragging) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        let newLeft = startLeft + dx;
        let newTop  = startTop + dy;

        // Contrainte dans la fenêtre
        const vw = window.innerWidth, vh = window.innerHeight;
        const w = fab.offsetWidth, h = fab.offsetHeight;
        newLeft = Math.min(Math.max(0, newLeft), vw - w);
        newTop  = Math.min(Math.max(0, newTop), vh - h);

        // Appliquer via left/top (on neutralise bottom/right)
        fab.style.left = newLeft + 'px';
        fab.style.top  = newTop  + 'px';
        fab.style.right = 'auto';
        fab.style.bottom = 'auto';
    };
    const onPointerUp = (e)=>{
        if(!dragging) return;
        dragging = false;
        fab.releasePointerCapture(e.pointerId);
        const rect = fab.getBoundingClientRect();
        const br = {
            right: Math.max(0, window.innerWidth - rect.right),
            bottom: Math.max(0, window.innerHeight - rect.bottom)
        };
        fabPos = br;
        saveNotebookState();
    };

    fab.addEventListener('pointerdown', onPointerDown);
    fab.addEventListener('pointermove', onPointerMove);
    fab.addEventListener('pointerup', onPointerUp);
    fab.addEventListener('pointercancel', onPointerUp);
}

function openNotebook(){
    noteWindow.style.display = 'block';
    noteWindow.setAttribute('aria-hidden','false');
    resizeCanvasToWindow();
    redrawAll();
}

function closeNotebook(){
    noteWindow.style.display = 'none';
    noteWindow.setAttribute('aria-hidden','true');
}

function applyWindowGeometry(){
    if (winSize.w) noteWindow.style.width  = winSize.w + 'px';
    if (winSize.h) noteWindow.style.height = winSize.h + 'px';
    if (typeof winPos.left === 'number' && typeof winPos.top === 'number'){
        noteWindow.style.left = winPos.left + 'px';
        noteWindow.style.top  = winPos.top + 'px';
        noteWindow.style.transform = 'none';
    }
    setTimeout(resizeCanvasToWindow, 0);
}

function makeWindowDraggable(win, handle){
    let dragging=false, sx=0, sy=0, sl=0, st=0;

    const onDown = (e)=>{
        dragging = true;
        handle.setPointerCapture(e.pointerId);
        const rect = win.getBoundingClientRect();
        sx = e.clientX; sy = e.clientY;
        sl = rect.left; st = rect.top;
        e.preventDefault();
    };
    const onMove = (e)=>{
        if(!dragging) return;
        let nl = sl + (e.clientX - sx);
        let nt = st + (e.clientY - sy);
        // bornes
        const vw = window.innerWidth, vh = window.innerHeight;
        const w = win.offsetWidth, h = win.offsetHeight;
        nl = Math.min(Math.max(0, nl), vw - w);
        nt = Math.min(Math.max(0, nt), vh - h);
        win.style.left = nl + 'px';
        win.style.top  = nt + 'px';
        win.style.transform = 'none';
    };
    const onUp = (e)=>{
        if(!dragging) return;
        dragging=false;
        handle.releasePointerCapture(e.pointerId);
        const rect = win.getBoundingClientRect();
        winPos.left = rect.left;
        winPos.top  = rect.top;
        saveNotebookState();
    };

    handle.addEventListener('pointerdown', onDown);
    handle.addEventListener('pointermove', onMove);
    handle.addEventListener('pointerup', onUp);
    handle.addEventListener('pointercancel', onUp);
}

function applyFabPosition(){
    const fab = document.getElementById('penFab');
    fab.style.right = fabPos.right + 'px';
    fab.style.bottom = fabPos.bottom + 'px';
    fab.style.left = 'auto';
    fab.style.top  = 'auto';
}

function updateFabVisibility(){
    const fab = document.getElementById('penFab');
    fab.classList.toggle('hidden', !fabEnabled);
}

function showFabHint(){
    const hint = document.getElementById('fabHint');
    hint.classList.add('show');
    setTimeout(()=> hint.classList.remove('show'), 2200);
}

function resizeCanvasToWindow(){
    const body = document.getElementById('noteBody');
    const w = body.clientWidth;
    const h = body.clientHeight;
    const wasTransform = ctx.getTransform ? ctx.getTransform() : null;

    canvas.width  = Math.max(1, Math.floor(w * dpr));
    canvas.height = Math.max(1, Math.floor(h * dpr));
    canvas.style.width  = w + 'px';
    canvas.style.height = h + 'px';

    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
}

function getCurrentTool(){
    const color = document.getElementById('penColor').value;
    const size = parseInt(document.getElementById('penSize').value, 10);
    const eSize = parseInt(document.getElementById('eraserSize').value, 10);
    return { color, size, eSize, erase: erasing };
}

function onPointerDown(e){
    if (e.button !== 0) return;
    drawing = true;
    const tool = getCurrentTool();
    currentStroke = { color: tool.color, size: tool.size, erase: tool.erase, eSize: tool.eSize, points: [] };
    const pt = canvasPoint(e);
    currentStroke.points.push(pt);
    drawSegment(currentStroke);
    e.preventDefault();
}

function onPointerMove(e){
    if (!drawing) return;
    const pt = canvasPoint(e);
    currentStroke.points.push(pt);
    drawSegment(currentStroke, true);
    e.preventDefault();
}

function onPointerUp(e){
    if (!drawing) return;
    drawing = false;
    if (currentStroke && currentStroke.points.length > 0) {
        strokes.push(currentStroke);
        persistStrokes();
    }
    currentStroke = null;
    e.preventDefault();
}

function canvasPoint(e){
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX - rect.left);
    const y = (e.clientY - rect.top);
    const p = (typeof e.pressure === 'number' && e.pressure > 0) ? e.pressure : 1;
    return { x, y, p };
}

function drawSegment(stroke){
    const toolSize = stroke.erase ? stroke.eSize : stroke.size;
    ctx.globalCompositeOperation = stroke.erase ? 'destination-out' : 'source-over';
    ctx.strokeStyle = stroke.color;
    ctx.lineWidth = toolSize;

    const pts = stroke.points;
    const n = pts.length;
    if (n < 2) {
        ctx.beginPath();
        ctx.arc(pts[0].x, pts[0].y, toolSize/2, 0, Math.PI*2);
        if (stroke.erase) {
            const prev = ctx.globalCompositeOperation;
            ctx.globalCompositeOperation = 'destination-out';
            ctx.fill();
            ctx.globalCompositeOperation = prev;
        } else {
            ctx.fillStyle = stroke.color;
            ctx.fill();
        }
        return;
    }
    ctx.beginPath();
    const a = pts[n-2], b = pts[n-1];
    ctx.moveTo(a.x, a.y);
    ctx.lineTo(b.x, b.y);
    ctx.stroke();
}

function redrawAll(){
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';

    for (const s of strokes) {
        if (!s.points || s.points.length === 0) continue;
        for (let i=1;i<s.points.length;i++){
            const seg = { ...s, points:[s.points[i-1], s.points[i]] };
            drawSegment(seg, true);
        }
    }
}

/* Persistance des traits par onglet */
function notesKey(){
    return currentTabId ? `notes-${currentTabId}` : 'notes-0';
}
function persistStrokes(){
    try {
        localStorage.setItem(notesKey(), JSON.stringify(strokes));
    } catch (e) {
        console.warn('Sauvegarde notes échouée', e);
    }
}
function loadStrokesForTab(){
    try {
        const raw = localStorage.getItem(notesKey());
        strokes = raw ? JSON.parse(raw) : [];
    } catch (e) {
        strokes = [];
    }
    redrawAll();
}

/* Sauvegarde état global (fab + fenêtre) */
function saveNotebookState(){
    const rect = noteWindow.getBoundingClientRect();
    const state = {
        enabled: fabEnabled,
        pos: fabPos,
        win: {
            left: (noteWindow.style.display==='block' || rect.left)? rect.left : winPos.left,
            top:  (noteWindow.style.display==='block' || rect.top)?  rect.top  : winPos.top,
            w: rect.width,
            h: rect.height
        }
    };
    localStorage.setItem('notesFabState', JSON.stringify(state));
}

/* INIT */
function initForm(){
    renderTabs();
    let lastTab=localStorage.getItem('lastTabId');
    let tabs=JSON.parse(localStorage.getItem('flightTabs')||'[]');
    if(tabs.length===0) createNewTab();
    else if(lastTab && tabs.includes(parseInt(lastTab))) switchTab(parseInt(lastTab));
    else switchTab(tabs[0]);

    generateTimingFields();         // crée les champs TIMING
    generateChargementFields();
    attachAutoSave();               // autosave sur chaque modification
    window.addEventListener('beforeunload', saveCurrentTabData);

    // collapse/expand toggle pour chaque section via clic sur h2
    document.querySelectorAll("section h2").forEach(h2=>{
        h2.onclick=()=>h2.parentElement.classList.toggle("collapsed");
    });

    // Mise à jour instantanée des onglets
    document.getElementById('Parking').onchange = updateTabLabelInstant;
    document.getElementById('To').oninput = updateTabLabelInstant;
    document.getElementById('From').oninput = applyPrestationsDefaults;
    document.getElementById('To').oninput = applyPrestationsDefaults;

    // Appliquer états des switches au chargement
    const storedDark = (localStorage.getItem('modeDark')||'0')==='1';
    const storedUTC  = (localStorage.getItem('modeUTC')||'0')==='1';
    setDarkMode(storedDark, /*fromInit*/true);
    setTimeModeUTC(storedUTC, /*fromInit*/true);

    updateTimeModeLabel();

    // Bloc-note
    initNotebook();

    // Recharger les données du dernier onglet après génération des champs
    if (currentTabId) loadTabData(currentTabId);

    if (fabEnabled) showFabHint();
}

/* Autosave sur modification (déclenché avec un petit debounce) */
function attachAutoSave(){
    const handler=()=>{
        clearTimeout(saveTimer);
        saveTimer=setTimeout(saveCurrentTabData, 300);
    };
    document.addEventListener('input', handler, true);
    document.addEventListener('change', handler, true);
}

/* Tabs */
function renderTabs(){
    const tabBar=document.getElementById('tab-bar');
    tabBar.innerHTML='<button onclick="createNewTab()" style="padding:8px 15px;">+ Ajouter vol</button>';
    let tabs=JSON.parse(localStorage.getItem('flightTabs')||'[]');
    tabs.forEach((id)=>{
        const data=JSON.parse(localStorage.getItem('tab-'+id)||'{}');
        let label=data.To?data.To.toUpperCase():"VOL";
        let parking=data.Parking?circledNums[parseInt(data.Parking)]:"";
        const btn=document.createElement('button');
        btn.textContent=label+" "+parking;
        btn.style.fontWeight=id===currentTabId?'bold':'normal';
        btn.onclick=()=>switchTab(id);
        btn.ondblclick=()=>deleteTab(id);
        tabBar.appendChild(btn);
    });
}

function createNewTab(){
    const newId=Date.now();
    let tabs=JSON.parse(localStorage.getItem('flightTabs')||'[]');
    tabs.push(newId);
    localStorage.setItem('flightTabs',JSON.stringify(tabs));
    clearFormFields();
    currentTabId=newId;
    localStorage.setItem('lastTabId',newId);
    saveCurrentTabData();
    renderTabs();
    loadStrokesForTab(); // notes vierges pour le nouvel onglet
}

function switchTab(id){
    saveCurrentTabData();
    currentTabId=id;
    localStorage.setItem('lastTabId',id);
    loadTabData(id);
    renderTabs();
    // Charger notes de cet onglet
    loadStrokesForTab();
}

function deleteTab(id){
    if(!confirm("Supprimer cet onglet ?")) return;
    let tabs=JSON.parse(localStorage.getItem('flightTabs')||'[]');
    tabs=tabs.filter(t=>t!==id);
    localStorage.setItem('flightTabs',JSON.stringify(tabs));
    localStorage.removeItem('tab-'+id);
    localStorage.removeItem('notes-'+id); // supprimer aussi les notes associées
    if(tabs.length>0) switchTab(tabs[0]);
    else createNewTab();
    renderTabs();
}

function clearFormFields(){
    document.querySelectorAll('input, select, textarea').forEach(el=>{
        if(el.type==='checkbox'||el.type==='radio') el.checked=false;
        else if(el.tagName==='SELECT') el.selectedIndex=0;
        else el.value='';
    });
    document.getElementById('Date').valueAsDate=new Date();
    document.getElementById('FNC').value='N';
    updateAllCalculations();
}

function saveCurrentTabData(){
    if(!currentTabId) return;
    let data={};
    document.querySelectorAll('input, select, textarea').forEach(el=>{
        if(!el.id) return;
        if(el.type==='checkbox') data[el.id]=el.checked ? '1':'0';
        else data[el.id]=el.value;
    });
    // états globaux utiles à la reprise
    data.modeDark=document.body.classList.contains('dark')?'1':'0';
    data.modeUTC=isUTC?'1':'0';
    data.timer_h40=document.getElementById('timer-h40').textContent;
    data.timer_h15=document.getElementById('timer-h15').textContent;
    data.timer_h8=document.getElementById('timer-h8').textContent;
    data.timer_tobt=document.getElementById('timer-tobt').textContent;
    localStorage.setItem('tab-'+currentTabId,JSON.stringify(data));
    localStorage.setItem('lastTabId',currentTabId);
    renderTabs();

    // Sauver état du bloc-note
    saveNotebookState();
}

function loadTabData(id){
    const data=JSON.parse(localStorage.getItem('tab-'+id)||'{}');

    // Remettre toutes les valeurs
    document.querySelectorAll('input, select, textarea').forEach(el=>{
        if(!el.id || data[el.id]===undefined) return;
        if(el.type==='checkbox') el.checked = data[el.id]==='1';
        else el.value = data[el.id];
    });

    // appliquer modes stockés
    if(data.modeDark==='1') document.body.classList.add('dark'); else document.body.classList.remove('dark');
    isUTC=data.modeUTC==='1';

    // timers affichés
    document.getElementById('timer-h40').textContent=data.timer_h40||'--:--';
    document.getElementById('timer-h15').textContent=data.timer_h15||'--:--';
    document.getElementById('timer-h8').textContent=data.timer_h8||'--:--';
    document.getElementById('timer-tobt').textContent=data.timer_tobt||'--:--';

    // synchro UI switches
    document.getElementById('darkToggle').checked = document.body.classList.contains('dark');
    document.getElementById('utcToggle').checked  = isUTC;

    generateChargementFields(); // dépend de Cie
    updateTimeModeLabel();
    updateAllCalculations();

    // Charger notes de l'onglet courant
    loadStrokesForTab();
}

/* Mise à jour instantanée label onglet */
function updateTabLabelInstant(){
    saveCurrentTabData();
    renderTabs();
}

/* TIMING FIELDS */
function generateTimingFields(){
    const timings=[
        "ArrPNT","ArrPNC","PremierDebarque","DernierDebarque",
        "AvionPremierEmbarque","AvionDernierEmbarque",
        "PortePremierEmbarque","PorteDernierEmbarque",
        "ArriveeFuel","DepartFuel","ArriveeLift","DepartLift",
        "RemiseLID","FermeturePorteAvion"
    ];

    const labels=[
        "Arrivée PNT avion","Arrivée PNC avion","Premier débarqué","Dernier débarqué",
        "Avion : Premier embarqué","Avion : Dernier embarqué",
        "Porte : Premier embarqué","Porte : Dernier embarqué",
        "Arrivée Fuel","Départ Fuel","Arrivée Lift","Départ Lift",
        "Remise LID/LDS","Fermeture porte avion"
    ];

    const container=document.getElementById('timing-grid');
    container.innerHTML="";

    timings.forEach((id,i)=>{
        const div=document.createElement('div');
        div.className='form-group';
        div.innerHTML=`
            <label>${labels[i]}<input type="time" id="${id}" onchange="updateAllCalculations()"></label>
            <div class="btn-actions">
                <button class="action minus" onclick="adjustTime('${id}',-1);updateAllCalculations()">-1</button>
                <button class="action now" onclick="setNow('${id}');updateAllCalculations()">Now</button>
                <button class="action plus" onclick="adjustTime('${id}',1);updateAllCalculations()">+1</button>
            </div>`;
        container.appendChild(div);
    });
}

/* === CHARGEMENT / TOB === */
function generateChargementFields() {
    const cie = document.getElementById('Cie').value;
    const container = document.getElementById('chargement-container');
    container.innerHTML = "";

    let html = "";

    if (cie === "FR" || cie === "RK") {
        html += `
            <div class="form-group-4col"><label>ADULT<input type="number" id="ADULT" oninput="updateTOB()"></label></div>
            <div class="form-group-4col"><label>CHILD<input type="number" id="CHILD" oninput="updateTOB()"></label></div>
            <div class="form-group-4col"><label>INFANT<input type="number" id="INFANT" oninput="updateTOB()"></label></div>
            <div class="form-group-3col"><label>FWD<input type="number" id="FWD" oninput="checkTOBCoherence()"></label></div>
            <div class="form-group-3col"><label>MID<input type="number" id="MID" oninput="checkTOBCoherence()"></label></div>
            <div class="form-group-3col"><label>AFT<input type="number" id="AFT" oninput="checkTOBCoherence()"></label></div>
            <div class="form-group-3col"><label>BAGS<input type="number" id="BAGS"></label></div>
            <div class="form-group-3col"><label>ITG<input type="number" id="ITG"></label></div>
        `;
    } else {
        html += `
            <div class="form-group-4col"><label>MALE<input type="number" id="MALE" oninput="updateTOB()"></label></div>
            <div class="form-group-4col"><label>FEMALE<input type="number" id="FEMALE" oninput="updateTOB()"></label></div>
            <div class="form-group-4col"><label>CHILD<input type="number" id="CHILD" oninput="updateTOB()"></label></div>
            <div class="form-group-4col"><label>INFANT<input type="number" id="INFANT" oninput="updateTOB()"></label></div>
            <div class="form-group-4col"><label>OA<input type="number" id="OA" oninput="checkTOBCoherence()"></label></div>
            <div class="form-group-4col"><label>OB<input type="number" id="OB" oninput="checkTOBCoherence()"></label></div>
            <div class="form-group-4col"><label>OC<input type="number" id="OC" oninput="checkTOBCoherence()"></label></div>
            <div class="form-group-4col"><label>OD<input type="number" id="OD" oninput="checkTOBCoherence()"></label></div>
            <div class="form-group-3col"><label>BAGS<input type="number" id="BAGS"></label></div>
            <div class="form-group-3col"><label>POIDS<input type="number" id="POIDS"></label></div>
            <div class="form-group-3col"><label>GB<input type="number" id="GB"></label></div>
        `;
    }

    html += `
        <div class="form-group" style="flex:1 1 100%;">
            <label>TOB<input type="text" id="TOB" readonly style="font-weight:bold;"></label>
        </div>
    `;
    container.innerHTML = html;
    updateTOB();
}

function updateTOB() {
    const cie = document.getElementById('Cie').value;
    let mainTotal = 0;
    let infants = parseInt(document.getElementById('INFANT')?.value) || 0;

    if (cie === "FR" || cie === "RK") {
        mainTotal = (parseInt(document.getElementById('ADULT')?.value) || 0) +
                    (parseInt(document.getElementById('CHILD')?.value) || 0);
    } else {
        mainTotal = (parseInt(document.getElementById('MALE')?.value) || 0) +
                    (parseInt(document.getElementById('FEMALE')?.value) || 0) +
                    (parseInt(document.getElementById('CHILD')?.value) || 0);
    }

    let tobText = "";
    if (mainTotal === 0 && infants === 0) {
        tobText = "";
    } else if (infants > 0) {
        tobText = `${mainTotal} + ${infants}`;
    } else {
        tobText = `${mainTotal}`;
    }

    document.getElementById('TOB').value = tobText;
    checkTOBCoherence();
}

/* === COHÉRENCE TOB === */
function checkTOBCoherence() {
    const cie = document.getElementById('Cie').value;
    let tobMain = 0;

    if (cie === "FR" || cie === "RK") {
        tobMain = (parseInt(document.getElementById('ADULT')?.value) || 0) +
                  (parseInt(document.getElementById('CHILD')?.value) || 0);
        const sum = (parseInt(document.getElementById('FWD')?.value) || 0) +
                    (parseInt(document.getElementById('MID')?.value) || 0) +
                    (parseInt(document.getElementById('AFT')?.value) || 0);
        styleTOB(sum === tobMain);
    } else {
        tobMain = (parseInt(document.getElementById('MALE')?.value) || 0) +
                  (parseInt(document.getElementById('FEMALE')?.value) || 0) +
                  (parseInt(document.getElementById('CHILD')?.value) || 0);
        const sum = (parseInt(document.getElementById('OA')?.value) || 0) +
                    (parseInt(document.getElementById('OB')?.value) || 0) +
                    (parseInt(document.getElementById('OC')?.value) || 0) +
                    (parseInt(document.getElementById('OD')?.value) || 0);
        styleTOB(sum === tobMain);
    }
}

function styleTOB(valid) {
    const tobField = document.getElementById('TOB');
    if (valid) {
        tobField.style.border = "1px solid #ccc";
        tobField.style.color = "#000";
    } else {
        tobField.style.border = "2px solid red";
        tobField.style.color = "red";
    }
}

/* === CALCULS === */
function updateAllCalculations() {
    updateTimers();
    updateSOBTDefault();
    updateTOBT();
    updateDLCode();
    updateDLDuree2();
    updateLID();
    applyPrestationsDefaults();
}

/* === TIMERS === */
function updateTimers() {
    const sobt = document.getElementById('SOBT').value;
    if (!sobt) {
        ['timer-h40', 'timer-h15', 'timer-h8'].forEach(id => document.getElementById(id).textContent = '--:--');
        return;
    }
    const [hh, mm] = sobt.split(':').map(Number);
    const base = new Date();
    base.setHours(hh);
    base.setMinutes(mm);
    const h40 = new Date(base.getTime() - 40 * 60000);
    const h15 = new Date(base.getTime() - 15 * 60000);
    document.getElementById('timer-h40').textContent = `${String(h40.getHours()).padStart(2, '0')}:${String(h40.getMinutes()).padStart(2, '0')}`;
    document.getElementById('timer-h15').textContent = `${String(h15.getHours()).padStart(2, '0')}:${String(h15.getMinutes()).padStart(2, '0')}`;
}

/* === LID === */
function updateLID() {
    const cie = document.getElementById('Cie').value;
    const tobt = document.getElementById('timer-tobt').textContent;
    if ((cie === "FR" || cie === "RK") && tobt !== "--:--") {
        let [hh, mm] = tobt.split(':').map(Number);
        const d = new Date();
        d.setHours(hh);
        d.setMinutes(mm - 8);
        document.getElementById('timer-h8').textContent = `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
    } else {
        document.getElementById('timer-h8').textContent = "--:--";
    }
}

/* === SOBT PAR DÉFAUT === */
function updateSOBTDefault() {
    if (manualSOBT) return;
    const cie = document.getElementById('Cie').value;
    const sibt = document.getElementById('SIBT').value;
    const arrPNT = document.getElementById('ArrPNT')?.value;
    const arrPNC = document.getElementById('ArrPNC')?.value;
    if (!sibt) return;

    if (!(cie === "FR" || cie === "RK" || cie === "W4" || cie === "W6")) return;

    let [sH, sM] = sibt.split(':').map(Number);
    const base = new Date();
    base.setHours(sH, sM);

    let add = 35;
    if (cie === "FR" || cie === "RK") {
        add = (arrPNT || arrPNC) ? 35 : 25;
    }

    const sobtCalc = new Date(base.getTime() + add * 60000);
    document.getElementById('SOBT').value = `${String(sobtCalc.getHours()).padStart(2, '0')}:${String(sobtCalc.getMinutes()).padStart(2, '0')}`;
}

/* === TOBT CALCUL === */
function updateTOBT() {
    const cie = document.getElementById('Cie').value;
    const sibttxt = document.getElementById('SIBT').value;
    const aibttxt = document.getElementById('AIBT').value;
    const sobttxt = document.getElementById('SOBT').value;

    if (!cie || !sibttxt) {
        document.getElementById('timer-tobt').textContent = '--:--';
        return;
    }

    const [sH, sM] = sibttxt.split(':').map(Number);
    const [aH, aM] = aibttxt ? aibttxt.split(':').map(Number) : [sH, sM];
    const [soH, soM] = sobttxt ? sobttxt.split(':').map(Number) : [sH, sM];

    const SIBT = new Date(); SIBT.setHours(sH, sM);
    const AIBT = new Date(); AIBT.setHours(aH, aM);
    const SOBT = new Date(); SOBT.setHours(soH, soM);

    let TOBT = new Date(SIBT);

    if (cie === 'FR' || cie === 'RK' || cie === 'W4' || cie === 'W6') {
        if (AIBT > SIBT) {
            const arrPNT = document.getElementById('ArrPNT').value;
            const arrPNC = document.getElementById('ArrPNC').value;
            const add = (arrPNT || arrPNC) ? 35 : 25;
            TOBT = new Date(AIBT.getTime() + add * 60000);
        } else {
            TOBT = new Date(SIBT);
        }
    } else {
        if (AIBT > SIBT) {
            const diff = (SOBT - SIBT) / 60000;
            TOBT = new Date(AIBT.getTime() + diff * 60000);
        } else {
            TOBT = new Date(SIBT);
        }
    }

    if (TOBT < SOBT) TOBT = SOBT;

    document.getElementById('timer-tobt').textContent = `${String(TOBT.getHours()).padStart(2, '0')}:${String(TOBT.getMinutes()).padStart(2, '0')}`;
}

/* === DL CODES === */
function updateDLCode() {
    const cie = document.getElementById('Cie').value;
    const sibttxt = document.getElementById('SIBT').value;
    const aibttxt = document.getElementById('AIBT').value;
    if (!cie || !sibttxt || !aibttxt) return;

    const [sH, sM] = sibttxt.split(':').map(Number);
    const [aH, aM] = aibttxt.split(':').map(Number);
    const SIBT = new Date(); SIBT.setHours(sH, sM);
    const AIBT = new Date(); AIBT.setHours(aH, aM);

    if (AIBT > SIBT) {
        if (cie === 'FR') document.getElementById('DLcode1').value = '93';
        else if (cie === 'W4' || cie === 'W6') document.getElementById('DLcode1').value = '93A';
        else document.getElementById('DLcode1').value = '';
        document.getElementById('DLduree1').value = Math.round((AIBT - SIBT) / 60000) || '';
    } else {
        document.getElementById('DLcode1').value = '';
        document.getElementById('DLduree1').value = '';
    }
}

/* === DL DURÉES 2 & 3 === */
function updateDLDuree2() {
    const sobt = document.getElementById('SOBT').value;
    const aobt = document.getElementById('AOBT').value;
    const dlduree1 = parseInt(document.getElementById('DLduree1').value) || 0;

    if (sobt && aobt) {
        const [soH, soM] = sobt.split(':').map(Number);
        const [aoH, aoM] = aobt.split(':').map(Number);
        const SOBT = new Date(); SOBT.setHours(soH, soM);
        const AOBT = new Date(); AOBT.setHours(aoH, aoM);

        let diff = Math.round((AOBT - SOBT) / 60000) - dlduree1;
        document.getElementById('DLduree2').value = diff > 0 ? diff : '';
        updateDLDuree3();
    } else {
        document.getElementById('DLduree2').value = '';
    }
}

function updateDLDuree3() {
    const sobt = document.getElementById('SOBT').value;
    const aobt = document.getElementById('AOBT').value;
    const dlduree1 = parseInt(document.getElementById('DLduree1').value) || 0;
    const dlduree2 = parseInt(document.getElementById('DLduree2').value) || 0;

    if (sobt && aobt) {
        const [soH, soM] = sobt.split(':').map(Number);
        const [aoH, aoM] = aobt.split(':').map(Number);
        const SOBT = new Date(); SOBT.setHours(soH, soM);
        const AOBT = new Date(); AOBT.setHours(aoH, aoM);
        const total = Math.round((AOBT - SOBT) / 60000);
        const reste = total - dlduree1 - dlduree2;
        document.getElementById('DLduree3').value = reste > 0 ? reste : '';
    }
}

/* === PRESTATIONS AUTO === */
function applyPrestationsDefaults() {
    const from = document.getElementById('From').value.toUpperCase();
    const to = document.getElementById('To').value.toUpperCase();

    if (from === "BVA") {
        document.getElementById('Ordures').value = "N";
        document.getElementById('EauPotable').value = "Y";
        document.getElementById('MenageAssist').value = "N";
    }
    if (to === "BVA") {
        document.getElementById('Ordures').value = "Y";
        document.getElementById('Vidange').value = "Y";
        document.getElementById('MenageAtalian').value = "T";
    }
}

/* === UTILITAIRES === */
function setNow(fieldId) {
    const now = new Date();
    const hh = isUTC ? now.getUTCHours() : now.getHours();
    const mm = isUTC ? now.getUTCMinutes() : now.getMinutes();
    document.getElementById(fieldId).value = `${String(hh).padStart(2, '0')}:${String(mm).padStart(2, '0')}`;
}

function adjustTime(fieldId, delta) {
    const input = document.getElementById(fieldId);
    if (!input.value) return;
    let [hh, mm] = input.value.split(':').map(Number);
    let total = hh * 60 + mm + delta;
    if (total < 0) total += 1440;
    if (total >= 1440) total -= 1440;
    hh = Math.floor(total / 60);
    mm = total % 60;
    input.value = `${String(hh).padStart(2, '0')}:${String(mm).padStart(2, '0')}`;
}

/* === Switches Jour/Nuit & Local/UTC === */
function setDarkMode(enable, fromInit=false){
    const currentlyDark = document.body.classList.contains('dark');
    if (enable && !currentlyDark) document.body.classList.add('dark');
    if (!enable && currentlyDark) document.body.classList.remove('dark');
    document.getElementById('darkToggle').checked = enable;
    localStorage.setItem('modeDark', enable ? '1' : '0');
}

function setTimeModeUTC(enable, fromInit=false){
    if (!fromInit && enable !== isUTC) {
        // convertir toutes les heures de +/-2h selon le sens
        const inputs = document.querySelectorAll('input[type="time"]');
        inputs.forEach(input => {
            if (!input.value) return;
            let [hh, mm] = input.value.split(':').map(Number);
            hh = enable ? hh - 2 : hh + 2; // Local->UTC : -2h / UTC->Local : +2h
            if (hh < 0) hh += 24;
            if (hh >= 24) hh -= 24;
            input.value = `${String(hh).padStart(2, '0')}:${String(mm).padStart(2, '0')}`;
        });
    }
    isUTC = enable;
    document.getElementById('utcToggle').checked = enable;
    localStorage.setItem('modeUTC', enable ? '1' : '0');
    updateTimeModeLabel();
    updateAllCalculations();
}

/* Compat anciens appels */
function toggleDarkMode(){ setDarkMode(!document.body.classList.contains('dark')); }
function toggleTimeMode(){ setTimeModeUTC(!isUTC); }

/* Indicateur de mode */
function updateTimeModeLabel() {
    document.getElementById('timeModeLabel').textContent = "Mode : " + (isUTC ? "UTC" : "Local");
}

/* === POPUP === */
function showPopup(message, color = "#2196f3", duration = 2000) {
    const popup = document.createElement('div');
    popup.textContent = message;
    popup.style.position = "fixed";
    popup.style.top = "60px";  // Sous la barre fixe
    popup.style.left = "50%";
    popup.style.transform = "translateX(-50%)";
    popup.style.background = color;
    popup.style.color = "#fff";
    popup.style.padding = "10px 20px";
    popup.style.borderRadius = "6px";
    popup.style.fontSize = "1rem";
    popup.style.zIndex = "3000";
    document.body.appendChild(popup);
    setTimeout(() => popup.remove(), duration);
}

/* === ENVOI EXTERNE SUPPRIMÉ ===
   (Airtable retiré ; le bouton VALIDER est maintenu mais inactif) */

/* === VALIDATION === */
function validateForm() {
    showPopup("Le bouton VALIDER est inactif pour le moment.", "#ff9800", 2500);
    // Rien d'autre pour l'instant
}

/* === SAUVEGARDE MANUELLE === */
function manualSave() {
    saveCurrentTabData();
    persistStrokes(); // on force la persistance des notes
    showPopup("Enregistrement réussi", "#2196f3", 2000);
}

/* === RESET === */
function clearAutoSave() {
    if (confirm("Tout réinitialiser ?")) {
        localStorage.clear();
        location.reload();
    }
}
</script>
</body>
</html>
