<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Fiche Escale</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* === STYLES DE BASE === */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0 0 80px;
        }

        .dark {
            background: #1e1e1e;
            color: white;
        }

        #tab-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            gap: 10px;
            background: #333;
            padding: 8px;
            z-index: 100;
        }

        #tab-bar button {
            padding: 6px 10px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: white;
            background-color: #555;
        }

        #tab-bar button:hover {
            background-color: #777;
        }

        section {
            padding: 12px;
            border-bottom: 1px solid #ccc;
        }

        section.collapsed .section-content {
            display: none;
        }

        section h2 {
            cursor: pointer;
            background-color: #f0f0f0;
            padding: 6px;
            border-radius: 5px;
        }

        .dark section h2 {
            background-color: #444;
        }

        .form-group {
            margin: 10px 0;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 6px;
            margin-top: 4px;
            box-sizing: border-box;
        }

        textarea#Justifications, textarea#FaitsS {
            font-family: 'Calibri', sans-serif;
            font-size: 7pt;
        }

        #save-button {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 12px 18px;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            z-index: 100;
        }

        /* Zone de dessin manuscrite */
        #drawingCanvas {
            border: 1px solid #ccc;
            width: 100%;
            height: 200px;
            touch-action: none;
            background: white;
        }
    </style>
</head>
<body>
    <div id="tab-bar">
        <!-- Onglets ajoutés dynamiquement ici -->
    </div>

    <main style="margin-top: 60px; padding: 10px;">
        <!-- === INFO VOL === -->
        <section id="info-vol">
            <h2>INFO VOL</h2>
            <div class="section-content">
                <div class="form-group">
                    <label for="Date">Date :</label>
                    <input type="date" id="Date">
                </div>
                <div class="form-group">
                    <label for="Cie">Cie :</label>
                    <select id="Cie">
                        <option value="">Choisir</option>
                        <option value="FR">Ryanair (FR)</option>
                        <option value="RK">Ryanair UK (RK)</option>
                        <option value="W6">Wizz Air (W6)</option>
                        <option value="W4">Wizz Air Malta (W4)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="NVol">N° Vol :</label>
                    <input type="text" id="NVol">
                </div>
                <div class="form-group">
                    <label for="From">Provenance :</label>
                    <input type="text" id="From">
                </div>
                <div class="form-group">
                    <label for="To">Destination :</label>
                    <input type="text" id="To">
                </div>
                <div class="form-group">
                    <label for="Parking">Parking :</label>
                    <select id="Parking">
                        <option value="">Choisir</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="Immat">Immatriculation :</label>
                    <input type="text" id="Immat">
                </div>
                <div class="form-group">
                    <label for="RZA">RZA :</label>
                    <input type="text" id="RZA">
                </div>
                <div class="form-group">
                    <label for="SIBT">SIBT :</label>
                    <input type="time" id="SIBT">
                </div>
                <div class="form-group">
                    <label for="AIBT">AIBT :</label>
                    <input type="time" id="AIBT">
                </div>
                <div class="form-group">
                    <label for="SOBT">SOBT :</label>
                    <input type="time" id="SOBT">
                </div>
                <div class="form-group">
                    <label for="AOBT">AOBT :</label>
                    <input type="time" id="AOBT">
                </div>
            </div>
        </section>

        <!-- === REMARQUES (Dessin à main levée) === -->
        <section id="remarques">
            <h2>Remarques (écriture libre)</h2>
            <div class="section-content">
                <canvas id="drawingCanvas"></canvas>
            </div>
        </section>

        <!-- === JUSTIFICATIONS === -->
        <section id="justifications">
            <h2>DL JUSTIFICATIONS</h2>
            <div class="section-content">
                <textarea id="Justifications" rows="5"></textarea>
            </div>
        </section>

        <!-- === FAITS SAILLANTS === -->
        <section id="faits">
            <h2>FAITS SAILLANTS</h2>
            <div class="section-content">
                <textarea id="FaitsS" rows="5"></textarea>
            </div>
        </section>

        <!-- === BOUTON SAUVEGARDE MANUELLE === -->
        <button id="save-button" onclick="manualSave()">SAUVEGARDER</button>
    </main>

    <script>
        
/* === CODE JS COMPLET === */

/* === VARIABLES === */
let isUTC = false;
let manualSOBT = false;
let currentTabId = null;
const circledNums = ["", "①", "②", "③", "④", "⑤", "⑥", "⑦", "⑧", "⑨", "⑩", "⑪", "⑫"];

/* === INIT FORMULAIRE === */
function initForm() {
    renderTabs();
    let lastTab = localStorage.getItem('lastTabId');
    let tabs = JSON.parse(localStorage.getItem('flightTabs') || '[]');
    if (tabs.length === 0) createNewTab();
    else if (lastTab && tabs.includes(parseInt(lastTab))) switchTab(parseInt(lastTab));
    else switchTab(tabs[0]);

    generateTimingFields();
    generateChargementFields();

    setInterval(() => {
        updateAllCalculations();
        saveCurrentTabData();
    }, 60000);

    document.getElementById('Parking').onchange = updateTabLabelInstant;
    document.getElementById('To').oninput = updateTabLabelInstant;
    document.getElementById('From').oninput = applyPrestationsDefaults;
    document.getElementById('To').oninput = applyPrestationsDefaults;
}

/* === TABS === */
function renderTabs() {
    const tabBar = document.getElementById('tab-bar');
    tabBar.innerHTML = '<button onclick="createNewTab()">+ Ajouter vol</button>';
    let tabs = JSON.parse(localStorage.getItem('flightTabs') || '[]');
    tabs.forEach((id, index) => {
        const data = JSON.parse(localStorage.getItem('tab-' + id) || '{}');
        let label = data.To ? data.To.toUpperCase() : "VOL";
        let parking = data.Parking ? circledNums[parseInt(data.Parking)] : "";
        const btn = document.createElement('button');
        btn.textContent = label + " " + parking;
        btn.style.fontWeight = id === currentTabId ? 'bold' : 'normal';
        btn.onclick = () => switchTab(id);
        btn.ondblclick = () => deleteTab(id);
        tabBar.appendChild(btn);
    });
}

function createNewTab() {
    const newId = Date.now();
    let tabs = JSON.parse(localStorage.getItem('flightTabs') || '[]');
    tabs.push(newId);
    localStorage.setItem('flightTabs', JSON.stringify(tabs));
    clearFormFields();
    currentTabId = newId;
    localStorage.setItem('lastTabId', newId);
    saveCurrentTabData();
    renderTabs();
}

function switchTab(id) {
    saveCurrentTabData();
    currentTabId = id;
    localStorage.setItem('lastTabId', id);
    loadTabData(id);
    renderTabs();
}

function deleteTab(id) {
    if (!confirm("Supprimer cet onglet ?")) return;
    let tabs = JSON.parse(localStorage.getItem('flightTabs') || '[]');
    tabs = tabs.filter(t => t !== id);
    localStorage.setItem('flightTabs', JSON.stringify(tabs));
    localStorage.removeItem('tab-' + id);
    if (tabs.length > 0) switchTab(tabs[0]);
    else createNewTab();
    renderTabs();
}

/* === FORMULAIRE === */
function updateTabLabelInstant() {
    saveCurrentTabData();
    renderTabs();
}

function clearFormFields() {
    document.querySelectorAll('input, select, textarea').forEach(el => {
        if (el.type === 'checkbox' || el.type === 'radio') el.checked = false;
        else if (el.tagName === 'SELECT') el.selectedIndex = 0;
        else el.value = '';
    });
    document.getElementById('Date').valueAsDate = new Date();
    document.getElementById('FNC').value = 'N';
    updateAllCalculations();
}

function saveCurrentTabData() {
    if (!currentTabId) return;
    let data = {};
    document.querySelectorAll('input, select, textarea').forEach(el => data[el.id] = el.value);
    data.modeDark = document.body.classList.contains('dark') ? '1' : '0';
    data.modeUTC = isUTC ? '1' : '0';
    data.timer_h40 = document.getElementById('timer-h40').textContent;
    data.timer_h15 = document.getElementById('timer-h15').textContent;
    data.timer_h8 = document.getElementById('timer-h8').textContent;
    data.timer_tobt = document.getElementById('timer-tobt').textContent;
    localStorage.setItem('tab-' + currentTabId, JSON.stringify(data));
    localStorage.setItem('lastTabId', currentTabId);
    renderTabs();
}

function loadTabData(id) {
    const data = JSON.parse(localStorage.getItem('tab-' + id) || '{}');
    document.querySelectorAll('input, select, textarea').forEach(el => {
        if (data[el.id] !== undefined) el.value = data[el.id];
    });
    if (data.modeDark === '1') document.body.classList.add('dark');
    else document.body.classList.remove('dark');
    isUTC = data.modeUTC === '1';
    document.getElementById('toggle-utc').textContent = isUTC ? 'Mode : UTC' : 'Mode : LOCAL';
    document.getElementById('timer-h40').textContent = data.timer_h40 || '--:--';
    document.getElementById('timer-h15').textContent = data.timer_h15 || '--:--';
    document.getElementById('timer-h8').textContent = data.timer_h8 || '--:--';
    document.getElementById('timer-tobt').textContent = data.timer_tobt || '--:--';
    generateChargementFields();
    generateTimingFields();
    updateAllCalculations();
}

/* === TIMING === */
function generateTimingFields() {
    const timings = ["ArrPNT", "ArrPNC", "PremierDebarque", "DernierDebarque", "AvionPremierEmbarque", "AvionDernierEmbarque", "PortePremierEmbarque", "PorteDernierEmbarque", "ArriveeFuel", "DepartFuel", "ArriveeLift", "DepartLift", "RemiseLID", "FermeturePorteAvion"];
    const labels = ["Arrivée PNT avion", "Arrivée PNC avion", "Premier débarqué", "Dernier débarqué", "Avion : Premier embarqué", "Avion : Dernier embarqué", "Porte : Premier embarqué", "Porte : Dernier embarqué", "Arrivée Fuel", "Départ Fuel", "Arrivée Lift", "Départ Lift", "Remise LID/LDS", "Fermeture porte avion"];
    const container = document.getElementById('timing-grid');
    container.innerHTML = "";
    timings.forEach((id, i) => {
        const div = document.createElement('div');
        div.className = 'form-group';
        div.innerHTML = `
            <label>${labels[i]}
                <input type="time" id="${id}" onchange="updateAllCalculations()">
            </label>
            <div class="btn-actions">
                <button class="action minus" onclick="adjustTime('${id}', -1); updateAllCalculations()">-1</button>
                <button class="action now" onclick="setNow('${id}'); updateAllCalculations()">Now</button>
                <button class="action plus" onclick="adjustTime('${id}', 1); updateAllCalculations()">+1</button>
            </div>`;
        container.appendChild(div);
    });
}

/* === TOGGLE UTC === */
function toggleUTC() {
    isUTC = !isUTC;
    document.getElementById('toggle-utc').textContent = isUTC ? 'Mode : UTC' : 'Mode : LOCAL';
    updateAllCalculations();
}

/* === CANVAS DESSIN === */
function clearCanvas() {
    const canvas = document.getElementById('canvasNotes');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}
function initCanvas() {
    const canvas = document.getElementById('canvasNotes');
    const ctx = canvas.getContext('2d');
    let drawing = false;
    canvas.onmousedown = (e) => {
        drawing = true;
        ctx.beginPath();
        ctx.moveTo(e.offsetX, e.offsetY);
    };
    canvas.onmousemove = (e) => {
        if (!drawing) return;
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
    };
    canvas.onmouseup = () => drawing = false;
    canvas.onmouseleave = () => drawing = false;
}

/* === VALIDATION === */
function validateForm() {
    const required = ['Date', 'Cie', 'Parking', 'NVol', 'From', 'To', 'Immat', 'RZA'];
    let missing = false;
    for (let id of required) {
        if (!document.getElementById(id).value) {
            missing = true;
        }
    }
    if (missing) {
        showPopup("Vérifiez les informations manquantes !", "#d32f2f", 4000);
    } else {
        sendToAirtable();
        showPopup("Vol terminé et envoyé !", "#4caf50", 2000);
        setTimeout(() => {
            let tabs = JSON.parse(localStorage.getItem('flightTabs') || '[]');
            tabs = tabs.filter(t => t !== currentTabId);
            localStorage.setItem('flightTabs', JSON.stringify(tabs));
            localStorage.removeItem('tab-' + currentTabId);
            if (tabs.length > 0) switchTab(tabs[0]);
            else createNewTab();
        }, 1000);
    }
}

/* === SAUVEGARDE MANUELLE === */
function manualSave() {
    saveCurrentTabData();
    showPopup("Enregistrement réussi", "#2196f3", 2000);
}

/* === RESET === */
function clearAutoSave() {
    if (confirm("Tout réinitialiser ?")) {
        localStorage.clear();
        location.reload();
    }
}

/* === POPUP === */
function showPopup(message, color = "#2196f3", duration = 2000) {
    const popup = document.createElement('div');
    popup.textContent = message;
    popup.style.position = "fixed";
    popup.style.top = "60px";
    popup.style.left = "50%";
    popup.style.transform = "translateX(-50%)";
    popup.style.background = color;
    popup.style.color = "#fff";
    popup.style.padding = "10px 20px";
    popup.style.borderRadius = "6px";
    popup.style.fontSize = "1rem";
    popup.style.zIndex = "1000";
    document.body.appendChild(popup);
    setTimeout(() => popup.remove(), duration);
}

/* === AIRTABLE CONFIGURATION === */
const AIRTABLE_API_KEY = "ta_clé_api";
const AIRTABLE_BASE_ID = "ton_base_id";
const AIRTABLE_TABLE_NAME = "nom_table";

/* === ENVOI AIRTABLE === */
async function sendToAirtable() {
    const record = {
        "Date": document.getElementById('Date').value,
        "Immat": document.getElementById('Immat').value.toUpperCase(),
        "Parking": document.getElementById('Parking').value.toUpperCase(),
        "Cie": document.getElementById('Cie').value.toUpperCase(),
        "N° Vol": document.getElementById('NVol').value.toUpperCase(),
        "From": document.getElementById('From').value.toUpperCase(),
        "To": document.getElementById('To').value.toUpperCase(),
        "SIBT": document.getElementById('SIBT').value,
        "AIBT": document.getElementById('AIBT').value,
        "SOBT": document.getElementById('SOBT').value,
        "AOBT": document.getElementById('AOBT').value
    };

    try {
        const response = await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}`, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${AIRTABLE_API_KEY}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ records: [{ fields: record }] })
        });

        if (!response.ok) throw new Error(`Erreur API : ${response.statusText}`);
        showPopup("Données envoyées à Airtable !", "#4caf50", 3000);
    } catch (err) {
        console.error("Erreur Airtable :", err);
        showPopup("Erreur lors de l'envoi vers Airtable", "#d32f2f", 3000);
    }
}

/* === LANCEMENT === */
window.onload = () => {
    initForm();
    initCanvas();
};
</script>
</body>
</html>
