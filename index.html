<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BVA â€” Vols du jour (GoFlightLabs)</title>
<style>
  :root{
    --bg:#ffffff; --card:#f5f7fb; --ink:#0e1420; --muted:#5e6a85; --brand:#2d5bff;
    --ok:#1bbf72; --warn:#ff9f1a; --late:#ff4d4f; --chip:#e7ecff;
    --shadow:0 6px 18px rgba(0,0,0,.08); --radius:16px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  header{position:sticky;top:0;z-index:20;background:var(--bg);border-bottom:1px solid #e9edf5}
  .wrap{max-width:1100px;margin:0 auto;padding:18px 16px}
  .title{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .title h1{font-size:22px;margin:0}
  .pill{display:inline-flex;gap:6px;padding:8px 10px;border-radius:999px;background:var(--chip);color:#2643b3;font-weight:600;font-size:13px}
  .controls{margin-top:12px;display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .segmented{display:flex;background:#e9edf5;border-radius:999px;padding:3px;gap:4px}
  .segmented button{appearance:none;border:0;background:transparent;padding:8px 14px;border-radius:999px;font-weight:600;color:var(--muted);cursor:pointer}
  .segmented button.active{background:#fff;color:var(--ink);box-shadow:var(--shadow)}
  .field{display:flex;align-items:center;gap:8px;background:#fff;border:1px solid #e5e9f2;padding:8px 10px;border-radius:10px}
  .field input[type="date"],.field input[type="text"]{border:0;outline:0;font-size:14px;background:transparent;color:var(--ink)}
  .btn{appearance:none;border:0;background:var(--brand);color:#fff;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:var(--shadow)}
  .hint{color:var(--muted);font-size:13px;margin-left:auto}
  .toggle{display:flex;align-items:center;gap:8px;cursor:pointer;user-select:none;font-size:13px;color:var(--muted)}
  .toggle input{accent-color:var(--brand);width:18px;height:18px}
  main{padding:18px 16px}
  .section{max-width:1100px;margin:0 auto}
  .section h2{margin:16px 0 8px;font-size:16px;color:#33405f}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  @media (max-width:900px){.grid{grid-template-columns:repeat(6,1fr)}}
  @media (max-width:640px){.grid{grid-template-columns:repeat(1,1fr)}}
  .card{grid-column:span 6;background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow);position:relative;overflow:hidden}
  @media (max-width:640px){.card{grid-column:span 1}}
  .row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .flight{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .chip{background:#fff;border:1px solid #e5e9f2;border-radius:10px;padding:4px 8px;font-weight:700;font-size:12px}
  .dir{font-size:11px;font-weight:800;letter-spacing:.8px;color:#6071a4}
  .flight-no{font-weight:800;font-size:18px}
  .airline{font-size:12px;color:var(--muted)}
  .times{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
  .timebox{display:flex;flex-direction:column;gap:2px;min-width:70px}
  .lbl{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
  .val{font-weight:800}
  .delay{font-size:12px;font-weight:800;padding:3px 8px;border-radius:999px}
  .delay.ok{background:#eafaf3;color:var(--ok)}
  .delay.warn{background:#fff5e8;color:var(--warn)}
  .delay.late{background:#ffecec;color:var(--late)}
  .meta{display:flex;gap:10px;align-items:center;flex-wrap:wrap;color:#4b5774;font-size:12px}
  .meta .dot{width:6px;height:6px;border-radius:50%;background:#aab3c7}
  .badge{position:absolute;right:12px;top:12px;background:#fff;border:1px solid #e5e9f2;border-radius:999px;padding:4px 8px;font-size:11px;font-weight:800;color:#3c4b76}
  .empty{border:2px dashed #d8e0f0;border-radius:16px;padding:28px;text-align:center;color:#5f6b87}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="title">
      <h1>ðŸ›« BVA â€” Vols du jour</h1>
      <span class="pill" id="dayLabel">Europe/Paris</span>
    </div>
    <div class="controls">
      <div class="segmented" id="dirTabs">
        <button data-dir="ALL" class="active">Tous</button>
        <button data-dir="ARR">ArrivÃ©es</button>
        <button data-dir="DEP">DÃ©parts</button>
      </div>
      <label class="field" title="Date locale (Europe/Paris)">
        <span>ðŸ“…</span><input type="date" id="datePicker">
      </label>
      <label class="field" style="flex:1" title="Rechercher : vol, compagnie, codesâ€¦">
        <span>ðŸ”Ž</span><input type="text" id="search" placeholder="Rechercher un volâ€¦">
      </label>
      <button class="btn" id="refreshBtn">RafraÃ®chir</button>
      <span class="hint" id="countHint">â€”</span>
      <label class="toggle">
        <input type="checkbox" id="demoToggle"> DÃ©mo si lâ€™API est bloquÃ©e (CORS)
      </label>
    </div>
  </div>
</header>

<main>
  <section class="section">
    <h2>ArrivÃ©es</h2>
    <div id="arrivals" class="grid"></div>
  </section>
  <section class="section">
    <h2>DÃ©parts</h2>
    <div id="departures" class="grid"></div>
  </section>
  <section class="section" id="emptyState" style="display:none">
    <div class="empty">Aucun vol ne correspond aux filtres.</div>
  </section>
</main>

<script>
/* ========= CONFIG ========= */
const ACCESS_KEY = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJhdWQiOiI0IiwianRpIjoiNTQ5Njc5YTE2NGZhODZkN2RmZjQ0MjBhNjM1NGVhMTVlOGE1M2E3ZjkxZTFkMDE2NDZmMzgyMTkzYzRkZDQyOWY1NjFlMjZkNWU4MWM5YjEiLCJpYXQiOjE3NTUxNjQyNTYsIm5iZiI6MTc1NTE2NDI1NiwiZXhwIjoxNzg2NzAwMjU2LCJzdWIiOiIyNTY2OSIsInNjb3BlcyI6W119.NvJJN1Lt8IMXxl7QJ-UN9e0Z_7F4neBjOcBuJqUvk8Wanly43jtgBzZJDtt0PggqRWpcOP9gCU8Oi3ow69XOnQ";
const ENDPOINT = "https://www.goflightlabs.com/advanced-flights-schedules";
const IATA_BVA = "BVA";
const TZ = "Europe/Paris";
/* ========================= */

const fmt = new Intl.DateTimeFormat('fr-FR',{timeZone:TZ,hour:'2-digit',minute:'2-digit'});
const fmtDay = new Intl.DateTimeFormat('fr-FR',{timeZone:TZ, dateStyle:'medium'});

const toMs = v => (v==null ? null : (v>1e12 ? v : v*1000));
const ymdTZ = ms => {
  if(ms==null) return null;
  const d = new Date(ms);
  const y = new Intl.DateTimeFormat('en-CA',{timeZone:TZ,year:'numeric'}).format(d);
  const m = new Intl.DateTimeFormat('en-CA',{timeZone:TZ,month:'2-digit'}).format(d);
  const da= new Intl.DateTimeFormat('en-CA',{timeZone:TZ,day:'2-digit'}).format(d);
  return `${y}-${m}-${da}`; // YYYY-MM-DD
};
const fmtTime = ms => ms==null ? "â€”" : fmt.format(new Date(ms));
const minDiff = (msA, msB) => (msA==null||msB==null) ? null : Math.round((msA-msB)/60000);
const delayBadge = (sched, ref) => {
  const d = minDiff(ref, sched);
  if(d===null) return "";
  const cls = d<=0 ? "ok" : (d<=15 ? "warn" : "late");
  const txt = d===0 ? "Ã  l'heure" : (d<0 ? `${Math.abs(d)}' en avance` : `+${d}'`);
  return `<span class="delay ${cls}">${txt}</span>`;
};

function pickFlightNumber(it){
  return it.flight_iata || it.flight_icao || it.flight_number || "â€”";
}

/* ---- Fetch ALL pages for a type (arrival/ departure) ---- */
async function fetchSchedules(type){
  const limit = 1000;
  let skip = 0, all = [];
  while(true){
    const url = `${ENDPOINT}?access_key=${encodeURIComponent(ACCESS_KEY)}&iataCode=${IATA_BVA}&type=${type}&limit=${limit}&skip=${skip}`;
    const res = await fetch(url, {mode:'cors'});
    if(!res.ok) throw new Error("HTTP "+res.status);
    const json = await res.json();
    const rows = Array.isArray(json?.data) ? json.data : Array.isArray(json?.response) ? json.response : Array.isArray(json) ? json : [];
    all.push(...rows);
    const hasMore = json?.has_more === true || (typeof json?.total_items === "number" ? (skip + limit) < json.total_items : false);
    if(!hasMore) break;
    skip += limit;
    if(skip > 20000) break; // garde-fou
  }
  return all;
}

/* ---- Normalize to our UI model ---- */
function normalize(rows, dir){
  return rows
    .filter(r => dir==="ARR" ? r.arr_iata===IATA_BVA : r.dep_iata===IATA_BVA)
    .map(r => {
      const sched = dir==="ARR" ? toMs(r.arr_time_ts) : toMs(r.dep_time_ts);
      const est   = dir==="ARR" ? toMs(r.arr_estimated_ts) : toMs(r.dep_estimated_ts);
      const act   = dir==="ARR" ? toMs(r.arr_actual_ts) : toMs(r.dep_actual_ts);
      return {
        dir,
        status: r.status || "",
        airline: r.airline_iata || r.airline_icao || "",
        number: pickFlightNumber(r),
        dep: { iata: r.dep_iata || "", icao: r.dep_icao || "" },
        arr: { iata: r.arr_iata || "", icao: r.arr_icao || "" },
        aircraft: r.aircraft_icao || "",
        sched, est, act
      };
    });
}

/* ---- DEMO data (si CORS) ---- */
const demoData = [
  {dir:"ARR", status:"active", airline:"TO", number:"TO4101", dep:{iata:"PMI"}, arr:{iata:"BVA"}, aircraft:"A320", sched: Date.now()-3600e3, est: Date.now()-1800e3, act:null},
  {dir:"DEP", status:"scheduled", airline:"FR", number:"FR1234", dep:{iata:"BVA"}, arr:{iata:"BGY"}, aircraft:"B738", sched: Date.now()+1800e3, est:null, act:null},
  {dir:"ARR", status:"landed", airline:"W6", number:"W63123", dep:{iata:"OTP"}, arr:{iata:"BVA"}, aircraft:"A21N", sched: Date.now()-7200e3, est:null, act:Date.now()-6900e3},
];

/* ---- Rendering ---- */
function card(f){
  const isArr = f.dir==="ARR";
  const STA_STD = isArr ? "STA" : "STD";
  const ETA_ETD = isArr ? "ETA" : "ETD";
  const ATA_ATD = isArr ? "ATA" : "ATD";
  return `
  <article class="card" data-dir="${f.dir}" data-text="${[f.number,f.airline,f.dep.iata,f.arr.iata,f.aircraft].join(' ').toLowerCase()}">
    <span class="badge">${(f.status||"").toUpperCase()}</span>
    <div class="row">
      <div class="flight">
        <span class="chip dir">${f.dir}</span>
        <span class="flight-no">${f.number}</span>
        <span class="airline">${f.airline}</span>
      </div>
      <div class="meta">
        ${f.aircraft ? `<span>${f.aircraft}</span>` : ""}
        <span class="dot"></span><span>${f.dep.iata||"â€”"} â†’ ${f.arr.iata||"â€”"}</span>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="times">
        <div class="timebox"><div class="lbl">${STA_STD}</div><div class="val">${fmtTime(f.sched)}</div></div>
        <div class="timebox"><div class="lbl">${ETA_ETD}</div><div class="val">${fmtTime(f.est)}</div></div>
        <div class="timebox"><div class="lbl">${ATA_ATD}</div><div class="val">${fmtTime(f.act)}</div></div>
        ${delayBadge(f.sched, f.act ?? f.est)}
      </div>
    </div>
  </article>`;
}

function render(list, filterDir, ymd, q){
  const byDay = list.filter(f => ymdTZ(f.sched) === ymd);
  const filtered = byDay.filter(f => filterDir==="ALL" || f.dir===filterDir)
                        .filter(f => !q || (f.number+f.airline+f.dep.iata+f.arr.iata+f.aircraft).toLowerCase().includes(q));
  filtered.sort((a,b)=> (a.sched??0)-(b.sched??0));

  const arr = filtered.filter(f=>f.dir==="ARR").map(card).join("");
  const dep = filtered.filter(f=>f.dir==="DEP").map(card).join("");
  document.getElementById('arrivals').innerHTML = arr;
  document.getElementById('departures').innerHTML = dep;
  const empty = (!arr && (filterDir!=="DEP")) && (!dep && (filterDir!=="ARR"));
  document.getElementById('emptyState').style.display = empty ? "block" : "none";
  document.getElementById('countHint').textContent = filtered.length ? `${filtered.length} vol${filtered.length>1?"s":""}` : "â€”";

  // Masque les titres selon lâ€™onglet
  document.querySelectorAll('.section h2')[0].style.display = (filterDir==="DEP")?"none":"block";
  document.querySelectorAll('.section h2')[1].style.display = (filterDir==="ARR")?"none":"block";
}

/* ---- Controller ---- */
const state = { dir:"ALL", ymd:null, q:"", flights:[] };

function todayYMD(){
  const now = new Date();
  const y = new Intl.DateTimeFormat('en-CA',{timeZone:TZ,year:'numeric'}).format(now);
  const m = new Intl.DateTimeFormat('en-CA',{timeZone:TZ,month:'2-digit'}).format(now);
  const d = new Intl.DateTimeFormat('en-CA',{timeZone:TZ,day:'2-digit'}).format(now);
  return `${y}-${m}-${d}`;
}

function setBusy(b){
  const btn = document.getElementById('refreshBtn');
  btn.disabled = b; btn.textContent = b ? "Chargementâ€¦" : "RafraÃ®chir";
}

async function load(){
  setBusy(true);
  try{
    const [arrRows, depRows] = await Promise.all([
      fetchSchedules("arrival"),
      fetchSchedules("departure")
    ]);
    const flights = [...normalize(arrRows,"ARR"), ...normalize(depRows,"DEP")];
    state.flights = flights;
  }catch(err){
    if(document.getElementById('demoToggle').checked){
      console.warn("API indisponible cÃ´tÃ© navigateur (CORS ?). Fallback dÃ©mo.", err);
      state.flights = demoData;
    }else{
      alert("Impossible dâ€™appeler lâ€™API (CORS ou indisponible). Active le mode DÃ©mo ou passe par un petit proxy serveur.");
      state.flights = [];
    }
  }finally{
    setBusy(false);
    render(state.flights, state.dir, state.ymd, state.q);
  }
}

/* ---- Init ---- */
(function init(){
  state.ymd = todayYMD();
  document.getElementById('datePicker').value = state.ymd;
  document.getElementById('dayLabel').textContent = `${fmtDay.format(new Date())} â€¢ Europe/Paris`;

  document.getElementById('datePicker').addEventListener('change', e=>{
    state.ymd = e.target.value || todayYMD();
    document.getElementById('dayLabel').textContent = `${fmtDay.format(new Date(state.ymd))} â€¢ Europe/Paris`;
    render(state.flights, state.dir, state.ymd, state.q);
  });

  document.querySelectorAll('#dirTabs button').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('#dirTabs button').forEach(x=>x.classList.remove('active'));
      b.classList.add('active'); state.dir = b.dataset.dir;
      render(state.flights, state.dir, state.ymd, state.q);
    });
  });

  document.getElementById('search').addEventListener('input', e=>{
    state.q = (e.target.value||"").toLowerCase().trim();
    render(state.flights, state.dir, state.ymd, state.q);
  });

  document.getElementById('refreshBtn').addEventListener('click', load);
  document.getElementById('demoToggle').addEventListener('change', load);

  load();
})();
</script>
</body>
</html>
