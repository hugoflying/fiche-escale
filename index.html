<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SUIVI PERFORMANCE</title>
<style>
    body { font-family: Arial, sans-serif; background: #f8f9fa; color: #222; padding: 10px; }
    body.dark { background: #121212; color: #f8f9fa; }
    h1 { text-align: center; margin-bottom: 15px; }
    .timer-box { display: flex; justify-content: center; gap: 15px; margin-bottom: 15px; }
    .timer { background: #d32f2f; color: #fff; font-weight: bold; padding: 10px 20px; border-radius: 6px; }
    section { background: #fff; padding: 15px; margin-bottom: 15px; border-radius: 8px; }
    body.dark section { background: #1e1e1e; }
    label { display: block; margin-bottom: 8px; }
    input, select, textarea { width: 100%; padding: 8px; font-size: 1rem; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
    #validate, #login {
        width: 100%; padding: 12px; margin-top: 10px;
        font-size: 1.2rem; border: none; border-radius: 6px; cursor: pointer;
    }
    #login { background: #1976d2; color: #fff; }
    #validate { background: #4caf50; color: #fff; }
</style>
</head>
<body>
<h1>SUIVI PERFORMANCE</h1>

<div class="timer-box">
    <div id="timer-h15" class="timer">H-15</div>
    <div id="timer-h8" class="timer">H-8</div>
</div>

<button id="login">Se connecter avec Microsoft</button>

<section>
    <h2>INFO VOL</h2>
    <label>Date <input type="date" id="Date"></label>
    <label>Cie 
        <select id="Cie">
            <option>FR</option><option>RK</option><option>W4</option><option>W6</option>
            <option>H4</option><option>H6</option><option>U5</option><option>U7</option>
            <option>V7</option><option>Autre</option>
        </select>
    </label>
    <label>N° Vol <input type="text" id="N° Vol"></label>
    <label>Provenance <input type="text" id="From"></label>
    <label>Destination <input type="text" id="To"></label>
    <label>RZA <input type="text" id="RZA"></label>
    <label>Immat <input type="text" id="Immat"></label>
    <label>Parking 
        <select id="Park">
            <option>1</option><option>2</option><option>3</option><option>4</option>
            <option>5</option><option>6</option><option>7</option><option>8</option>
            <option>9</option><option>10</option><option>11</option><option>12</option>
        </select>
    </label>
    <label>FNC 
        <input type="radio" name="FNC" value="Y"> Oui
        <input type="radio" name="FNC" value="N" checked> Non
    </label>
</section>

<!-- AJOUTER ICI LES AUTRES SECTIONS (Horaires, Timing, etc.) -->

<button id="validate">VALIDER</button>

<script src="https://alcdn.msauth.net/browser/2.32.0/js/msal-browser.min.js"></script>
<script>
const msalConfig = {
    auth: {
        clientId: "04f0c124-f2bc-4f81-b82f-03fa74e4d5b7", // Client Microsoft public
        authority: "https://login.microsoftonline.com/common",
        redirectUri: window.location.href
    }
};
const msalInstance = new msal.PublicClientApplication(msalConfig);
let accessToken = null;

// Connexion
document.getElementById('login').addEventListener('click', async () => {
    const loginRequest = { scopes: ["Files.ReadWrite", "Sites.ReadWrite.All"] };
    try {
        const loginResponse = await msalInstance.loginPopup(loginRequest);
        const tokenResponse = await msalInstance.acquireTokenSilent(loginRequest)
            .catch(() => msalInstance.acquireTokenPopup(loginRequest));
        accessToken = tokenResponse.accessToken;
        alert("Connecté avec succès !");
    } catch (err) {
        console.error(err);
        alert("Erreur de connexion");
    }
});

// Validation
document.getElementById('validate').addEventListener('click', async () => {
    if (!accessToken) {
        alert("Connectez-vous d'abord !");
        return;
    }
    const data = collectFormData();
    await sendToExcel(data);
    alert("Données envoyées dans le tableau Performance !");
});

// Collecte des données
function collectFormData() {
    const data = {};
    document.querySelectorAll('input, select, textarea').forEach(el => {
        if (el.type === 'radio') {
            if (el.checked) data[el.name || el.id] = el.value;
        } else {
            data[el.name || el.id] = el.value;
        }
    });
    return data;
}

// Envoi vers Excel
async function sendToExcel(data) {
    const siteId = "itssageb.sharepoint.com,74818751-8768-48d1-bea0-68319419cec2,69072204-40bf-4803-b656-abe7855b4952";
    const filePath = "/sites/aeronet-operations/Suivi Performance/Archive 2025/TEST_____PERFORMANCE (07) Juillet 2025.xlsm";
    const tableName = "Performance";

    const url = `https://graph.microsoft.com/v1.0/sites/${siteId}/drive/root:${filePath}:/workbook/tables('${tableName}')/rows/add`;

    const body = { values: [Object.values(data)] };

    const response = await fetch(url, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${accessToken}`
        },
        body: JSON.stringify(body)
    });

    if (!response.ok) {
        console.error("Erreur Graph API", await response.text());
        alert("Erreur lors de l’envoi des données");
    }
}
</script>
</body>
</html>
