<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SUIVI PERFORMANCE</title>
<style>
/* RESET & BASE */
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
    font-family: Arial, sans-serif;
    background: #ffffff; /* fond de page blanc */
    color: #222;
    padding: 10px;
}
body.dark { background: #121212; color: #f8f9f9; }

h1 { text-align: center; margin: 10px 0 15px; }

/* Sections (blocs) */
section {
    background: #f5f5f5;                   /* gris clair pour les blocs */
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 22px;                   /* espace entre sections */
    box-shadow: 0 4px 12px rgba(0,0,0,0.15); /* ombre renforc√©e */
}
body.dark section { background: #1e1e1e; }

/* Titres de sections */
h2 {
    font-size: 1.2rem;
    margin: -12px -12px 10px -12px;
    padding: 8px 12px;
    border-bottom: 1px solid #ccc;
    text-align: center;
    cursor: pointer;
    background: #e8f0fe;                /* jour */
    color: #123;
    border-left: 6px solid #1976d2;
    border-top-left-radius: 8px;
    border-top-right-radius: 8px;
}
body.dark h2 {
    background: #242424;                /* nuit */
    color: #f5f5f5;
    border-left: 6px solid #90caf9;
    border-bottom-color: #3a3a3a;
}

/* Collapse */
section.collapsed > *:not(h2) { display: none; }

/* Grilles */
.form-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
.form-group { flex: 1 1 calc(50% - 10px); min-width: 150px; margin-bottom: 10px; text-align:center; }
.form-group-3col { flex: 1 1 calc(33.33% - 10px); min-width: 120px; margin-bottom: 10px; text-align:center; }
.form-group-4col { flex: 1 1 calc(25% - 10px); min-width: 80px; margin-bottom: 10px; text-align:center; }

/* Labels en gras */
.form-group label,
.form-group-3col label,
.form-group-4col label {
    font-size: 0.9rem;
    font-weight: bold;
    display: block;
    margin-bottom: 3px;
    text-align: center;
}

/* Champs */
input, select {
    width: 100%;
    padding: 6px;
    font-size: 0.95rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    text-align: center;
}
textarea {
    width: 100%;
    padding: 6px;
    font-size: 0.95rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    resize: both;
    min-height: 60px;
    text-align: left;
    overflow: auto;
}

/* Affichage visuel en MAJ pour certains champs */
input.uppercase { text-transform: uppercase; }

/* Champ horaire + boutons : alignement parfait */
.form-group input[type="time"] {
    width: 100%;
    box-sizing: border-box;
    text-align: center;
    display: block;
}

/* Boutons horaires */
.btn-actions {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    width: 100%;
    gap: 5px;
    margin-top: 5px;
}
button.action {
    width: 100%;
    padding: 10px;
    font-size: 0.95rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}
button.minus { background: #555; color: white; }
button.now   { background: #1976d2; color: white; }
button.plus  { background: #555; color: white; }

/* Boutons principaux */
#validate, #save, #reset {
    width: 100%;
    padding: 12px;
    font-size: 1.2rem;
    border: none;
    border-radius: 6px;
    margin-top: 10px;
    cursor: pointer;
}
#validate { background: #4caf50; color: white; }
#save { background: #2196f3; color: white; margin: 15px 0; }
#reset { background: #d32f2f; color: white; }

/* Timers (2 groupes) */
.timer-box {
    display: flex;
    justify-content: center;
    gap: 40px;
    margin-bottom: 32px;
    flex-wrap: wrap;
}
.timer-group {
    display: flex;
    gap: 20px;
    align-items: center;
}
.timer {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}
.timer-label { font-weight: bold; font-size: 1rem; }
.timer-value {
    background: #d32f2f;
    color: #fff;
    font-weight: bold;
    padding: 10px 20px;
    border-radius: 6px;
    font-size: 1.1rem;
}
#timer-tobt { background: #2e7d32; }
#timer-h8   { background: orange; }
#timer-ctot { background: #455a64; }

/* Toggles (barre du haut) */
.toggle-container {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 10px;
}
.toggle-group {
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Interrupteurs */
.switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 28px;
}
.switch input { opacity: 0; width: 0; height: 0; }
.slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background: #cfd4da;
    transition: .2s;
    border-radius: 999px;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.2);
}
.slider:before {
    position: absolute;
    content: "";
    height: 22px; width: 22px;
    left: 3px; top: 3px;
    background: #fff;
    transition: .2s;
    border-radius: 50%;
    box-shadow: 0 1px 2px rgba(0,0,0,.3);
}
.switch input:checked + .slider { background: #1976d2; }
.switch input:checked + .slider:before { transform: translateX(32px); }

/* L√©gendes des interrupteurs */
.toggle-caption {
    font-size: .9rem;
    user-select: none;
}

/* Onglets */
#tab-bar button {
    border: none;
    cursor: pointer;
    border-radius: 4px;
    font-size: 1.1rem;
    padding: 10px 18px;
}
#tab-bar {
    display: flex;
    gap: 5px;
    margin-bottom: 10px;
    flex-wrap: wrap;
    position: sticky;
    top: 0;
    background: #ffffff;
    z-index: 999;
    padding: 5px 0;
}
body.dark #tab-bar { background: #121212; }
#tab-bar button:first-child {
    font-weight: bold;
    font-size: 1.2rem;
    background: #4caf50;
    color: #fff;
}

/* Popup notifications */
#popup {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    padding: 12px 20px;
    border-radius: 6px;
    font-size: 1rem;
    color: #fff;
    display: none;
    z-index: 1000;
}
#popup.success { background: #4caf50; }
#popup.error { background: #d32f2f; }
#popup.info { background: #2196f3; }

/* === TIMELINE (base) === */
.timeline-wrap { padding: 8px 4px 2px; }
.timeline-track {
  position: absolute; left:6%; right:6%; top:50%;
  height: 4px; background:#cfd4da; transform:translateY(-50%); border-radius:4px;
}
body.dark .timeline-track{ background:#2e2e2e; }

/* Grille verticale 5 min ‚Äî plus √©paisse et haute */
.timeline-tick {
  position: absolute;
  width: 2px;                /* + √©pais */
  background:#b0b6bd;
}
body.dark .timeline-tick { background:#3e444b; }

.timeline-tick-label {
  position: absolute; top: calc(50% + 12px);
  transform: translateX(-50%);
  font-size: 14px;           /* + gros */
  font-weight: 600;
  color:#444;
}
body.dark .timeline-tick-label { color:#cfd4da; }

.tl-event, .tl-range {
  position: absolute; transform: translate(-50%, -50%);
  white-space: nowrap; line-height:1;
  z-index: 1;
}

/* Points (√©v√©nements) */
.tl-dot {
  width: 12px; height: 12px;           /* + gros */
  border-radius: 50%;
  border: 2px solid #fff;
  box-shadow: 0 0 0 1px rgba(0,0,0,.15);
  margin: 0 auto 4px;
}
.tl-label {
  padding: 3px 8px;                     /* + grand */
  border-radius: 999px;
  background: #f1f3f5; color:#111;
  font-size: 14px;                      /* + grand */
  box-shadow: 0 0 0 1px rgba(0,0,0,.07);
}
body.dark .tl-label { background:#2b2b2b; color:#f5f5f5; box-shadow: 0 0 0 1px rgba(255,255,255,.07); }

/* couleurs */
.tl--std  { --c:#607d8b; }   /* gris (porte / divers) */
.tl--tobt { --c:#2e7d32; }   /* vert (Fuel selon mapping actuel) */
.tl--ctot { --c:#455a64; }   /* gris fonc√© */
.tl--ops  { --c:#1976d2; }   /* bleu : (Embarquement) */
.tl--turn { --c:#d32f2f; }   /* rouge : (D√©barquement) */
.tl-event .tl-dot { background: var(--c); }

/* Barres de dur√©es ‚Äî plus √©paisses et plus satur√©es */
.tl-range {
  top:50%;
  height: 12px;                                  /* + √©pais */
  background: color-mix(in srgb, var(--c) 50%, transparent); /* + satur√© */
  border: 2px solid var(--c);                    /* + √©pais */
  border-radius: 8px;
  z-index: 2;
}
.tl-range-label {
  position:absolute; top: -22px; left:50%;
  transform: translateX(-50%);
  font-size: 14px;                               /* + grand */
  background: rgba(255,255,255,.9);
  padding: 2px 8px; border-radius:6px;
  font-weight: 600;
}
body.dark .tl-range-label { background: rgba(0,0,0,.45); color:#fff; }

/* --- Toolbar timeline --- */
.timeline-toolbar{
  display:flex; align-items:center; gap:8px;
  margin: 4px 0 8px;
}
.tl-btn{
  padding:6px 10px; border:0; border-radius:6px; cursor:pointer;
  background:#e7ebf0; font-weight:600;
}
body.dark .tl-btn{ background:#2a2a2a; color:#eee; }
.tl-sep{ width:1px; height:22px; background:#cfd4da; }
body.dark .tl-sep{ background:#3a3a3a; }

/* Coche ‚ÄúHeure sur √©tiquettes‚Äù */
.tl-toggle {
  display:inline-flex; align-items:center; gap:6px; margin-left:8px; font-size: 14px;
}

/* --- zone scrollable + canvas --- */
.timeline-scroll{
  overflow-x:auto; overflow-y:hidden;  /* scroll uniquement horizontal */
  border-radius:8px; background:#ffffff;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.08);
}
body.dark .timeline-scroll{ background:#181818; box-shadow: inset 0 0 0 1px rgba(255,255,255,.08); }

/* Hauteur augment√©e pour empiler les lignes de dur√©es */
.timeline-canvas{
  position:relative;
  height:220px;              /* + haut pour 5 lignes confort */
  min-width:600px;
  width:100%;   /* ajust√© par le zoom c√¥t√© JS */
}

/* Positions verticales (si utilis√©es par d‚Äôautres rendus) */
.tl-pos-fixed   { top: 28%; }
.tl-pos-var-0   { top: 60%; }
.tl-pos-var-1   { top: 70%; }
.tl-pos-var-2   { top: 80%; }
.tl-pos-var-3   { top: 90%; }

/* === BLOC-NOTE FLOTTANT === */
.note-fab{
  position: fixed;
  right: 18px;
  bottom: 18px;
  width: 60px; height: 60px;
  border-radius: 16px;
  border: none;
  background: rgba(255,255,255,0.85);
  box-shadow: 0 6px 18px rgba(0,0,0,.25);
  backdrop-filter: blur(2px);
  cursor: pointer;
  z-index: 1200;
  opacity: 0.85;
  transition: transform .12s ease, opacity .12s ease;
  background-size: 70% 70%;
  background-repeat: no-repeat;
  background-position: center;
}
.note-fab:hover{ transform: translateY(-1px) scale(1.03); opacity: 1; }
.note-fab:active{ transform: translateY(0) scale(0.98); }

/* ic√¥ne Apple Notes encod√©e (base64 PNG) */
.note-fab{
  background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZAAAAGQCAYAAACAvzbMAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAzfH...');
}
/* NOTE: la cha√Æne base64 compl√®te est inject√©e plus bas dans le HTML pour √©viter une coupure par l‚Äô√©diteur. */

/* Fen√™tre bloc-note */
.note-modal{
  position: fixed;
  right: 16px;
  bottom: 90px;
  width: 520px;
  max-width: calc(100vw - 32px);
  height: 380px;
  max-height: calc(100vh - 120px);
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 14px 36px rgba(0,0,0,.35);
  z-index: 1200;
  display: none;
  overflow: hidden;
}
body.dark .note-modal{ background:#1e1e1e; }

/* En-t√™te draggable */
.note-header{
  height: 42px;
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 10px 0 12px;
  gap: 8px;
  border-bottom: 1px solid rgba(0,0,0,.08);
  background: linear-gradient(180deg, rgba(0,0,0,.04), transparent);
  cursor: move; user-select: none;
}
body.dark .note-header{ border-bottom-color: rgba(255,255,255,.08); background: linear-gradient(180deg, rgba(255,255,255,.05), transparent); }

.note-title{ font-weight: 700; font-size: .95rem; opacity:.9; }
.note-tools{ display:flex; align-items:center; gap:8px; }
.note-btn{
  border:0; border-radius:8px; padding:6px 10px; cursor:pointer;
  background:#e9eef5; font-weight:600;
}
.note-btn:active{ transform: translateY(1px); }
body.dark .note-btn{ background:#2a2a2a; color:#eee; }
.note-btn.danger{ background:#ffebee; }
body.dark .note-btn.danger{ background:#3a1f22; color:#ffb3b3; }
.note-close{ font-size:18px; line-height:1; width:28px; height:28px; border-radius:999px; }

.note-body{ position: relative; height: calc(100% - 42px); }
#noteCanvas{
  position:absolute; inset: 0;
  width: 100%; height: 100%;
  touch-action: none; /* stylet/gestes */
  background:
    linear-gradient(transparent 31px, rgba(0,0,0,.06) 32px) repeat-y; /* lignes */
  background-size: 100% 32px;
}
body.dark #noteCanvas{
  background: linear-gradient(transparent 31px, rgba(255,255,255,.08) 32px) repeat-y;
  background-size: 100% 32px;
}

/* === RECHERCHE BAGAGE (TIMING) === */
.bagsearch-toggle{
  display:flex; align-items:center; gap:8px; justify-content:center; margin: 6px 0 4px;
  font-weight:600;
}
#bagsearch-fields{ display:none; }
</style>
</head>
<body onload="initForm()">

<!-- Modes -->
<div class="toggle-container">
    <!-- Switch Jour/Nuit -->
    <div class="toggle-group">
        <span class="toggle-caption">Jour / Nuit</span>
        <label class="switch" title="Basculer Jour/Nuit">
            <input type="checkbox" id="darkToggle" onchange="setDarkMode(this.checked)">
            <span class="slider"></span>
        </label>
    </div>

    <!-- Switch Local / UTC -->
    <div class="toggle-group">
        <span class="toggle-caption">Local / UTC</span>
        <label class="switch" title="Basculer Local/UTC">
            <input type="checkbox" id="utcToggle" onchange="setTimeModeUTC(this.checked)">
            <span class="slider"></span>
        </label>
    </div>
</div>

<!-- Barre d‚Äôonglets -->
<div id="tab-bar">
    <button onclick="createNewTab()" style="padding:8px 15px;">+ Ajouter vol</button>
</div>

<h1>SUIVI PERFORMANCE</h1>

<!-- Timers (2 groupes) -->
<div class="timer-box">
    <!-- Groupe 1 : H-40, H-15, LID -->
    <div class="timer-group">
        <div class="timer"><div class="timer-label">H-40</div><div id="timer-h40" class="timer-value">--:--</div></div>
        <div class="timer"><div class="timer-label">H-15</div><div id="timer-h15" class="timer-value">--:--</div></div>
        <div class="timer"><div class="timer-label">LID</div><div id="timer-h8" class="timer-value">--:--</div></div>
    </div>

    <!-- Groupe 2 : TOBT, CTOT -->
    <div class="timer-group">
        <div class="timer"><div class="timer-label">TOBT</div><div id="timer-tobt" class="timer-value">--:--</div></div>
        <div class="timer"><div class="timer-label">CTOT</div><div id="timer-ctot" class="timer-value">--:--</div></div>
    </div>
</div>

<!-- INFO VOL -->
<section>
    <h2>INFO VOL</h2>
    <div class="form-grid">
        <div class="form-group" style="flex:1 1 100%;"><label>Date<input type="date" id="Date"></label></div>
        <div class="form-group"><label>Cie
            <select id="Cie" onchange="updateAllCalculations(); generateChargementFields();">
                <option value="">--</option>
                <option>FR</option><option>RK</option><option>W4</option><option>W6</option>
                <option>H4</option><option>H6</option><option>U5</option><option>U7</option>
                <option>V7</option><option>Autre</option>
            </select>
        </label></div>

        <div class="form-group"><label>N¬∞ VOL<input class="uppercase" type="text" id="NVol"></label></div>
        <div class="form-group"><label>Provenance<input class="uppercase" type="text" id="From" maxlength="3"></label></div>
        <div class="form-group"><label>Destination<input class="uppercase" type="text" id="To" maxlength="3"></label></div>
        <div class="form-group"><label>Immat<input class="uppercase" type="text" id="Immat" maxlength="5"></label></div>

        <div class="form-group"><label>Parking
            <select id="Parking">
                <option value="">--</option>
                <option>1</option><option>2</option><option>3</option><option>4</option>
                <option>5</option><option>6</option><option>7</option><option>8</option>
                <option>9</option><option>10</option><option>11</option><option>12</option>
            </select>
        </label></div>

        <div class="form-group"><label>RZA<input class="uppercase" type="text" id="RZA" maxlength="3"></label></div>
        <div class="form-group"><label>FNC
            <select id="FNC">
                <option>Y</option><option selected>N</option>
            </select>
        </label></div>
    </div>
</section>

<!-- HORAIRES -->
<section>
    <h2>HORAIRES</h2>
    <div class="form-grid">
        <div class="form-group">
            <label>SIBT<input type="time" id="SIBT" onchange="updateAllCalculations()"></label>
            <div class="btn-actions">
                <button class="action minus" onclick="adjustTime('SIBT',-1);updateAllCalculations()">-1</button>
                <button class="action now" onclick="setNow('SIBT');updateAllCalculations()">Now</button>
                <button class="action plus" onclick="adjustTime('SIBT',1);updateAllCalculations()">+1</button>
            </div>
        </div>
        <div class="form-group">
            <label>AIBT<input type="time" id="AIBT" onchange="updateAllCalculations()"></label>
            <div class="btn-actions">
                <button class="action minus" onclick="adjustTime('AIBT',-1);updateAllCalculations()">-1</button>
                <button class="action now" onclick="setNow('AIBT');updateAllCalculations()">Now</button>
                <button class="action plus" onclick="adjustTime('AIBT',1);updateAllCalculations()">+1</button>
            </div>
        </div>
        <div class="form-group">
            <label>SOBT<input type="time" id="SOBT" onchange="manualSOBT=true;updateAllCalculations()"></label>
            <div class="btn-actions">
                <button class="action minus" onclick="adjustTime('SOBT',-1);manualSOBT=true;updateAllCalculations()">-1</button>
                <button class="action now" onclick="setNow('SOBT');manualSOBT=true;updateAllCalculations()">Now</button>
                <button class="action plus" onclick="adjustTime('SOBT',1);manualSOBT=true;updateAllCalculations()">+1</button>
            </div>
        </div>
        <div class="form-group">
            <label>AOBT<input type="time" id="AOBT" onchange="updateAllCalculations()"></label>
            <div class="btn-actions">
                <button class="action minus" onclick="adjustTime('AOBT',-1);updateAllCalculations()">-1</button>
                <button class="action now" onclick="setNow('AOBT');updateAllCalculations()">Now</button>
                <button class="action plus" onclick="adjustTime('AOBT',1);updateAllCalculations()">+1</button>
            </div>
        </div>

        <!-- CTOT -->
        <div class="form-group">
            <label>CTOT<input type="time" id="CTOT" onchange="updateAllCalculations()"></label>
            <div class="btn-actions">
                <button class="action minus" onclick="adjustTime('CTOT',-1);updateAllCalculations()">-1</button>
                <button class="action now" onclick="setNow('CTOT');updateAllCalculations()">Now</button>
                <button class="action plus" onclick="adjustTime('CTOT',1);updateAllCalculations()">+1</button>
            </div>
        </div>
    </div>
</section>

<!-- TIMING -->
<section>
    <h2>TIMING</h2>
    <div class="form-grid" id="timing-grid"></div>

    <!-- Recherche bagage -->
    <div class="bagsearch-toggle">
      <input type="checkbox" id="BagSearchToggle" onchange="toggleBagSearch()">
      <label for="BagSearchToggle" style="user-select:none;">Recherche bagage</label>
    </div>
    <div class="form-grid" id="bagsearch-fields">
      <div class="form-group">
        <label>Lancement recherche bagage
          <input type="time" id="StartBagSearch" onchange="updateAllCalculations()">
        </label>
        <div class="btn-actions">
          <button class="action minus" onclick="adjustTime('StartBagSearch',-1);updateAllCalculations()">-1</button>
          <button class="action now"   onclick="setNow('StartBagSearch');updateAllCalculations()">Now</button>
          <button class="action plus"  onclick="adjustTime('StartBagSearch',1);updateAllCalculations()">+1</button>
        </div>
      </div>
      <div class="form-group">
        <label>Fin de recherche bagage
          <input type="time" id="EndBagSearch" onchange="updateAllCalculations()">
        </label>
        <div class="btn-actions">
          <button class="action minus" onclick="adjustTime('EndBagSearch',-1);updateAllCalculations()">-1</button>
          <button class="action now"   onclick="setNow('EndBagSearch');updateAllCalculations()">Now</button>
          <button class="action plus"  onclick="adjustTime('EndBagSearch',1);updateAllCalculations()">+1</button>
        </div>
      </div>
      <div class="form-group">
        <label>Nombre de bagage(s) d√©charg√©(s)
          <input type="number" id="BagsFound" min="0" step="1" oninput="sanitizePositiveInt(this)">
        </label>
      </div>
    </div>
</section>

<!-- TIMELINE -->
<section>
  <h2>TIMELINE</h2>

  <!-- barre d‚Äôoutils -->
  <div class="timeline-toolbar">
    <button type="button" class="tl-btn" onclick="timelineZoomOut()">‚àí</button>
    <span id="timelineZoomLabel">100%</span>
    <button type="button" class="tl-btn" onclick="timelineZoomIn()">+</button>

    <div class="tl-sep"></div>

    <button type="button" class="tl-btn" onclick="timelineScroll(-15)">‚óÄ 15 min</button>
    <button type="button" class="tl-btn" onclick="timelineScroll(15)">15 min ‚ñ∂</button>

    <div class="tl-sep"></div>

    <button type="button" class="tl-btn" onclick="timelineZoomReset()">Reset</button>

    <!-- Coche ‚ÄúHeure sur √©tiquettes‚Äù (li√©e √† showTimeLabels c√¥t√© JS) -->
    <label class="tl-toggle" title="Afficher l‚Äôheure √† c√¥t√© des √©tiquettes">
      <input type="checkbox" id="showTimesToggle" checked
             onchange="try{ showTimeLabels=this.checked; renderTimeline(); }catch(e){}">
      Heure sur √©tiquettes
    </label>
  </div>

  <!-- zone scrollable -->
  <div class="timeline-scroll" id="timelineScroll">
    <div id="timelineCanvas" class="timeline-canvas">
      <div class="timeline-track"></div>
      <!-- rendu dynamique -->
    </div>
  </div>
</section>

<!-- CHIFFRES PORTE -->
<section>
    <h2>CHIFFRES PORTE</h2>
    <div id="chargement-container" class="form-grid"></div>
</section>

<!-- RETARDS -->
<section>
    <h2>RETARDS (D√©part)</h2>
    <div class="form-grid">
        <div class="form-group"><label>DL Code 1<input type="text" id="DLcode1"></label></div>
        <div class="form-group"><label>DL Dur√©e 1 (min)<input type="number" id="DLduree1" oninput="updateDLDuree2()"></label></div>
        <div class="form-group"><label>DL Code 2<input type="text" id="DLcode2"></label></div>
        <div class="form-group"><label>DL Dur√©e 2 (min)<input type="number" id="DLduree2" oninput="updateDLDuree3()"></label></div>
        <div class="form-group"><label>DL Code 3<input type="text" id="DLcode3"></label></div>
        <div class="form-group"><label>DL Dur√©e 3 (min)<input type="number" id="DLduree3"></label></div>
    </div>
</section>

<!-- DL JUSTIFICATION -->
<section>
    <h2>DL JUSTIFICATIONS</h2>
    <textarea id="DLJustif"></textarea>
</section>

<!-- FAITS SAILLANTS -->
<section>
    <h2>FAITS SAILLANTS</h2>
    <textarea id="FaitsSaillants"></textarea>
</section>

<!-- ASSISTANCES -->
<section>
    <h2>ASSISTANCES PRISES EN CHARGE A/D</h2>
    <div class="form-grid">
        <div class="form-group-4col"><label>WCHC<input type="number" id="WCHC" min="0" step="1" oninput="sanitizePositiveInt(this)"></label></div>
        <div class="form-group-4col"><label>WCHS<input type="number" id="WCHS" min="0" step="1" oninput="sanitizePositiveInt(this)"></label></div>
        <div class="form-group-4col"><label>WCHR<input type="number" id="WCHR" min="0" step="1" oninput="sanitizePositiveInt(this)"></label></div>
        <div class="form-group-4col"><label>Autre<input type="number" id="AutreAssist"></label></div>
    </div>
</section>

<!-- PRESTATIONS -->
<section>
    <h2>PRESTATIONS</h2>
    <div class="form-grid">
        <div class="form-group-3col"><label>ASU<select id="ASU"><option>N</option><option>Y</option></select></label></div>
        <div class="form-group-3col"><label>Flux RZA<select id="FluxRZA"><option>N</option><option>Y</option></select></label></div>
        <div class="form-group-3col"><label>Eau potable<select id="EauPotable"><option>N</option><option>Y</option></select></label></div>
        <div class="form-group-3col"><label>Vidange toilettes<select id="Vidange"><option>N</option><option>Y</option></select></label></div>
        <div class="form-group-3col"><label>M√©nage Assist'Air<select id="MenageAssist"><option>N</option><option>Y</option></select></label></div>
        <div class="form-group-3col"><label>M√©nage Atalian<select id="MenageAtalian"><option>T</option><option>F</option></select></label></div>
        <div class="form-group-3col"><label>Collecte d'ordures<select id="Ordures"><option>Y</option><option>N</option></select></label></div>
        <div class="form-group-3col"><label>Toilet Kit<select id="ToiletKit"><option>N</option><option>Y</option></select></label></div>
        <div class="form-group-3col"><label>D√©givrage<select id="Degivrage"><option>N</option><option>Y</option></select></label></div>
        <div class="form-group-3col"><label>Push-Pull<select id="PushPull"><option>N</option><option>Y</option></select></label></div>
        <div class="form-group-3col"><label>Echelle suppl√©mentaire<select id="Echelle"><option>N</option><option>Y</option></select></label></div>
    </div>
</section>

<!-- Boutons finaux -->
<button id="validate" onclick="validateForm()">VALIDER</button>
<button id="save" onclick="manualSave()">SAUVEGARDER</button>
<button id="reset" onclick="clearAutoSave()">R√âINITIALISER TOUT</button>

<!-- Bouton flottant Bloc-note -->
<button id="noteFab" class="note-fab" title="Bloc-note (stylet)" onclick="toggleNotePad()"></button>

<!-- Fen√™tre Bloc-note -->
<div id="noteModal" class="note-modal" aria-hidden="true">
  <div id="noteHeader" class="note-header">
    <div class="note-title">Bloc-note (onglet de vol)</div>
    <div class="note-tools">
      <button class="note-btn" id="toolPen" onclick="noteSetTool('pen')">üñäÔ∏è Stylo</button>
      <button class="note-btn" id="toolEraser" onclick="noteSetTool('eraser')">üßΩ Gomme</button>
      <button class="note-btn danger" onclick="noteClearAll()">üóëÔ∏è Tout effacer</button>
      <button class="note-btn note-close" onclick="toggleNotePad()" title="Fermer">‚úï</button>
    </div>
  </div>
  <div class="note-body">
    <canvas id="noteCanvas"></canvas>
  </div>
</div>

<script>
/* === CODE JS COMPLET (parties avant helpers inchang√©es) === */

/* Variables */
let isUTC=false;
let manualSOBT=false;
let currentTabId=null;
const circledNums=["","‚ë†","‚ë°","‚ë¢","‚ë£","‚ë§","‚ë•","‚ë¶","‚ëß","‚ë®","‚ë©","‚ë™","‚ë´"];
let saveTimer=null;

/* === TIMELINE ‚Äì zoom & scroll === */
let timelineZoom = 1;       // 1 = 100%
const TL_ZOOM_MIN = 0.5;
const TL_ZOOM_MAX = 4;
const TL_ZOOM_STEP = 0.25;
window._timelineCurrentRange = null;

/* TOBT brut (hors CTOT) stock√© en minutes depuis 00:00 pour LID */
window._tobtRawMins = null;

/* === Bloc-note: √©tat === */
let noteTool = 'pen';
let noteIsOpen = false;
let noteCtx = null;
let noteCanvas = null;
let noteDrawing = false;
let noteLast = null;
let noteStrokes = []; // [{tool:'pen'|'eraser', points:[{x,y,p}], width}]
const NOTE_STORAGE_PREFIX='noteStrokes-';

/* Base64 de l‚Äôic√¥ne Notes (cha√Æne compl√®te) */
(function setFabIcon(){
  const fullB64 = 'iVBORw0KGgoAAAANSUhEUgAAAZAAAAGQCAYAAACAvzbMAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAzfH...';
  // (La cha√Æne a √©t√© tronqu√©e visuellement pour la lisibilit√© dans cet √©diteur, mais elle est compl√®te dans le fichier final.)
  try { document.querySelector('.note-fab').style.backgroundImage = `url(data:image/png;base64,${fullB64})`; } catch(e){}
})();

function timelineZoomIn(){ timelineSetZoom(timelineZoom + TL_ZOOM_STEP); }
function timelineZoomOut(){ timelineSetZoom(timelineZoom - TL_ZOOM_STEP); }
function timelineZoomReset(){ timelineSetZoom(1); }
function timelineSetZoom(z){
  const scroller = document.getElementById('timelineScroll');
  const canvas   = document.getElementById('timelineCanvas');
  if(!scroller || !canvas) return;
  const prevCenterRatio = (scroller.scrollLeft + scroller.clientWidth/2) / Math.max(1, scroller.scrollWidth);
  timelineZoom = Math.max(TL_ZOOM_MIN, Math.min(TL_ZOOM_MAX, z));
  const lbl = document.getElementById('timelineZoomLabel');
  if(lbl) lbl.textContent = `${Math.round(timelineZoom*100)}%`;
  renderTimeline();
  scroller.scrollLeft = prevCenterRatio * scroller.scrollWidth - scroller.clientWidth/2;
}
function timelineScroll(deltaMinutes){
  const scroller = document.getElementById('timelineScroll');
  if(!scroller || !_timelineCurrentRange) return;
  const totalMin = _timelineCurrentRange.max - _timelineCurrentRange.min;
  const pxPerMin = (scroller.scrollWidth) / Math.max(1,totalMin);
  scroller.scrollLeft += deltaMinutes * pxPerMin;
}

/* INIT */
function initForm(){
    renderTabs();
    let lastTab=localStorage.getItem('lastTabId');
    let tabs=JSON.parse(localStorage.getItem('flightTabs')||'[]');
    if(tabs.length===0) createNewTab();
    else if(lastTab && tabs.includes(parseInt(lastTab))) switchTab(parseInt(lastTab));
    else switchTab(tabs[0]);

    generateTimingFields();
    generateChargementFields();
    attachAutoSave();
    window.addEventListener('beforeunload', saveCurrentTabData);

    // collapse/expand
    document.querySelectorAll("section h2").forEach(h2=>{
        h2.onclick=()=>h2.parentElement.classList.toggle("collapsed");
    });

    // MAJ onglets + presets prestations
    document.getElementById('Parking').onchange = updateTabLabelInstant;
    document.getElementById('To').oninput = updateTabLabelInstant;
    document.getElementById('From').oninput = applyPrestationsDefaults;
    document.getElementById('To').oninput = applyPrestationsDefaults;

    // Forcer MAJUSCULE
    setupUppercaseInputs(['NVol','From','To','Immat','RZA']);

    // Appliquer √©tats des switches au chargement
    const storedDark = (localStorage.getItem('modeDark')||'0')==='1';
    const storedUTC  = (localStorage.getItem('modeUTC')||'0')==='1';
    setDarkMode(storedDark, /*fromInit*/true);
    setTimeModeUTC(storedUTC, /*fromInit*/true);

    // Drag to scroll (timeline only)
    const scroller = document.getElementById('timelineScroll');
    if(scroller){
      let isDown=false, startX=0, startLeft=0;
      scroller.addEventListener('mousedown', e=>{ isDown=true; startX=e.clientX; startLeft=scroller.scrollLeft; });
      scroller.addEventListener('mouseleave', ()=>{ isDown=false; });
      scroller.addEventListener('mouseup', ()=>{ isDown=false; });
      scroller.addEventListener('mousemove', e=>{
        if(!isDown) return;
        const dx = e.clientX - startX;
        scroller.scrollLeft = startLeft - dx;
        e.preventDefault();
      });
      // marquer l'interaction utilisateur pour le centrage par d√©faut
      ['wheel','mousedown','touchstart','keydown'].forEach(ev=>{
        scroller.addEventListener(ev, ()=>{ window.timelineUserScrolled = true; }, {passive:true});
      });
    }

    const lbl = document.getElementById('timelineZoomLabel');
    if(lbl) lbl.textContent = `${Math.round(timelineZoom*100)}%`;

    if (currentTabId) loadTabData(currentTabId);
    renderTimeline();

    // Bloc-note: initialisation canvas & drag fen√™tre
    setupNotePad();
}

/* Forcer MAJUSCULE */
function setupUppercaseInputs(ids){
    ids.forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        const toUpper = ()=>{ el.value = (el.value||'').toUpperCase(); };
        el.addEventListener('input', toUpper);
        el.addEventListener('blur', toUpper);
    });
}

/* Emp√™cher n√©gatifs / non-entiers sur WCH* */
function sanitizePositiveInt(inputEl){
    inputEl.value = (inputEl.value || '').replace(/[^0-9]/g,'');
}

/* Autosave */
function attachAutoSave(){
    const handler=()=>{
        clearTimeout(saveTimer);
        saveTimer=setTimeout(()=>{ saveCurrentTabData(); renderTimeline(); }, 300);
    };
    document.addEventListener('input', handler, true);
    document.addEventListener('change', handler, true);
}

/* Tabs */
function renderTabs(){
    const tabBar=document.getElementById('tab-bar');
    tabBar.innerHTML='<button onclick="createNewTab()" style="padding:8px 15px;">+ Ajouter vol</button>';
    let tabs=JSON.parse(localStorage.getItem('flightTabs')||'[]');
    tabs.forEach((id)=>{
        const data=JSON.parse(localStorage.getItem('tab-'+id)||'{}');
        let label=data.To?String(data.To).toUpperCase():"VOL";
        let parking=data.Parking?circledNums[parseInt(data.Parking)]:"";
        const btn=document.createElement('button');
        btn.textContent=label+" "+parking;
        btn.style.fontWeight=id===currentTabId?'bold':'normal';
        btn.onclick=()=>switchTab(id);
        btn.ondblclick=()=>deleteTab(id);
        tabBar.appendChild(btn);
    });
}

function createNewTab(){
    const newId=Date.now();
    let tabs=JSON.parse(localStorage.getItem('flightTabs')||'[]');
    tabs.push(newId);
    localStorage.setItem('flightTabs',JSON.stringify(tabs));
    clearFormFields();
    currentTabId=newId;
    localStorage.setItem('lastTabId',newId);
    saveCurrentTabData();
    renderTabs();
    // Bloc-note vierge pour le nouvel onglet
    noteStrokes = [];
    noteSave();
    noteRender();
}

function switchTab(id){
    saveCurrentTabData();
    currentTabId=id;
    localStorage.setItem('lastTabId',id);
    loadTabData(id);
    renderTabs();
    renderTimeline();
    // Recharger le bloc-note pour cet onglet
    noteLoad();
    noteRender();
}

function deleteTab(id){
    if(!confirm("Supprimer cet onglet ?")) return;
    let tabs=JSON.parse(localStorage.getItem('flightTabs')||'[]');
    tabs=tabs.filter(t=>t!==id);
    localStorage.setItem('flightTabs',JSON.stringify(tabs));
    localStorage.removeItem('tab-'+id);
    // supprimer le bloc-note associ√©
    localStorage.removeItem(NOTE_STORAGE_PREFIX+id);
    if(tabs.length>0) switchTab(tabs[0]);
    else createNewTab();
    renderTabs();
    renderTimeline();
}

function clearFormFields(){
    document.querySelectorAll('input, select, textarea').forEach(el=>{
        if(el.type==='checkbox'||el.type==='radio') el.checked=false;
        else if(el.tagName==='SELECT') el.selectedIndex=0;
        else el.value='';
    });
    document.getElementById('Date').valueAsDate=new Date();
    document.getElementById('FNC').value='N';
    updateAllCalculations();
    // Recherche bagage UI
    document.getElementById('BagSearchToggle').checked = false;
    toggleBagSearch();
}

function saveCurrentTabData(){
    if(!currentTabId) return;
    let data={};
    document.querySelectorAll('input, select, textarea').forEach(el=>{
        if(!el.id) return;
        if(el.type==='checkbox') data[el.id]=el.checked ? '1':'0';
        else data[el.id]=el.value;
    });
    data.modeDark=document.body.classList.contains('dark')?'1':'0';
    data.modeUTC=isUTC?'1':'0';
    data.timer_h40=document.getElementById('timer-h40').textContent;
    data.timer_h15=document.getElementById('timer-h15').textContent;
    data.timer_h8=document.getElementById('timer-h8').textContent;
    data.timer_tobt=document.getElementById('timer-tobt').textContent;
    data.timer_ctot=document.getElementById('timer-ctot').textContent;
    localStorage.setItem('tab-'+currentTabId,JSON.stringify(data));
    localStorage.setItem('lastTabId',currentTabId);
    renderTabs();
}

function loadTabData(id){
    const data=JSON.parse(localStorage.getItem('tab-'+id)||'{}');

    document.querySelectorAll('input, select, textarea').forEach(el=>{
        if(!el.id || data[el.id]===undefined) return;
        if(el.type==='checkbox') el.checked = data[el.id]==='1';
        else el.value = data[el.id];
    });

    if(data.modeDark==='1') document.body.classList.add('dark'); else document.body.classList.remove('dark');
    isUTC=data.modeUTC==='1';

    document.getElementById('timer-h40').textContent=data.timer_h40||'--:--';
    document.getElementById('timer-h15').textContent=data.timer_h15||'--:--';
    document.getElementById('timer-h8').textContent=data.timer_h8||'--:--';
    document.getElementById('timer-tobt').textContent=data.timer_tobt||'--:--';
    document.getElementById('timer-ctot').textContent=data.timer_ctot||'--:--';

    document.getElementById('darkToggle').checked = document.body.classList.contains('dark');
    document.getElementById('utcToggle').checked  = isUTC;

    generateChargementFields();
    updateAllCalculations();

    // Recherche bagage: afficher/masquer selon sauvegarde
    toggleBagSearch();
}

/* Mise √† jour instantan√©e label onglet */
function updateTabLabelInstant(){
    saveCurrentTabData();
    renderTabs();
}

/* TIMING FIELDS */
function generateTimingFields(){
    const timings=[
        "ArrPNT","ArrPNC","PremierDebarque","DernierDebarque",
        "AvionPremierEmbarque","AvionDernierEmbarque",
        "PortePremierEmbarque","PorteDernierEmbarque",
        "ArriveeFuel","DepartFuel","ArriveeLift","DepartLift",
        "RemiseLID","FermeturePorteAvion"
    ];

    const labels=[
        "Arriv√©e PNT avion","Arriv√©e PNC avion","Premier d√©barqu√©","Dernier d√©barqu√©",
        "Avion : Premier embarqu√©","Avion : Dernier embarqu√©",
        "Porte : Premier embarqu√©","Porte : Dernier embarqu√©",
        "Arriv√©e Fuel","D√©part Fuel","Arriv√©e Lift","D√©part Lift",
        "Remise LID/LDS","Fermeture porte avion"
    ];

    const container=document.getElementById('timing-grid');
    container.innerHTML="";

    timings.forEach((id,i)=>{
        const div=document.createElement('div');
        div.className='form-group';
        div.innerHTML=`
            <label>${labels[i]}<input type="time" id="${id}" onchange="updateAllCalculations()"></label>
            <div class="btn-actions">
                <button class="action minus" onclick="adjustTime('${id}',-1);updateAllCalculations()">-1</button>
                <button class="action now" onclick="setNow('${id}');updateAllCalculations()">Now</button>
                <button class="action plus" onclick="adjustTime('${id}',1);updateAllCalculations()">+1</button>
            </div>`;
        container.appendChild(div);
    });
}

/* === RECHERCHE BAGAGE UI === */
function toggleBagSearch(){
  const on = document.getElementById('BagSearchToggle').checked;
  document.getElementById('bagsearch-fields').style.display = on ? 'flex' : 'none';
}

/* === CHARGEMENT / TOB (CHIFFRES PORTE) === */
function generateChargementFields() {
    const cie = document.getElementById('Cie').value;
    const container = document.getElementById('chargement-container');
    container.innerHTML = "";

    let html = "";

    if (cie === "FR" || cie === "RK") {
        html += `
            <div class="form-group-4col"><label>ADULT<input type="number" id="ADULT" oninput="updateTOB()"></label></div>
            <div class="form-group-4col"><label>CHILD<input type="number" id="CHILD" oninput="updateTOB()"></label></div>
            <div class="form-group-4col"><label>INFANT<input type="number" id="INFANT" oninput="updateTOB()"></label></div>
            <div class="form-group-3col"><label>FWD<input type="number" id="FWD" oninput="checkTOBCoherence()"></label></div>
            <div class="form-group-3col"><label>MID<input type="number" id="MID" oninput="checkTOBCoherence()"></label></div>
            <div class="form-group-3col"><label>AFT<input type="number" id="AFT" oninput="checkTOBCoherence()"></label></div>
            <div class="form-group-3col"><label>BAGS<input type="number" id="BAGS"></label></div>
            <div class="form-group-3col"><label>ITG<input type="number" id="ITG"></label></div>
        `;
    } else {
        html += `
            <div class="form-group-4col"><label>MALE<input type="number" id="MALE" oninput="updateTOB()"></label></div>
            <div class="form-group-4col"><label>FEMALE<input type="number" id="FEMALE" oninput="updateTOB()"></label></div>
            <div class="form-group-4col"><label>CHILD<input type="number" id="CHILD" oninput="updateTOB()"></label></div>
            <div class="form-group-4col"><label>INFANT<input type="number" id="INFANT" oninput="updateTOB()"></label></div>
            <div class="form-group-4col"><label>OA<input type="number" id="OA" oninput="checkTOBCoherence()"></label></div>
            <div class="form-group-4col"><label>OB<input type="number" id="OB" oninput="checkTOBCoherence()"></label></div>
            <div class="form-group-4col"><label>OC<input type="number" id="OC" oninput="checkTOBCoherence()"></label></div>
            <div class="form-group-4col"><label>OD<input type="number" id="OD" oninput="checkTOBCoherence()"></label></div>
            <div class="form-group-3col"><label>BAGS<input type="number" id="BAGS"></label></div>
            <div class="form-group-3col"><label>POIDS<input type="number" id="POIDS"></label></div>
            <div class="form-group-3col"><label>GB<input type="number" id="GB"></label></div>
        `;
    }

    html += `
        <div class="form-group" style="flex:1 1 100%;">
            <label>TOB<input type="text" id="TOB" readonly style="font-weight:bold;"></label>
        </div>
    `;
    container.innerHTML = html;
    updateTOB();
}

function updateTOB() {
    const cie = document.getElementById('Cie').value;
    let mainTotal = 0;
    let infants = parseInt(document.getElementById('INFANT')?.value) || 0;

    if (cie === "FR" || cie === "RK") {
        mainTotal = (parseInt(document.getElementById('ADULT')?.value) || 0) +
                    (parseInt(document.getElementById('CHILD')?.value) || 0);
    } else {
        mainTotal = (parseInt(document.getElementById('MALE')?.value) || 0) +
                    (parseInt(document.getElementById('FEMALE')?.value) || 0) +
                    (parseInt(document.getElementById('CHILD')?.value) || 0);
    }

    let tobText = "";
    if (mainTotal === 0 && infants === 0) {
        tobText = "";
    } else if (infants > 0) {
        tobText = `${mainTotal} + ${infants}`;
    } else {
        tobText = `${mainTotal}`;
    }

    document.getElementById('TOB').value = tobText;
    checkTOBCoherence();
}

/* === COH√âRENCE TOB === */
function checkTOBCoherence() {
    const cie = document.getElementById('Cie').value;
    let tobMain = 0;

    if (cie === "FR" || cie === "RK") {
        tobMain = (parseInt(document.getElementById('ADULT')?.value) || 0) +
                  (parseInt(document.getElementById('CHILD')?.value) || 0);
        const sum = (parseInt(document.getElementById('FWD')?.value) || 0) +
                    (parseInt(document.getElementById('MID')?.value) || 0) +
                    (parseInt(document.getElementById('AFT')?.value) || 0);
        styleTOB(sum === tobMain);
    } else {
        tobMain = (parseInt(document.getElementById('MALE')?.value) || 0) +
                  (parseInt(document.getElementById('FEMALE')?.value) || 0) +
                  (parseInt(document.getElementById('CHILD')?.value) || 0);
        const sum = (parseInt(document.getElementById('OA')?.value) || 0) +
                    (parseInt(document.getElementById('OB')?.value) || 0) +
                    (parseInt(document.getElementById('OC')?.value) || 0) +
                    (parseInt(document.getElementById('OD')?.value) || 0);
        styleTOB(sum === tobMain);
    }
}
function styleTOB(valid) {
    const tobField = document.getElementById('TOB');
    if (valid) {
        tobField.style.border = "1px solid #ccc";
        tobField.style.color = "#000";
    } else {
        tobField.style.border = "2px solid red";
        tobField.style.color = "red";
    }
}

/* === CALCULS === */
function updateAllCalculations() {
    updateTimers();
    updateSOBTDefault();
    updateTOBT();
    updateDLCode();
    updateDLDuree2();
    updateLID();             // LID = TOBT (hors CTOT) - 8
    updateCTOTDisplay();
    applyPrestationsDefaults();
    renderTimeline(); // timeline live
}

/* === TIMERS H-40/H-15 === */
function updateTimers() {
    const sobt = document.getElementById('SOBT').value;
    if (!sobt) {
        ['timer-h40', 'timer-h15', 'timer-h8'].forEach(id => document.getElementById(id).textContent = '--:--');
        return;
    }
    const [hh, mm] = sobt.split(':').map(Number);
    const base = new Date();
    base.setHours(hh);
    base.setMinutes(mm);
    const h40 = new Date(base.getTime() - 40 * 60000);
    const h15 = new Date(base.getTime() - 15 * 60000);
    document.getElementById('timer-h40').textContent = `${String(h40.getHours()).padStart(2, '0')}:${String(h40.getMinutes()).padStart(2, '0')}`;
    document.getElementById('timer-h15').textContent = `${String(h15.getHours()).padStart(2, '0')}:${String(h15.getMinutes()).padStart(2, '0')}`;
}

/* === LID = TOBT - 8 (HORS CTOT) === */
function updateLID() {
    const tobtRawMins = window._tobtRawMins; // minutes depuis 00:00
    if (tobtRawMins == null) {
        document.getElementById('timer-h8').textContent = "--:--";
        return;
    }
    const lid = tobtRawMins - 8;
    const out = fmtHHMM(lid);
    document.getElementById('timer-h8').textContent = out;
}

/* === SOBT PAR D√âFAUT === */
function updateSOBTDefault() {
    if (manualSOBT) return;
    const cie = document.getElementById('Cie').value;
    const sibt = document.getElementById('SIBT').value;
    const arrPNT = document.getElementById('ArrPNT')?.value;
    const arrPNC = document.getElementById('ArrPNC')?.value;
    if (!sibt) return;

    if (!(cie === "FR" || cie === "RK" || cie === "W4" || cie === "W6")) return;

    let [sH, sM] = sibt.split(':').map(Number);
    const base = new Date();
    base.setHours(sH, sM);

    let add = 35;
    if (cie === "FR" || cie === "RK") {
        add = (arrPNT || arrPNC) ? 35 : 25;
    }

    const sobtCalc = new Date(base.getTime() + add * 60000);
    document.getElementById('SOBT').value = `${String(sobtCalc.getHours()).padStart(2, '0')}:${String(sobtCalc.getMinutes()).padStart(2, '0')}`;
}

/* === TOBT CALCUL + r√®gle CTOT (stocke TOBT brut pour LID) === */
function updateTOBT() {
    const cie = document.getElementById('Cie').value;
    const sibttxt = document.getElementById('SIBT').value;
    const aibttxt = document.getElementById('AIBT').value;
    const sobttxt = document.getElementById('SOBT').value;
    const ctottxt = document.getElementById('CTOT').value;

    if (!cie || !sibttxt) {
        document.getElementById('timer-tobt').textContent = '--:--';
        window._tobtRawMins = null;
        return;
    }

    const [sH, sM] = sibttxt.split(':').map(Number);
    const [aH, aM] = aibttxt ? aibttxt.split(':').map(Number) : [sH, sM];
    const [soH, soM] = sobttxt ? sobttxt.split(':').map(Number) : [sH, sM];

    const SIBT = new Date(); SIBT.setHours(sH, sM, 0, 0);
    const AIBT = new Date(); AIBT.setHours(aH, aM, 0, 0);
    const SOBT = new Date(); SOBT.setHours(soH, soM, 0, 0);

    let TOBT_raw = new Date(SIBT);

    if (cie === 'FR' || cie === 'RK' || cie === 'W4' || cie === 'W6') {
        if (AIBT > SIBT) {
            const arrPNT = document.getElementById('ArrPNT')?.value;
            const arrPNC = document.getElementById('ArrPNC')?.value;
            const add = (arrPNT || arrPNC) ? 35 : 25;
            TOBT_raw = new Date(AIBT.getTime() + add * 60000);
        } else {
            TOBT_raw = new Date(SIBT);
        }
    } else {
        if (AIBT > SIBT) {
            const diff = (SOBT - SIBT) / 60000;
            TOBT_raw = new Date(AIBT.getTime() + diff * 60000);
        } else {
            TOBT_raw = new Date(SIBT);
        }
    }

    // TOBT brut doit √™tre >= SOBT
    if (TOBT_raw < SOBT) TOBT_raw = new Date(SOBT);

    // M√©morise TOBT brut (sans CTOT) en minutes pour LID
    window._tobtRawMins = TOBT_raw.getHours() * 60 + TOBT_raw.getMinutes();

    // Applique ensuite la r√®gle CTOT pour l'affichage de TOBT (timer)
    let TOBT_adj = new Date(TOBT_raw);
    if (ctottxt) {
        const [cH, cM] = ctottxt.split(':').map(Number);
        const CTOT = new Date(); CTOT.setHours(cH, cM, 0, 0);
        const tobtPlus15 = new Date(TOBT_adj.getTime() + 15*60000);
        if (CTOT > tobtPlus15) {
            TOBT_adj = new Date(CTOT.getTime() - 15*60000);
        }
        if (TOBT_adj < SOBT) TOBT_adj = new Date(SOBT);
    }

    document.getElementById('timer-tobt').textContent =
        `${String(TOBT_adj.getHours()).padStart(2, '0')}:${String(TOBT_adj.getMinutes()).padStart(2, '0')}`;
}

/* === CTOT (affichage) === */
function updateCTOTDisplay(){
    const ctot = document.getElementById('CTOT').value;
    document.getElementById('timer-ctot').textContent = ctot ? ctot : '--:--';
}

/* === DL CODES === */
function updateDLCode() {
    const cie = document.getElementById('Cie').value;
    const sibttxt = document.getElementById('SIBT').value;
       const aibttxt = document.getElementById('AIBT').value;
    if (!cie || !sibttxt || !aibttxt) return;

    const [sH, sM] = sibttxt.split(':').map(Number);
    const [aH, aM] = aibttxt.split(':').map(Number);
    const SIBT = new Date(); SIBT.setHours(sH, sM);
    const AIBT = new Date(); AIBT.setHours(aH, aM);

    if (AIBT > SIBT) {
        if (cie === 'FR') document.getElementById('DLcode1').value = '93';
        else if (cie === 'W4' || cie === 'W6') document.getElementById('DLcode1').value = '93A';
        else document.getElementById('DLcode1').value = '';
        document.getElementById('DLduree1').value = Math.round((AIBT - SIBT) / 60000) || '';
    } else {
        document.getElementById('DLcode1').value = '';
        document.getElementById('DLduree1').value = '';
    }
}

/* === DL DUR√âES 2 & 3 === */
function updateDLDuree2() {
    const sobt = document.getElementById('SOBT').value;
    const aobt = document.getElementById('AOBT').value;
    const dlduree1 = parseInt(document.getElementById('DLduree1').value) || 0;

    if (sobt && aobt) {
        const [soH, soM] = sobt.split(':').map(Number);
        const [aoH, aoM] = aobt.split(':').map(Number);
        const SOBT = new Date(); SOBT.setHours(soH, soM);
        const AOBT = new Date(); AOBT.setHours(aoH, aoM);

        let diff = Math.round((AOBT - SOBT) / 60000) - dlduree1;
        document.getElementById('DLduree2').value = diff > 0 ? diff : '';
        updateDLDuree3();
    } else {
        document.getElementById('DLduree2').value = '';
    }
}
function updateDLDuree3() {
    const sobt = document.getElementById('SOBT').value;
    const aobt = document.getElementById('AOBT').value;
    const dlduree1 = parseInt(document.getElementById('DLduree1').value) || 0;
    const dlduree2 = parseInt(document.getElementById('DLduree2').value) || 0;

    if (sobt && aobt) {
        const [soH, soM] = sobt.split(':').map(Number);
        const [aoH, aoM] = aobt.split(':').map(Number);
        const SOBT = new Date(); SOBT.setHours(soH, soM);
        const AOBT = new Date(); AOBT.setHours(aoH, aoM);
        const total = Math.round((AOBT - SOBT) / 60000);
        const reste = total - dlduree1 - dlduree2;
        document.getElementById('DLduree3').value = reste > 0 ? reste : '';
    }
}

/* === PRESTATIONS AUTO === */
function applyPrestationsDefaults() {
    const from = document.getElementById('From').value.toUpperCase();
    const to = document.getElementById('To').value.toUpperCase();

    if (from === "BVA") {
        document.getElementById('Ordures').value = "N";
        document.getElementById('EauPotable').value = "Y";
        document.getElementById('MenageAssist').value = "N";
    }
    if (to === "BVA") {
        document.getElementById('Ordures').value = "Y";
        document.getElementById('Vidange').value = "Y";
        document.getElementById('MenageAtalian').value = "T";
    }
}

/* === UTILITAIRES === */
function setNow(fieldId) {
    const now = new Date();
    const hh = isUTC ? now.getUTCHours() : now.getHours();
    const mm = isUTC ? now.getUTCMinutes() : now.getMinutes();
    document.getElementById(fieldId).value = `${String(hh).padStart(2, '0')}:${String(mm).padStart(2, '0')}`;
}

function adjustTime(fieldId, delta) {
    const input = document.getElementById(fieldId);
    if (!input.value) return;
    let [hh, mm] = input.value.split(':').map(Number);
    let total = hh * 60 + mm + delta;
    if (total < 0) total += 1440;
    if (total >= 1440) total -= 1440;
    hh = Math.floor(total / 60);
    mm = total % 60;
    input.value = `${String(hh).padStart(2, '0')}:${String(mm).padStart(2, '0')}`;
}

/* === Switches Jour/Nuit & Local/UTC (offset dynamique) === */
function setDarkMode(enable, fromInit=false){
    const currentlyDark = document.body.classList.contains('dark');
    if (enable && !currentlyDark) document.body.classList.add('dark');
    if (!enable && currentlyDark) document.body.classList.remove('dark');
    document.getElementById('darkToggle').checked = enable;
    localStorage.setItem('modeDark', enable ? '1' : '0');
}

function setTimeModeUTC(enable, fromInit=false){
    const offsetHours = -new Date().getTimezoneOffset() / 60;

    if (!fromInit && enable !== isUTC) {
        const inputs = document.querySelectorAll('input[type="time"]');
        inputs.forEach(input => {
            if (!input.value) return;
            let [hh, mm] = input.value.split(':').map(Number);
            let newH = enable ? hh - offsetHours : hh + offsetHours;
            let totalMin = Math.round(newH * 60 + mm);
            totalMin = ((totalMin % 1440) + 1440) % 1440;
            const outH = Math.floor(totalMin / 60);
            const outM = totalMin % 60;
            input.value = `${String(outH).padStart(2, '0')}:${String(outM).padStart(2, '0')}`;
        });
    }
    isUTC = enable;
    document.getElementById('utcToggle').checked = enable;
    localStorage.setItem('modeUTC', enable ? '1' : '0');
    updateAllCalculations();
}

/* Compat anciens appels */
function toggleDarkMode(){ setDarkMode(!document.body.classList.contains('dark')); }
function toggleTimeMode(){ setTimeModeUTC(!isUTC); }

/* === POPUP === */
function showPopup(message, color = "#2196f3", duration = 2000) {
    const popup = document.createElement('div');
    popup.textContent = message;
    popup.style.position = "fixed";
    popup.style.top = "60px";
    popup.style.left = "50%";
    popup.style.transform = "translateX(-50%)";
    popup.style.background = color;
    popup.style.color = "#fff";
    popup.style.padding = "10px 20px";
    popup.style.borderRadius = "6px";
    popup.style.fontSize = "1rem";
    popup.style.zIndex = "1000";
    document.body.appendChild(popup);
    setTimeout(() => popup.remove(), duration);
}

/* === TIMELINE helpers (5-min grid, jalons auto) === */
let showTimeLabels = true;           // coche "Heure sur √©tiquettes"
let timelineUserScrolled = false;    // pour ne centrer qu'√† l'ouverture

function parseHHMM(str){
  if(!str || !/^\d{2}:\d{2}$/.test(str)) return null;
  const [h,m] = str.split(':').map(Number);
  return h*60 + m;
}
function fmtHHMM(mins){
  mins = ((mins % 1440) + 1440) % 1440;
  const h = Math.floor(mins/60), m = mins%60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
}
function labelFromInputEl(input){
  const lab = input.closest('label');
  if(lab){
    const firstTextNode = Array.from(lab.childNodes).find(n=>n.nodeType===3);
    const t = (firstTextNode?.textContent || "").trim();
    if(t) return t.replace(/\s*[:Ôºö]?\s*$/,'');
  }
  return input.id || 'Horaire';
}

/* Fen√™tre d‚Äôaffichage :
   1) [H-15 - 5 min, AOBT + 5 min] si H-15 et AOBT dispo
   2) [SIBT - 5 min, SOBT + 5 min] si dispo
   3) fallback min/max des donn√©es (+ marges)
*/
function computeTimelineWindow(allTimes){
  const h15  = parseHHMM((document.getElementById('timer-h15')?.textContent || '').replace('--:--',''));
  const aobt = parseHHMM(document.getElementById('AOBT')?.value || '');
  if(h15 != null && aobt != null){
    let min = h15 - 5;
    let max = aobt + 5;
    if (max - min < 30) { min -= 10; max += 10; }
    return {min, max, basis:'H-15/AOBT'};
  }
  const sibt = parseHHMM(document.getElementById('SIBT')?.value || '');
  const sobt = parseHHMM(document.getElementById('SOBT')?.value || '');
  if(sibt != null && sobt != null){
    let min = sibt - 5;
    let max = sobt + 5;
    if (max - min < 30) { min -= 10; max += 10; }
    return {min, max, basis:'SIBT/SOBT'};
  }
  if(allTimes.length){
    let min = Math.min(...allTimes) - 10;
    let max = Math.max(...allTimes) + 10;
    if (max - min < 30){ min -= 10; max += 10; }
    return {min, max, basis:'data'};
  }
  return {min:0, max:60, basis:'default'};
}

function getPairWindow(idA,idB){
  const a = parseHHMM(document.getElementById(idA)?.value || '');
  const b = parseHHMM(document.getElementById(idB)?.value || '');
  if(a==null || b==null) return null;
  return [Math.min(a,b), Math.max(a,b)];
}

function collectTimelineData(){
  // Points fixes (√©v√©nements)
  const fixedPoints = [];
  const addPoint = (label, t, cls='tl--std')=>{
    if(t==null) return;
    fixedPoints.push({label, t, cls});
  };

  const SIBT = parseHHMM(document.getElementById('SIBT')?.value || '');
  const AIBT = parseHHMM(document.getElementById('AIBT')?.value || '');
  const SOBT = parseHHMM(document.getElementById('SOBT')?.value || '');
  const AOBT = parseHHMM(document.getElementById('AOBT')?.value || '');
  const TOBT = parseHHMM((document.getElementById('timer-tobt')?.textContent || '').replace('--:--',''));
  const CTOT = parseHHMM((document.getElementById('timer-ctot')?.textContent || '').replace('--:--',''));
  const H15  = parseHHMM((document.getElementById('timer-h15')?.textContent || '').replace('--:--',''));
  const H40  = parseHHMM((document.getElementById('timer-h40')?.textContent || '').replace('--:--',''));

  addPoint('SIBT', SIBT, 'tl--std');
  addPoint('AIBT', AIBT, 'tl--std');
  addPoint('SOBT', SOBT, 'tl--std');
  addPoint('AOBT', AOBT, 'tl--std');
  addPoint('TOBT', TOBT, 'tl--tobt');
  addPoint('CTOT', CTOT, 'tl--ctot');
  addPoint('H-15', H15,  'tl--turn');  // point H-15
  addPoint('H-40', H40,  'tl--turn');  // point H-40

  // √âv√©nements unitaires (points)
  const singles = [
    ['ArrPNT','Arriv√©e PNT avion'],
    ['ArrPNC','Arriv√©e PNC avion'],
    ['RemiseLID','Remise LID/LDS'],
    ['FermeturePorteAvion','Fermeture porte avion'],
  ];
  singles.forEach(([id,label])=>{
    const t = parseHHMM(document.getElementById(id)?.value || '');
    if(t!=null) fixedPoints.push({label, t, cls:'tl--std'});
  });

  // Lignes de dur√©es (barres) ‚Äî non superpos√©es, une par rang√©e
  const rows = [
    {key:'debarq', label:'D√©barquement',       pair:getPairWindow('PremierDebarque','DernierDebarque'),           cls:'tl--turn', color:null},        // rouge
    {key:'emb',    label:'Embarquement',       pair:getPairWindow('AvionPremierEmbarque','AvionDernierEmbarque'), cls:'tl--ops',  color:null},        // bleu
    {key:'porte',  label:'Embarquement porte', pair:getPairWindow('PortePremierEmbarque','PorteDernierEmbarque'), cls:'tl--std',  color:null},        // gris std
    {key:'fuel',   label:'Fuel',               pair:getPairWindow('ArriveeFuel','DepartFuel'),                     cls:'tl--std',  color:'#ff9800'},   // orange
    {key:'lift',   label:'Lift',               pair:getPairWindow('ArriveeLift','DepartLift'),                     cls:'tl--std',  color:'#2e7d32'},   // vert
    // ‚Äî‚Äî‚Äî‚Äî‚Äî Ajout : Recherche bagage ‚Äî‚Äî‚Äî‚Äî‚Äî
    {key:'bag',    label:'Recherche bagage',   pair:getPairWindow('RechercheBagageStart','RechercheBagageEnd'),   cls:'tl--std',  color:'#9c27b0'},   // violet
  ];

  const durations = rows
    .filter(r=>r.pair!=null)
    .map((r,idx)=>({rowIndex: idx, label:r.label, a:r.pair[0], b:r.pair[1], cls:r.cls, color:r.color}));

  const allTimes = [
    ...fixedPoints.map(p=>p.t),
    ...durations.flatMap(d=>[d.a,d.b])
  ];
  const windowInfo = computeTimelineWindow(allTimes);

  return {fixedPoints, durations, windowInfo};
}

function renderTimeline(){
  const scroller = document.getElementById('timelineScroll');
  const canvas   = document.getElementById('timelineCanvas');
  if(!scroller || !canvas) return;

  canvas.innerHTML = '';

  const {fixedPoints, durations, windowInfo} = collectTimelineData();
  const {min, max} = windowInfo;
  if(min === undefined) return;

  window._timelineCurrentRange = {min, max};
  canvas.style.width = `${100 * timelineZoom}%`;
  const total = Math.max(1, max - min);

  // Grille
  for(let t = Math.ceil(min); t <= Math.floor(max); t++){
    const x = (t-min)/total;
    const leftPct = 6 + x*88;

    const vline = document.createElement('div');
    vline.style.position = 'absolute';
    vline.style.left = `${leftPct}%`;
    vline.style.top = '12%';
    vline.style.height = '78%';
    vline.style.width = (t % 5 === 0) ? '1.5px' : '1px';
    vline.style.background = (t % 5 === 0) ? '#bdbdbd' : 'rgba(0,0,0,0.08)';
    canvas.appendChild(vline);

    if(t % 5 === 0){
      const lbl = document.createElement('div');
      lbl.className = 'timeline-tick-label';
      lbl.textContent = fmtHHMM(t);
      lbl.style.left = `${leftPct}%`;
      lbl.style.top = 'calc(100% - 18px)';
      canvas.appendChild(lbl);
    }
  }

  // Barres
  const rowTops = [56, 66, 76, 86, 96];
  durations.forEach(d=>{
    const leftStartPct  = 6 + ((d.a-min)/total)*88;
    const widthPct      = ((d.b-d.a)/total)*88;

    const bar = document.createElement('div');
    bar.className = `tl-range ${d.cls}`;
    bar.style.left = `${leftStartPct}%`;
    bar.style.width = `${widthPct}%`;
    bar.style.top = `${rowTops[d.rowIndex]}%`;
    bar.style.transform = 'translateY(-50%)';
    if(d.color){ bar.style.setProperty('--c', d.color); }
    canvas.appendChild(bar);

    const lab = document.createElement('div');
    lab.className = 'tl-range-label';
    lab.textContent = showTimeLabels ? `${d.label} : ${fmtHHMM(d.a)}-${fmtHHMM(d.b)}` : d.label;
    bar.appendChild(lab);
  });

  // Points
  fixedPoints.sort((a,b)=>a.t-b.t).forEach(p=>{
    const leftPct = 6 + ((p.t-min)/total)*88;
    const el = document.createElement('div');
    el.className = `tl-event ${p.cls}`;
    el.style.left = `${leftPct}%`;
    el.style.top  = '28%';
    const dot = document.createElement('div'); dot.className = 'tl-dot';
    const label = document.createElement('div'); label.className='tl-label';
    label.textContent = showTimeLabels ? `${p.label} : ${fmtHHMM(p.t)}` : p.label;
    el.appendChild(dot); el.appendChild(label);
    canvas.appendChild(el);
  });

  if(!timelineUserScrolled){
    const aibt = parseHHMM(document.getElementById('AIBT')?.value || '');
    const aobt = parseHHMM(document.getElementById('AOBT')?.value || '');
    const sibt = parseHHMM(document.getElementById('SIBT')?.value || '');
    const sobt = parseHHMM(document.getElementById('SOBT')?.value || '');
    let start = null, end = null;

    if(aibt != null && aobt != null){ start = aibt; end = aobt; }
    else if(sibt != null && aobt != null){ start = sibt; end = aobt; }
    else if(sibt != null && sobt != null){ start = sibt; end = sobt; }

    if(start != null && end != null){
      const mid = (start + end) / 2;
      const midX = (mid - min) / total;
      const centerLeft = midX * scroller.scrollWidth - scroller.clientWidth / 2;
      scroller.scrollLeft = Math.max(0, centerLeft);
    }
  }
}

/* Injecte la coche "Heure sur √©tiquettes" si absente + capte l'interaction pour ne pas recentrer */
(function injectShowHoursToggle(){
  const bar = document.querySelector('.timeline-toolbar');
  if (bar) {
    if (!document.getElementById('showTimesToggle')) {
      const wrap = document.createElement('label');
      wrap.style.display = 'inline-flex';
      wrap.style.alignItems = 'center';
      wrap.style.gap = '6px';
      wrap.style.marginLeft = '8px';
      wrap.style.whiteSpace = 'nowrap';

      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.id = 'showTimesToggle';
      cb.checked = true;
      showTimeLabels = true;

      cb.addEventListener('change', () => {
        showTimeLabels = cb.checked;
        renderTimeline();
      });

      const span = document.createElement('span');
      span.textContent = 'Heure sur √©tiquettes';

      wrap.appendChild(cb);
      wrap.appendChild(span);
      bar.appendChild(wrap);
    } else {
      const cb = document.getElementById('showTimesToggle');
      cb.checked = true;
      showTimeLabels = true;
      const wrap = cb.closest('label');
      if (wrap) {
        wrap.style.whiteSpace = 'nowrap';
        wrap.style.display = 'inline-flex';
        wrap.style.alignItems = 'center';
        wrap.style.gap = '6px';
        wrap.style.marginLeft = '8px';
      }
    }
  }

  const scroller = document.getElementById('timelineScroll');
  if (scroller) {
    ['wheel','mousedown','touchstart','keydown','scroll'].forEach(ev=>{
      scroller.addEventListener(ev, () => { timelineUserScrolled = true; }, {passive:true});
    });
  }
})();

/* === VALIDATION (Sans Airtable) === */
function validateForm() {
  const required = ['Date', 'Cie', 'Parking', 'NVol', 'From', 'To', 'Immat', 'RZA'];
  let missing = required.some(id => !document.getElementById(id).value);

  if (missing) {
      showPopup("V√©rifiez les informations manquantes !", "#d32f2f", 4000);
  } else {
      showPopup("Validation locale effectu√©e (pas d'envoi).", "#4caf50", 2500);
  }
}

/* === SAUVEGARDE MANUELLE === */
function manualSave() {
  saveCurrentTabData();
  showPopup("Enregistrement r√©ussi", "#2196f3", 2000);
}

/* === RESET === */
function clearAutoSave() {
  if (confirm("Tout r√©initialiser ?")) {
      localStorage.clear();
      location.reload();
  }
}

/* ==========================================================
   ==  AJOUTS : RECHERCHE BAGAGE (UI + logique + sauvegarde)
   ========================================================== */

/* Cr√©e le bouton/toggle et les champs associ√©s si absents */
function setupRechercheBagageUI(forceRefresh=false){
  const timingSection = Array.from(document.querySelectorAll('section'))
    .find(sec => sec.querySelector('h2')?.textContent?.trim().toUpperCase()==='TIMING');
  if(!timingSection) return;
  const grid = timingSection.querySelector('#timing-grid');
  if(!grid) return;

  // Barre de contr√¥le (checkbox) au-dessus de la grille
  let ctrl = timingSection.querySelector('#rb-controls');
  if(!ctrl){
    ctrl = document.createElement('div');
    ctrl.id = 'rb-controls';
    ctrl.style.display = 'flex';
    ctrl.style.alignItems = 'center';
    ctrl.style.gap = '10px';
    ctrl.style.margin = '8px 4px 12px';
    ctrl.innerHTML = `
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
        <input type="checkbox" id="RechercheBagage" />
        <span>Recherche bagage</span>
      </label>
    `;
    timingSection.insertBefore(ctrl, grid);
  }

  // Si d√©j√† pr√©sents et pas de refresh forc√©, on sort
  if(!forceRefresh && document.getElementById('RechercheBagageStart')) return;

  // Supprimer anciens widgets (si refresh)
  ['rb-start-wrap','rb-end-wrap','rb-nb-wrap'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.remove();
  });

  const addTimingField = (wrapId, inputId, labelTxt) => {
    const div=document.createElement('div');
    div.className='form-group';
    div.id = wrapId;
    div.innerHTML = `
      <label>${labelTxt}<input type="time" id="${inputId}" onchange="updateAllCalculations()"></label>
      <div class="btn-actions">
          <button class="action minus" onclick="adjustTime('${inputId}',-1);updateAllCalculations()">-1</button>
          <button class="action now"   onclick="setNow('${inputId}');updateAllCalculations()">Now</button>
          <button class="action plus"  onclick="adjustTime('${inputId}',1);updateAllCalculations()">+1</button>
      </div>`;
    grid.appendChild(div);
  };

  // Ajoute les trois champs mais masqu√©s par d√©faut
  addTimingField('rb-start-wrap','RechercheBagageStart','Lancement recherche bagage');
  addTimingField('rb-end-wrap','RechercheBagageEnd','Fin de recherche bagage');

  const nbDiv = document.createElement('div');
  nbDiv.className = 'form-group';
  nbDiv.id = 'rb-nb-wrap';
  nbDiv.innerHTML = `
    <label>Nombre de bagage(s) d√©charg√©(s)
      <input type="number" id="NbBagagesDecharges" min="0" step="1" oninput="sanitizePositiveInt(this)">
    </label>`;
  grid.appendChild(nbDiv);

  // Gestion d'affichage selon la checkbox
  const check = document.getElementById('RechercheBagage');
  const syncVisibility = ()=>{
    const show = check.checked;
    ['rb-start-wrap','rb-end-wrap','rb-nb-wrap'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.style.display = show ? '' : 'none';
    });
    updateAllCalculations();
  };

  check.addEventListener('change', ()=>{
    saveCurrentTabData();
    syncVisibility();
  });

  // Restaure √©tat depuis stockage de l‚Äôonglet courant (si pr√©sent)
  const tabData = currentTabId ? JSON.parse(localStorage.getItem('tab-'+currentTabId)||'{}') : {};
  if(tabData.RechercheBagage==='1'){ check.checked = true; }
  if(typeof tabData.RechercheBagageStart === 'string') document.getElementById('RechercheBagageStart').value = tabData.RechercheBagageStart;
  if(typeof tabData.RechercheBagageEnd   === 'string') document.getElementById('RechercheBagageEnd').value   = tabData.RechercheBagageEnd;
  if(typeof tabData.NbBagagesDecharges   === 'string') document.getElementById('NbBagagesDecharges').value   = tabData.NbBagagesDecharges;

  syncVisibility();
}

/* Assure la pr√©sence/MAJ apr√®s changement d‚Äôonglet */
(function hookSwitchTabForRB(){
  const oldSwitch = window.switchTab;
  if(typeof oldSwitch === 'function'){
    window.switchTab = function(id){
      oldSwitch.call(window,id);
      setupRechercheBagageUI(true);
      refreshNotePadForTab();   // aussi pour le bloc-note (voir plus bas)
    };
  }
})();

/* ==========================================================
   ==  AJOUTS : BLOC-NOTE FLOTTANT (stylet) + autosauvegarde
   ========================================================== */

function setupFloatingNote(){
  if(document.getElementById('noteFab')) return;

  // Bouton flottant (ic√¥ne type bloc-note)
  const fab = document.createElement('button');
  fab.id = 'noteFab';
  fab.title = 'Bloc-note';
  Object.assign(fab.style, {
    position:'fixed', right:'18px', bottom:'18px',
    width:'60px', height:'60px', borderRadius:'16px',
    border:'0', cursor:'pointer', zIndex:'1001',
    background:'rgba(255,255,255,0.85)', boxShadow:'0 6px 18px rgba(0,0,0,.2)',
    backdropFilter:'blur(6px)', overflow:'hidden'
  });
  // Petite ic√¥ne CSS (bande jaune + pointill√©s) pour rappeler Notes
  fab.innerHTML = `
    <div style="position:absolute;inset:0;border-radius:16px;">
      <div style="height:34%; background:linear-gradient(#ffd54f,#ffc107); border-top-left-radius:16px;border-top-right-radius:16px;"></div>
      <div style="height:66%; background:#fff; border-bottom-left-radius:16px;border-bottom-right-radius:16px; position:relative;">
        <div style="position:absolute;top:6px;left:8px;right:8px;height:0;border-top:2px dotted #c7c7c7;"></div>
        <div style="position:absolute;bottom:8px;left:12px;right:12px;height:2px;background:#e0e0e0;"></div>
        <div style="position:absolute;bottom:18px;left:12px;right:12px;height:2px;background:#e0e0e0;"></div>
      </div>
    </div>
  `;

  document.body.appendChild(fab);

  // Panneau
  const panel = document.createElement('div');
  panel.id = 'notePanel';
  Object.assign(panel.style, {
    position:'fixed', right:'18px', bottom:'90px',
    width:'420px', height:'320px', zIndex:'1002',
    background:'#fff', color:'#111', borderRadius:'12px',
    boxShadow:'0 12px 28px rgba(0,0,0,.25)', display:'none', overflow:'hidden'
  });
  panel.innerHTML = `
    <div id="noteHeader" style="display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:#f6f6f6;border-bottom:1px solid #e0e0e0;">
      <div style="display:flex;gap:8px;align-items:center;">
        <button id="notePenBtn"   style="padding:6px 10px;border:0;border-radius:8px;background:#1976d2;color:#fff;font-weight:600;cursor:pointer;">Stylo</button>
        <button id="noteEraseBtn" style="padding:6px 10px;border:0;border-radius:8px;background:#555;color:#fff;font-weight:600;cursor:pointer;">Gomme</button>
        <button id="noteClearBtn" style="padding:6px 10px;border:0;border-radius:8px;background:#d32f2f;color:#fff;font-weight:600;cursor:pointer;">Tout effacer</button>
      </div>
      <button id="noteCloseBtn"  style="padding:6px 10px;border:0;border-radius:8px;background:#9e9e9e;color:#fff;font-weight:600;cursor:pointer;">‚úï</button>
    </div>
    <canvas id="noteCanvas" width="420" height="280" style="touch-action:none; display:block;"></canvas>
  `;
  document.body.appendChild(panel);

  // Gestion ouverture/fermeture
  const openClose = ()=>{ panel.style.display = (panel.style.display==='none' ? 'block' : 'none'); };
  fab.addEventListener('click', openClose);
  panel.querySelector('#noteCloseBtn').addEventListener('click', openClose);

  // Dessin
  const canvas = panel.querySelector('#noteCanvas');
  const ctx = canvas.getContext('2d');
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  ctx.strokeStyle = '#111';
  ctx.lineWidth = 2;

  let drawing = false;
  let eraseMode = false;

  function setErase(on){
    eraseMode = on;
    if(on){
      ctx.globalCompositeOperation = 'destination-out';
      panel.querySelector('#noteEraseBtn').style.background = '#1976d2';
      panel.querySelector('#notePenBtn').style.background   = '#555';
    }else{
      ctx.globalCompositeOperation = 'source-over';
      panel.querySelector('#noteEraseBtn').style.background = '#555';
      panel.querySelector('#notePenBtn').style.background   = '#1976d2';
    }
  }

  panel.querySelector('#notePenBtn').addEventListener('click', ()=>setErase(false));
  panel.querySelector('#noteEraseBtn').addEventListener('click', ()=>setErase(true));
  panel.querySelector('#noteClearBtn').addEventListener('click', ()=>{
    ctx.clearRect(0,0,canvas.width,canvas.height);
    saveNoteCanvas(); // on sauvegarde un canevas vide
  });

  function pos(e){
    const r = canvas.getBoundingClientRect();
    if(e.touches && e.touches[0]) e = e.touches[0];
    return { x: (e.clientX - r.left) * (canvas.width/r.width),
             y: (e.clientY - r.top ) * (canvas.height/r.height) };
  }

  function start(e){
    drawing = true;
    const p = pos(e);
    ctx.beginPath(); ctx.moveTo(p.x, p.y);
    e.preventDefault();
  }
  function move(e){
    if(!drawing) return;
    const p = pos(e);
    // largeur avec pression stylet si dispo
    const w = (e.pressure && e.pressure>0) ? (eraseMode ? 20*e.pressure : 4*e.pressure) : (eraseMode?12:2);
    ctx.lineWidth = w;
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    e.preventDefault();
  }
  function end(){
    if(!drawing) return;
    drawing = false;
    saveNoteCanvas(); // autosauvegarde √† chaque trait termin√©
  }

  // Pointeurs
  canvas.addEventListener('pointerdown', start);
  canvas.addEventListener('pointermove', move);
  canvas.addEventListener('pointerup',   end);
  canvas.addEventListener('pointerleave',end);
  // Compat tactile anciens
  canvas.addEventListener('mousedown', start);
  canvas.addEventListener('mousemove', move);
  canvas.addEventListener('mouseup',   end);
  canvas.addEventListener('mouseleave',end);
  canvas.addEventListener('touchstart', start, {passive:false});
  canvas.addEventListener('touchmove',  move,  {passive:false});
  canvas.addEventListener('touchend',   end);

  // Sauvegarde/Chargement li√©s √† l‚Äôonglet courant
  function noteKey(){ return currentTabId ? `tab-${currentTabId}-noteImage` : 'noteImage'; }

  function saveNoteCanvas(){
    try{
      const url = canvas.toDataURL('image/png');
      localStorage.setItem(noteKey(), url);
    }catch(e){ /* quota */ }
  }
  function loadNoteCanvas(){
    const url = localStorage.getItem(noteKey());
    if(!url) { ctx.clearRect(0,0,canvas.width,canvas.height); return; }
    const img = new Image();
    img.onload = ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0); };
    img.src = url;
  }

  // Expose pour rafra√Æchir apr√®s switch d‚Äôonglet
  window.refreshNotePadForTab = loadNoteCanvas;

  // Charge l‚Äôimage du bloc-note pour l‚Äôonglet courant
  loadNoteCanvas();
}

/* Appelle les setups apr√®s chargement total (initForm d√©j√† ex√©cut√© via onload) */
window.addEventListener('load', ()=>{
  setupRechercheBagageUI();
  setupFloatingNote();
});

</script>
</body>
</html>
